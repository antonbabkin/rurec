---

title: Validate geo variables in InfoGroup


keywords: fastai
sidebar: home_sidebar

summary: "Test for consistency across different spatial variables and correct errors when possible."
description: "Test for consistency across different spatial variables and correct errors when possible."
nb_path: "nbs/infogroup_validate_geo.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/infogroup_validate_geo.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Needs revision and integration in overall workflow.</span>

<span class="k">def</span> <span class="nf">extract_and_correct</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">yr</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">yr</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
    <span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;/InfoGroup/data/original/&#39;</span>
    <span class="n">xdir</span> <span class="o">=</span> <span class="s1">&#39;/tmp/xtrcts/&#39;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">yr</span><span class="si">}</span><span class="s1">_Business_Academic_QCQ_utf-8&#39;</span>
    <span class="c1"># Extract the annual file from the zip archive</span>
    <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}{</span><span class="n">fname</span><span class="si">}</span><span class="s1">.zip&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myzip</span><span class="p">:</span>
        <span class="n">myzip</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xdir</span><span class="si">}{</span><span class="n">fname</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    
    <span class="c1"># Delete the temp file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xdir</span><span class="si">}{</span><span class="n">fname</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>  
    
    <span class="c1"># Add &#39;State Code&#39; column, the 2-digit FIPS code</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;State Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">state_fips</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
    <span class="c1"># Correct and overwrite the state FIPS code.</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;State Code&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;County Code&#39;</span><span class="p">]</span>
    
    <span class="c1"># Add Full Census Tract column, the 11-digit census tract identifying</span>
    <span class="c1"># a tract uniquely nationwide. The &#39;Census Tract&#39; variable in InfoGroup</span>
    <span class="c1"># is the 6-digit code that identifies a tract only within a county.</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Full Census Tract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Census Tract&#39;</span><span class="p">]</span>
    <span class="c1"># zero-fill the ZipCode value</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ZipCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ZipCode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">CBSA_partition</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>    
    <span class="n">urban</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="n">rural</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>
    <span class="n">unknown</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">sum_of_parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">urban</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">rural</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sum_of_parts</span> <span class="o">!=</span> <span class="n">nrows</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in dividing enterprises into categories:&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">nrows</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">sum_of_parts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        
    <span class="n">corrected</span> <span class="o">=</span> <span class="n">extract_corrections</span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
    <span class="n">corrected</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">corrected</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FIPS Code_l&quot;</span><span class="p">:</span> <span class="s2">&quot;FIPS Code&quot;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span><span class="n">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">corrected</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]),</span><span class="n">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">urban</span><span class="p">,</span> <span class="n">rural</span><span class="p">,</span> <span class="n">corrected</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_corrections</span><span class="p">(</span><span class="n">unknowns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extracts CBSA Code and appropriate CBSA Level for a list of InfoGroup FIPS Codes&quot;&quot;&quot;</span>
    <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">unk</span> <span class="o">=</span> <span class="n">unknowns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cbsa_df</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span> 
    <span class="n">unk</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unk</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Metropolitan&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Micropolitan&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>    
    <span class="k">return</span> <span class="n">unk</span>
    
<span class="k">def</span> <span class="nf">showtime</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">dt_string</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span><span class="s1">&#39;  &#39;</span><span class="p">,</span><span class="n">dt_string</span><span class="p">)</span>	

<span class="c1">## Reference datasets and derived data structures</span>

<span class="c1"># Census relationship file: cross-references CBSA codes and state/county FIPS codes.</span>
<span class="c1"># Variable &#39;STCOU&#39; is the 5-digit state/county FIPS code. The CBSA Level is inferred from the</span>
<span class="c1"># text in the &#39;LSAD&#39; variable.</span>
<span class="n">cbsa_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/InfoGroup/data/rurality/reference/relationships/cbsa-county-relationships-2017.csv&#39;</span><span class="p">,</span>
                      <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;STCOU&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>   
<span class="n">cbsa_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;STCOU&#39;</span><span class="p">:</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cbsa_df</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbsa_df</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1">## Main</span>

<span class="c1"># Open a log file.</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/InfoGroup/data/rurality/logs/step1.log&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

<span class="c1">#for yr in range(1997,2018):</span>
<span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span><span class="mi">2018</span><span class="p">):</span>
    <span class="n">showtime</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">extract_and_correct</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>
    <span class="n">showtime</span><span class="p">(</span><span class="s1">&#39;extract_and_correct&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">urban</span><span class="p">,</span><span class="n">rural</span><span class="p">,</span><span class="n">corrected</span><span class="p">)</span> <span class="o">=</span> <span class="n">CBSA_partition</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">showtime</span><span class="p">(</span><span class="s1">&#39;CBSA_partition&#39;</span><span class="p">)</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">urban</span><span class="p">,</span><span class="n">rural</span><span class="p">,</span><span class="n">corrected</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">showtime</span><span class="p">(</span><span class="s1">&#39;inline concat&#39;</span><span class="p">)</span>
    <span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/InfoGroup/data/rurality/step1_</span><span class="si">{</span><span class="n">yr</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">showtime</span><span class="p">(</span><span class="s1">&#39;finished&#39;</span><span class="p">)</span>

<span class="n">logfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Validation-of-geographic-variables">Validation of geographic variables<a class="anchor-link" href="#Validation-of-geographic-variables"> </a></h1><p>Geographic variables</p>
<ul>
<li>ADDRESS: historical address</li>
<li>CITY: historical address city</li>
<li>STATE: historical address state</li>
<li>ZIP: historical address zip code</li>
<li>ZIP4: historical address zip code zip + 4</li>
<li>COUNTY_CODE: county code based upon location address/zip4 (postal)</li>
<li>AREA_CODE: area code of business</li>
<li>ADDRESS_TYPE: indicates if type of address. "F": "Firm", "G": "General delivery", "H": "High-rise", "M": "Military", "P": "Post office box", "R": "Rural route or hwy contract", "S": "Street", "N": "Unknown", "": "No match to Zip4".</li>
<li>CENSUS_TRACT: identifies a small geographic area for the purpose of collecting and compiling population and housing data.  census tracts are unique only within census county, and census counties are unique only within census state.  </li>
<li>CENSUS_BLOCK: bgs are subdivisions of census tracts and unique only within a specific census tract.  census tracts/block groups are assigned to address records via a geocoding process.</li>
<li>LATITUDE: parcel level assigned via point geo coding.  half of a pair of coordinates (the other being longitude)  provided in a formatted value, with decimals or a negative sign. not available in puerto rico &amp; virgin island.</li>
<li>LONGITUDE: parcel level assigned via point geo coding.  note: longitudes are negatives values in the western hemisphere.  provided in its formatted value, with decimals or a negative sign. not available in puerto rico &amp; virigin island</li>
<li>MATCH_CODE: parcel level match code of the business location. "0": "Site level", "2": "Zip+2 centroid", "4": "Zip+4 centroid", "P": "Parcel", "X": "Zip centroid".</li>
<li>CBSA_CODE: core bases statistical area (expanded msa code)</li>
<li>CBSA_LEVEL: indicates if an area is a micropolitan or metropolitan area. "1": "Micropolitan", "2": "Metropolitan"</li>
<li>CSA_CODE: adjoining cbsa's.  combination of metro and micro areas</li>
<li>FIPS_CODE: first 2 bytes = state code, last 3 bytes = county code (location)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ADDRESS&#39;</span><span class="p">,</span> <span class="s1">&#39;CITY&#39;</span><span class="p">,</span> <span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="s1">&#39;ZIP&#39;</span><span class="p">,</span> <span class="s1">&#39;ZIP4&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTY_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;AREA_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;ADDRESS_TYPE&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;CENSUS_TRACT&#39;</span><span class="p">,</span> <span class="s1">&#39;CENSUS_BLOCK&#39;</span><span class="p">,</span> <span class="s1">&#39;LATITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;LONGITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;MATCH_CODE&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;CBSA_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;CBSA_LEVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;CSA_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;FIPS_CODE&#39;</span><span class="p">]</span>
<span class="n">total_count</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">isna_count</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">other_count</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1997</span><span class="p">,</span> <span class="mi">2018</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">get_df</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">geo_cols</span><span class="p">)</span>

    <span class="n">total_count</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">isna_count</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">geo_cols</span><span class="p">:</span>
        <span class="n">isna_count</span><span class="p">[</span><span class="n">year</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">other_count</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">other_count</span><span class="p">[</span><span class="n">year</span><span class="p">][</span><span class="s1">&#39;ADDRESS_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ADDRESS_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">other_count</span><span class="p">[</span><span class="n">year</span><span class="p">][</span><span class="s1">&#39;CENSUS_TRACT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CENSUS_TRACT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;000000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># is 000000 a valid tract id?</span>
    <span class="n">other_count</span><span class="p">[</span><span class="n">year</span><span class="p">][</span><span class="s1">&#39;CENSUS_BLOCK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CENSUS_BLOCK&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># is 0 a valid block id?</span>
    <span class="n">other_count</span><span class="p">[</span><span class="n">year</span><span class="p">][</span><span class="s1">&#39;CBSA_CODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA_CODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;00000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">other_count</span><span class="p">[</span><span class="n">year</span><span class="p">][</span><span class="s1">&#39;CSA_CODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CSA_CODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="STATE,-COUNTY_CODE-and-FIPS_CODE">STATE, COUNTY_CODE and FIPS_CODE<a class="anchor-link" href="#STATE,-COUNTY_CODE-and-FIPS_CODE"> </a></h2><ul>
<li>STATE is never missing</li>
<li>Tiny fraction (0.0001%) have missing COUNTY_CODE or FIPS_CODE</li>
<li>Until 2012, about 2% have inconsistent codes, and only a few after that<ul>
<li>Can correct using either STATE or state part of FIPS_CODE as truth</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">state_fips_map</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;AL&#39;</span><span class="p">:</span><span class="s1">&#39;01&#39;</span><span class="p">,</span>
<span class="s1">&#39;AK&#39;</span><span class="p">:</span><span class="s1">&#39;02&#39;</span><span class="p">,</span>
<span class="s1">&#39;AS&#39;</span><span class="p">:</span><span class="s1">&#39;60&#39;</span><span class="p">,</span>
<span class="s1">&#39;AZ&#39;</span><span class="p">:</span><span class="s1">&#39;04&#39;</span><span class="p">,</span>
<span class="s1">&#39;AR&#39;</span><span class="p">:</span><span class="s1">&#39;05&#39;</span><span class="p">,</span>
<span class="s1">&#39;CA&#39;</span><span class="p">:</span><span class="s1">&#39;06&#39;</span><span class="p">,</span>
<span class="s1">&#39;CO&#39;</span><span class="p">:</span><span class="s1">&#39;08&#39;</span><span class="p">,</span>
<span class="s1">&#39;CT&#39;</span><span class="p">:</span><span class="s1">&#39;09&#39;</span><span class="p">,</span>
<span class="s1">&#39;DE&#39;</span><span class="p">:</span><span class="s1">&#39;10&#39;</span><span class="p">,</span>
<span class="s1">&#39;DC&#39;</span><span class="p">:</span><span class="s1">&#39;11&#39;</span><span class="p">,</span>
<span class="s1">&#39;FL&#39;</span><span class="p">:</span><span class="s1">&#39;12&#39;</span><span class="p">,</span>
<span class="s1">&#39;FM&#39;</span><span class="p">:</span><span class="s1">&#39;64&#39;</span><span class="p">,</span>
<span class="s1">&#39;GA&#39;</span><span class="p">:</span><span class="s1">&#39;13&#39;</span><span class="p">,</span>
<span class="s1">&#39;GU&#39;</span><span class="p">:</span><span class="s1">&#39;66&#39;</span><span class="p">,</span>
<span class="s1">&#39;HI&#39;</span><span class="p">:</span><span class="s1">&#39;15&#39;</span><span class="p">,</span>
<span class="s1">&#39;ID&#39;</span><span class="p">:</span><span class="s1">&#39;16&#39;</span><span class="p">,</span>
<span class="s1">&#39;IL&#39;</span><span class="p">:</span><span class="s1">&#39;17&#39;</span><span class="p">,</span>
<span class="s1">&#39;IN&#39;</span><span class="p">:</span><span class="s1">&#39;18&#39;</span><span class="p">,</span>
<span class="s1">&#39;IA&#39;</span><span class="p">:</span><span class="s1">&#39;19&#39;</span><span class="p">,</span>
<span class="s1">&#39;KS&#39;</span><span class="p">:</span><span class="s1">&#39;20&#39;</span><span class="p">,</span>
<span class="s1">&#39;KY&#39;</span><span class="p">:</span><span class="s1">&#39;21&#39;</span><span class="p">,</span>
<span class="s1">&#39;LA&#39;</span><span class="p">:</span><span class="s1">&#39;22&#39;</span><span class="p">,</span>
<span class="s1">&#39;ME&#39;</span><span class="p">:</span><span class="s1">&#39;23&#39;</span><span class="p">,</span>
<span class="s1">&#39;MH&#39;</span><span class="p">:</span><span class="s1">&#39;68&#39;</span><span class="p">,</span>
<span class="s1">&#39;MD&#39;</span><span class="p">:</span><span class="s1">&#39;24&#39;</span><span class="p">,</span>
<span class="s1">&#39;MA&#39;</span><span class="p">:</span><span class="s1">&#39;25&#39;</span><span class="p">,</span>
<span class="s1">&#39;MI&#39;</span><span class="p">:</span><span class="s1">&#39;26&#39;</span><span class="p">,</span>
<span class="s1">&#39;MN&#39;</span><span class="p">:</span><span class="s1">&#39;27&#39;</span><span class="p">,</span>
<span class="s1">&#39;MS&#39;</span><span class="p">:</span><span class="s1">&#39;28&#39;</span><span class="p">,</span>
<span class="s1">&#39;MO&#39;</span><span class="p">:</span><span class="s1">&#39;29&#39;</span><span class="p">,</span>
<span class="s1">&#39;MT&#39;</span><span class="p">:</span><span class="s1">&#39;30&#39;</span><span class="p">,</span>
<span class="s1">&#39;NE&#39;</span><span class="p">:</span><span class="s1">&#39;31&#39;</span><span class="p">,</span>
<span class="s1">&#39;NV&#39;</span><span class="p">:</span><span class="s1">&#39;32&#39;</span><span class="p">,</span>
<span class="s1">&#39;NH&#39;</span><span class="p">:</span><span class="s1">&#39;33&#39;</span><span class="p">,</span>
<span class="s1">&#39;NJ&#39;</span><span class="p">:</span><span class="s1">&#39;34&#39;</span><span class="p">,</span>
<span class="s1">&#39;NM&#39;</span><span class="p">:</span><span class="s1">&#39;35&#39;</span><span class="p">,</span>
<span class="s1">&#39;NY&#39;</span><span class="p">:</span><span class="s1">&#39;36&#39;</span><span class="p">,</span>
<span class="s1">&#39;NC&#39;</span><span class="p">:</span><span class="s1">&#39;37&#39;</span><span class="p">,</span>
<span class="s1">&#39;ND&#39;</span><span class="p">:</span><span class="s1">&#39;38&#39;</span><span class="p">,</span>
<span class="s1">&#39;MP&#39;</span><span class="p">:</span><span class="s1">&#39;69&#39;</span><span class="p">,</span>
<span class="s1">&#39;OH&#39;</span><span class="p">:</span><span class="s1">&#39;39&#39;</span><span class="p">,</span>
<span class="s1">&#39;OK&#39;</span><span class="p">:</span><span class="s1">&#39;40&#39;</span><span class="p">,</span>
<span class="s1">&#39;OR&#39;</span><span class="p">:</span><span class="s1">&#39;41&#39;</span><span class="p">,</span>
<span class="s1">&#39;PW&#39;</span><span class="p">:</span><span class="s1">&#39;70&#39;</span><span class="p">,</span>
<span class="s1">&#39;PA&#39;</span><span class="p">:</span><span class="s1">&#39;42&#39;</span><span class="p">,</span>
<span class="s1">&#39;PR&#39;</span><span class="p">:</span><span class="s1">&#39;72&#39;</span><span class="p">,</span>
<span class="s1">&#39;RI&#39;</span><span class="p">:</span><span class="s1">&#39;44&#39;</span><span class="p">,</span>
<span class="s1">&#39;SC&#39;</span><span class="p">:</span><span class="s1">&#39;45&#39;</span><span class="p">,</span>
<span class="s1">&#39;SD&#39;</span><span class="p">:</span><span class="s1">&#39;46&#39;</span><span class="p">,</span>
<span class="s1">&#39;TN&#39;</span><span class="p">:</span><span class="s1">&#39;47&#39;</span><span class="p">,</span>
<span class="s1">&#39;TX&#39;</span><span class="p">:</span><span class="s1">&#39;48&#39;</span><span class="p">,</span>
<span class="s1">&#39;UM&#39;</span><span class="p">:</span><span class="s1">&#39;74&#39;</span><span class="p">,</span>
<span class="s1">&#39;UT&#39;</span><span class="p">:</span><span class="s1">&#39;49&#39;</span><span class="p">,</span>
<span class="s1">&#39;VT&#39;</span><span class="p">:</span><span class="s1">&#39;50&#39;</span><span class="p">,</span>
<span class="s1">&#39;VA&#39;</span><span class="p">:</span><span class="s1">&#39;51&#39;</span><span class="p">,</span>
<span class="s1">&#39;VI&#39;</span><span class="p">:</span><span class="s1">&#39;78&#39;</span><span class="p">,</span>
<span class="s1">&#39;WA&#39;</span><span class="p">:</span><span class="s1">&#39;53&#39;</span><span class="p">,</span>
<span class="s1">&#39;WV&#39;</span><span class="p">:</span><span class="s1">&#39;54&#39;</span><span class="p">,</span>
<span class="s1">&#39;WI&#39;</span><span class="p">:</span><span class="s1">&#39;55&#39;</span><span class="p">,</span>
<span class="s1">&#39;WY&#39;</span><span class="p">:</span><span class="s1">&#39;56&#39;</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">resources</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">root</span><span class="o">/</span><span class="s1">&#39;tmp/geo_valid.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># logging.basicConfig(stream=sys.stdout, level=logging.INFO, format=&#39;%(message)s&#39;, force=True)</span>
<span class="n">crosstabs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1997</span><span class="p">,</span> <span class="mi">2018</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">get_df</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTY_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;FIPS_CODE&#39;</span><span class="p">])</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;_STATE_CODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">state_fips_map</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">state_isna</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">state_isna</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;STATE is NA&#39;</span>
    <span class="n">county_isna</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;COUNTY_CODE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">county_isna</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;COUNTY_CODE is NA&#39;</span>
    <span class="n">fips_isna</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">FIPS_CODE</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">fips_isna</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FIPS_CODE is NA&#39;</span>
    <span class="n">county_eq_fips</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;COUNTY_CODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FIPS_CODE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">county_eq_fips</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;COUNTY_CODE consistent with FIPS_CODE&#39;</span>
    <span class="n">state_eq_fips</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;_STATE_CODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FIPS_CODE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">state_eq_fips</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;STATE consistent with FIPS_CODE&#39;</span>

    <span class="n">crosstab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">([</span><span class="n">state_isna</span><span class="p">,</span> <span class="n">county_isna</span><span class="p">,</span> <span class="n">fips_isna</span><span class="p">],</span> <span class="p">[</span><span class="n">county_eq_fips</span><span class="p">,</span> <span class="n">state_eq_fips</span><span class="p">])</span>
    <span class="n">crosstabs</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">crosstab</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    ---- </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1"> ----</span>
<span class="s1">    STATE, COUNTY_CODE and FIPS_CODE consistency</span>

<span class="s1">    </span><span class="si">{</span><span class="n">crosstab</span><span class="si">}</span><span class="s1"></span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ct</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">crosstabs</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="p">(</span><span class="n">ct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ct</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ctf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">ctf</span><span class="p">[</span><span class="s1">&#39;Valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
<span class="n">ctf</span><span class="p">[</span><span class="s1">&#39;Missing COUNTY_CODE or FIPS_CODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ct</span><span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ctf</span><span class="p">[</span><span class="s1">&#39;Inconsistent codes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">ctf</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_series_equal</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ctf</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ctf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">ctf</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ctf</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">ctf</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:,}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ctfr</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ctfr</span><span class="p">:</span>
    <span class="n">ctfr</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">ctfr</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span>
<span class="n">ctfr</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.3%}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="CBSA_CODE-and-CBSA_LEVEL">CBSA_CODE and CBSA_LEVEL<a class="anchor-link" href="#CBSA_CODE-and-CBSA_LEVEL"> </a></h2>
</div>
</div>
</div>
</div>
 

