---
title: "MapsIO"
author: "Austin Sandler"
date: "3/8/2022"
format:
  html:
    self-contained: false
    page-layout: full
    code-fold: true
    code-tools: true
    code_download: yes
    latex_engine: pdflatex
---


```{r preamble, include = FALSE}
# When you click the **Render** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

options(scipen=999)

```
::: {.panel-tabset}


### RStartup

<details><summary>Possible Warnings</summary>
```{r packages and libraries}
# Download, Install, and Add R packages as necessary.

# List packages needed for this exercise
packages <- c("dlm",
              "DT",
              "geosphere",
              "knitr",
              "Matrix",
              "spdep",
              "tidyverse",
              "tmap",
              "tmaptools")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages], dependencies = TRUE)
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))

```
</details>



`r paste0("Date: ",  Sys.Date())`

`r kable((.packages()), col.names = "R Packages")`

`r paste0("Project directory: ",  getwd())`

```{r}
## Load previously generated datafiles

load(file = "Data.RData")

```

### WI Test

```{r}
WItest_rural <- grep("^55", colnames(Xpay_mat), value=TRUE) %>%
                grep("55009", ., value=TRUE, invert = TRUE) %>% 
                grep("55025", ., value=TRUE, invert = TRUE) %>% 
                grep("55079", ., value=TRUE, invert = TRUE)

WItest_primary <- c("55009", "55025", "55079", "17031", "27053")
names(WItest_primary) <- WItest_primary

WItest_all <- c(WItest_rural, WItest_primary) %>% as.vector()

```


"Simple Similarity Index": $\Vert \mathbf{Ax^{r}} - \mathbf{x^{s}} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Simple Similarity Index
WISim <- Sim_mat[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Simple Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```

"Relative Similarity Index": $\Vert \mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{s}}(\mathbf{ix^{s}})^{-1} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Relative Similarity Index
WISim <- Sim_mat_rel[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Relative Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```

"Import Similarity Index": $\Vert \max\{\mathbf{Ax^{r}} - \mathbf{x^{r}}, 0\} - \mathbf{x^{s}} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Import Similarity Index
WISim <- Sim_mat_imp[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Import Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```


"*Import Similarity Index - Net Exports": $\Vert \max\{\mathbf{Ax^{r}} - \mathbf{x^{r}}, 0\} - \mathbf{\tilde{x}^{s}} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  *Import Similarity Index - Net Exports
WISim <- Sim_mat_exp[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              *Import Similarity Index - Net Exports",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name))  )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```


"Relative Import Similarity Index": $\Vert \max\{\mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{r}}(\mathbf{ix^{r}})^{-1}, 0\} - \mathbf{x^{s}}(\mathbf{ix^{s}})^{-1} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Relative Import Similarity Index
WISim <- Sim_mat_imp_rel[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Relative Import Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```


"*Relative Import Similarity Index - Net Exports": $\Vert \max\{\mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{r}}(\mathbf{ix^{r}})^{-1}, 0\} - \mathbf{\tilde{x}^{s}}(\mathbf{i\tilde{x}^{s}})^{-1} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  *Relative Import Similarity Index - Net Exports
WISim <- Sim_mat_exp_rel[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              *Relative Import Similarity Index - Net Exports",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```



### WI Test - Spatial

"Geographical Impedance": $Q^{rs} = e^{-d^{rs}} ~ \forall ~ r,s \in l$


```{r}
WItest_rural <- grep("^55", colnames(Xpay_mat), value=TRUE) %>%
                grep("55009", ., value=TRUE, invert = TRUE) %>% 
                grep("55025", ., value=TRUE, invert = TRUE) %>% 
                grep("55079", ., value=TRUE, invert = TRUE)

WItest_primary <- c("55009", "55025", "55079", "17031", "27053")
names(WItest_primary) <- WItest_primary

WItest_all <- c(WItest_rural, WItest_primary) %>% as.vector()

```


"Spatial Simple Similarity Index": $\Vert \mathbf{Ax^{r}} - \mathbf{x^{s}} \Vert_{2} / Q^{rs} ~ \forall ~ r,s \in l$

```{r}
##  Spatial Simple Similarity Index
WISim <- Sim_mat[WItest_rural, WItest_primary] / Q_mat[WItest_rural, WItest_primary] 

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Spatial Simple Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```

"Spatial Relative Similarity Index": $\Vert \mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{s}}(\mathbf{ix^{s}})^{-1} \Vert_{2} / Q^{rs} ~ \forall ~ r,s \in l$

```{r}
##  Spatial Relative Similarity Index
WISim <- Sim_mat_rel[WItest_rural, WItest_primary] / Q_mat[WItest_rural, WItest_primary] 

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Spatial Relative Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```

"Spatial Import Similarity Index": $\Vert \max\{\mathbf{Ax^{r}} - \mathbf{x^{r}}, 0\} - \mathbf{x^{s}} \Vert_{2} / Q^{rs} ~ \forall ~ r,s \in l$

```{r}
##  Spatial Import Similarity Index
WISim <- Sim_mat_imp[WItest_rural, WItest_primary]  / Q_mat[WItest_rural, WItest_primary] 

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Spatial Import Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```

"Spatial *Import Similarity Index - Net Exports": $\Vert \max\{\mathbf{Ax^{r}} - \mathbf{x^{r}}, 0\} - \mathbf{\tilde{x}^{s}} \Vert_{2}  / Q^{rs} ~ \forall ~ r,s \in l$

```{r}
##  Spatial *Import Similarity Index - Net Exports
WISim <- Sim_mat_exp[WItest_rural, WItest_primary] / Q_mat[WItest_rural, WItest_primary] 

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Spatial *Import Similarity Index - Net Exports",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name))  )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```

"Spatial Relative Import Similarity Index": $\Vert \max\{\mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{r}}(\mathbf{ix^{r}})^{-1}, 0\} - \mathbf{x^{s}}(\mathbf{ix^{s}})^{-1} \Vert_{2} / Q^{rs} ~ \forall ~ r,s \in l$

```{r}
##  Spatial Relative Import Similarity Index
WISim <- Sim_mat_imp_rel[WItest_rural, WItest_primary] / Q_mat[WItest_rural, WItest_primary] 

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Spatial Relative Import Similarity Index",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```

"Spatial *Relative Import Similarity Index - Net Exports": $\Vert \max\{\mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{r}}(\mathbf{ix^{r}})^{-1}, 0\} - \mathbf{\tilde{x}^{s}}(\mathbf{i\tilde{x}^{s}})^{-1} \Vert_{2} / Q^{rs} ~ \forall ~ r,s \in l$

```{r}
##  Spatial  *Relative Import Similarity Index - Net Exports
WISim <- Sim_mat_exp_rel[WItest_rural, WItest_primary] / Q_mat[WItest_rural, WItest_primary] 

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), cbind(WItest_primary, WItest_primary))

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Spatial *Relative Import Similarity Index - Net Exports",
       fill = "Regional Cluster") +
  scale_fill_brewer(palette = "Set1",
                    labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"New Regional-level Total Output Table":  $\mathbf{X}$

```{r}
WI_match <- sparseMatrix(
  i = match(rownames(WISim), WItest_rural), 
  j = match(c(colnames(WISim)[apply(WISim, 1, which.min)]), WItest_primary),  
  x = 1L,
  dims = c(nrow(WISim), ncol(WISim)),
  dimnames = list(WItest_rural, WItest_primary)
) %>% as.matrix()

Xpay_mat_H1 <- (Xpay_mat[, WItest_rural] %*% WI_match) + Xpay_mat[, colnames(WI_match)]
Xpay_mat_H1
```





### WI Test - Natural

```{r}
WItest_rural <- grep("^55", colnames(Xpay_mat), value=TRUE) %>%
                grep("55009", ., value=TRUE, invert = TRUE) %>% 
                grep("55025", ., value=TRUE, invert = TRUE) %>% 
                grep("55079", ., value=TRUE, invert = TRUE)

WItest_primary <- c(grep("^55", colnames(Xpay_mat), value=TRUE) , "17031", "27053")
names(WItest_primary) <- WItest_primary

WItest_all <- c(WItest_primary) %>% as.vector()

```


"Simple Similarity Index": $\Vert \mathbf{Ax^{r}} - \mathbf{x^{s}} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Simple Similarity Index
WISim <- Sim_mat[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), 
                 cbind( c("55009", "55025", "55079", "17031", "27053"),  c("55009", "55025", "55079", "17031", "27053") ) )

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Simple Similarity Index",
       fill = "Regional Cluster")  +
       scale_fill_discrete(labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )

```


"Relative Similarity Index": $\Vert \mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{s}}(\mathbf{ix^{s}})^{-1} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Relative Similarity Index
WISim <- Sim_mat_rel[WItest_rural, WItest_primary]


RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), 
                 cbind( c("55009", "55025", "55079", "17031", "27053"),  c("55009", "55025", "55079", "17031", "27053") ) )

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Relative Similarity Index",
       fill = "Regional Cluster") +
       scale_fill_discrete(labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```



"Import Similarity Index": $\Vert \max\{\mathbf{Ax^{r}} - \mathbf{x^{r}}, 0\} - \mathbf{x^{s}} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Import Similarity Index
WISim <- Sim_mat_imp[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), 
                 cbind( c("55009", "55025", "55079", "17031", "27053"),  c("55009", "55025", "55079", "17031", "27053") ) )

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Import Similarity Index",
       fill = "Regional Cluster") +
       scale_fill_discrete(labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"*Import Similarity Index - Net Exports": $\Vert \max\{\mathbf{Ax^{r}} - \mathbf{x^{r}}, 0\} - \mathbf{\tilde{x}^{s}} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  *Import Similarity Index - Net Exports
WISim <- Sim_mat_exp[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), 
                 cbind( c("55009", "55025", "55079", "17031", "27053"),  c("55009", "55025", "55079", "17031", "27053") ) )

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              *Import Similarity Index - Net Exports",
       fill = "Regional Cluster") +
       scale_fill_discrete(labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"Relative Import Similarity Index": $\Vert \max\{\mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{r}}(\mathbf{ix^{r}})^{-1}, 0\} - \mathbf{x^{s}}(\mathbf{ix^{s}})^{-1} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  Relative Import Similarity Index
WISim <- Sim_mat_imp_rel[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), 
                 cbind( c("55009", "55025", "55079", "17031", "27053"),  c("55009", "55025", "55079", "17031", "27053") ) )

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Relative Import Similarity Index",
       fill = "Regional Cluster") +
       scale_fill_discrete(labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```

"*Relative Import Similarity Index - Net Exports": $\Vert \max\{\mathbf{Ax^{r}}(\mathbf{iAx^{r}})^{-1} - \mathbf{x^{r}}(\mathbf{ix^{r}})^{-1}, 0\} - \mathbf{\tilde{x}^{s}}(\mathbf{i\tilde{x}^{s}})^{-1} \Vert_{2} ~ \forall ~ r,s \in l$

```{r}
##  *Relative Import Similarity Index - Net Exports
WISim <- Sim_mat_exp_rel[WItest_rural, WItest_primary]

RowMin <- rbind( cbind(place = rownames(WISim), match = colnames(WISim)[apply(WISim, 1, which.min)]), 
                 cbind( c("55009", "55025", "55079", "17031", "27053"),  c("55009", "55025", "55079", "17031", "27053") ) )

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot( TIGER_CBP_RUCC_h1m ) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              *Relative Import Similarity Index - Net Exports",
       fill = "Regional Cluster") +
       scale_fill_discrete(labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )
```







### Maps

```{r}
##Match rural to mid

rural <- filter(TIGER_CBP_RUCC, H3==3) %>% transmute(place = place)  
st_geometry(rural) <- NULL
rural <- rownames(rural)

primary <- filter(TIGER_CBP_RUCC, H3==2) %>% transmute(place = place) %>% as.vector()
st_geometry(primary) <- NULL
primary <- rownames(primary)

Sim <- Sim_mat[rural, primary]

RowMin <- cbind(place = rownames(Sim), match = colnames(Sim)[apply(Sim, 1, which.min)])

table(RowMin[,"match"])

TIGER_CBP_RUCC_h1m <- inner_join(TIGER_CBP_RUCC, RowMin, by = "place", copy = TRUE)

ggplot(  filter(TIGER_CBP_RUCC_h1m, STATEFP=="55")) +
  geom_sf(aes(fill = match), color = NA) +
  coord_sf() +
  theme_void() +
  labs(title = "              First Order Similarity Matching",
       subtitle = "              Simple Similarity Index",
       fill = "Regional Cluster") +
       scale_fill_discrete(labels = (TIGER_CBP_RUCC_h1m  %>% filter(place %in% unique(TIGER_CBP_RUCC_h1m$match) ) %>% pull(County_Name)) )


H_match <- sparseMatrix(
  i = match(rownames(Sim), rural), 
  j = match(c(colnames(Sim)[apply(Sim, 1, which.min)]), primary),  
  x = 1L,
  dims = c(nrow(Sim), ncol(Sim)),
  dimnames = list(rural, primary)
) %>% as.matrix()


  
TIGER_CBP_RUCC %>% dplyr::filter(STATEFP!="15" & STATEFP!="02" ) %>% 
  tm_shape() +
  tm_fill(col = "H3",  
          title = "RUCC", 
          id = "NAMELSAD", 
          palette = "inferno", 
          n = 4, 
          contrast = c(.35, 1), 
          style = "fixed", 
          breaks = c(1, 2, 3, 4), 
          labels = c("1", "2", "3")
          )

```




```{r}
# Display tools
#display.brewer.all(n=NULL, type="all", select=NULL, exact.n=TRUE,  colorblindFriendly=FALSE)
#display.brewer.pal()
#palette_explorer()

  
TIGER_CBP_RUCC %>% dplyr::filter(STATEFP!="15" & STATEFP!="02" ) %>% 
  tm_shape() +
  tm_fill(col = "RUCC_2013",  
          title = "RUCC", 
          id = "NAMELSAD", 
          palette = "inferno", 
          n = 10, 
          contrast = c(.35, 1), 
          style = "fixed", 
          breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10), 
          labels = c("1", "2", "3", "4", "5", "6", "7", "8", "9")
          )
  
  
tmap_mode("view")
tmap_last()

```


```{r}
ggplot(filter(TIGER_CBP_RUCC, STATEFP=="55")) +
  geom_sf(aes(fill = RUCC_2013), color = NA) +
  scale_fill_viridis_c(option = "C",
                       limits = c(0, 10),
                       breaks  = c(1, 3, 5, 7, 9),
                       labels = c("1", "3", "5", "7", 9)) + 
  coord_sf() +
  theme_void() +
  labs(title = "              Wisconsin Rural-urban Continuum",
       fill = "RUCC") 
```




FIN
::: 
















