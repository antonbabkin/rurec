---
title: "Toy Story"
author: "Austin Sandler"
date: "3/22/2022"
output:
  html_document:
    code_folding: hide
    code_download: yes
    latex_engine: pdflatex
  pdf_document: default
self_contained: no
---

```{r preamble, include = FALSE}
# When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

options(scipen=999)

```
##  {.tabset}

This R Markdown document is a testing ground for Toy model specifications with numerical examples. 

 
### RStartup

<details><summary>Possible Warnings</summary>
```{r packages and libraries}
# Download, Install, and Add R packages as necessary.

# List packages needed for this exercise
packages <- c("dlm",
              "DT",
              "geosphere",
              "knitr",
              "tidyr")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages], dependencies = TRUE)
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))

```
</details>



`r paste0("Date: ",  Sys.Date())`

`r kable((.packages()), col.names = "R Packages")`

`r paste0("Project directory: ",  getwd())`

### Toy IO 

The static Input-Output analysis, à la Wassily Leontief, poses the question: What level of output should each industry produce, such that it will satisfy the total demand of that industries output across all industries in an economy?

Simplifying assumptions:

1. Each industry produces only one homogeneous commodity.
1. Each industry uses a fixed input ratio.
1. Each industry exhibits constant returns to scale.

Suppose the **N**ational level economy is composed of 2 industries (e.g., **E**xtraction and **F**arming). Let the interindustry sales be given by,

\begin{equation}
\underset{(i \times i)}{\mathbf{Z}} = 
  \begin{bmatrix} 
    z_{11} & z_{12} \\ 
    z_{21} & z_{22} \\ 
  \end{bmatrix}
  = 
  \begin{bmatrix} 
    150 & 500 \\ 
    200 & 100 \\ 
  \end{bmatrix}
\end{equation}

Given the vector of total output $\mathbf{x}' = \begin{bmatrix} 1000 & 2000  \end{bmatrix}$, the Direct Requirements matrix (input requirements), constructed as $\mathbf{A} = \mathbf{Z\hat{x}^{-1}}$, is given by, 

\begin{equation}
\underset{(i \times i)}{\mathbf{A}} = 
    \begin{bmatrix} 
    \frac{z_{11}}{x_{1}} & \frac{z_{12}}{x_{2}} \\ 
    \frac{z_{21}}{x_{1}} & \frac{z_{22}}{x_{2}} \\ 
  \end{bmatrix}
  = 
    \begin{bmatrix} 
    a_{11} & a_{12} \\ 
    a_{21} & a_{22} \\ 
  \end{bmatrix}
  = 
  \begin{bmatrix} 
    0.15 & 0.25 \\ 
    0.20 & 0.05 \\ 
  \end{bmatrix}
\end{equation}

The Total Requirements matrix (Leontief inverse), constructed as $\mathbf{L} = \left(\mathbf{I} - \mathbf{A}\right)^{-1}$, is given by, 

\begin{equation}
\underset{(i \times i)}{\mathbf{L}} = 
    \begin{bmatrix} 
    l_{11} & l_{12} \\ 
    l_{21} & l_{22} \\ 
  \end{bmatrix}
  = 
  \begin{bmatrix} 
    1.2541254 & 0.330033 \\ 
    0.2640264 & 1.122112 \\ 
  \end{bmatrix}
\end{equation}


Given total output $\mathbf{x}$ and interindustry sales $\mathbf{Z}$, the exogenous final demand is simply the difference in total output and the row sums of interindustry transactions given by, $\mathbf{f} = \mathbf{x} - \mathbf{Zi}$ where $\mathbf{f}' = (350 1700)$

Suppose, *final demand* for extraction were to increase to \$600 next year and decrease to \$1500 for farming, such that the change in final demand is given by, $\Delta\mathbf{f}' = \begin{bmatrix} 250 & 200 \end{bmatrix}$. Using the Leontief inverse (total requirements) matrix, the expected change in total output of the economy is given by $\Delta\mathbf{x} = \mathbf{L}\Delta\mathbf{f}$ such that $\Delta\mathbf{x}' = \begin{bmatrix} 247.5248 & -158.4158 \end{bmatrix}$

```{r Toy open IO}
#A simple I/O analysis "by hand" presuming given national accounts are in the form of raw interindustry flows where one must generate a direct requirements matrices (Technical Coefficients) and the total requirements matrix (Leontief inverse).
# Note the national IO table at present is a domestic flow specification as such the interindustry transactions table is no longer representative of a technological matrix. It rather represents the intra-national interindustry transactions, which are determined not only by technological factors, but also by trade factors. As a consequence in the domestic-flow table the balance between supply and demand is made considering only domestic production.


#Toy Transaction matrix
Toy_Z_mat <- matrix(c(150, 500, 200, 100), nrow = 2, byrow = TRUE)
rownames(Toy_Z_mat) <- c("Extract", "Farm")
colnames(Toy_Z_mat) <- c("Extract", "Farm")
print("Transaction matrix")
Toy_Z_mat

#Toy Total Output vector
Toy_Total_Output <- c(1000, 2000)
print("Total Output vector")
Toy_Total_Output

#Toy Final Demand vector
Toy_Final_Demand <- Toy_Total_Output - (Toy_Z_mat %*% rep(c(1), each=ncol(Toy_Z_mat)))
print("Final Demand vector")
Toy_Final_Demand

#Toy Direct Requirements matrix
Toy_A_mat <- Toy_Z_mat %*% diag(1/Toy_Total_Output)
rownames(Toy_A_mat) <- c("Extract", "Farm")
colnames(Toy_A_mat) <- c("Extract", "Farm")
print("Direct Requirements matrix")
Toy_A_mat

#Toy Total Requirements matrix
Toy_L_mat <- solve(diag(nrow(Toy_A_mat)) - Toy_A_mat)
print("Total Requirements matrix")
Toy_L_mat

#Toy change in Final Demand vector
Toy_Delta_Demand <- c(250, -200)
print("Final Demand vector change")
Toy_Delta_Demand

#Toy change in Total Output vector
Toy_Delta_Output <- Toy_L_mat %*% Toy_Delta_Demand
print("Total Output vector change")
Toy_Delta_Output

```


```{r Toy necessary and sufficient tests}
# Note, to allow for the presence of final demand and primary inputs, in an open model, the sum of each column in $A$ must be less than 1. 

# Simple sufficient, but not necessary condition of sustainability. All must be TRUE.
all(colSums(Toy_A_mat) < 1) %>% {paste0("Technology matrix structure passes sufficient test of sustainability: ", . )}

#Hawkins – Simon condition check. All must be TRUE.
local({
PM = NULL
for(n in 2:nrow(Toy_A_mat)){
  PM[1:n] = (det((diag(nrow(Toy_A_mat)) - Toy_A_mat)[1:n,1:n]) > 0)
}
all(all(PM) & (diag(diag(nrow(Toy_A_mat)) - Toy_A_mat) > 0) & (det(diag(nrow(Toy_A_mat)) - Toy_A_mat) > 0)) %>% {paste0("Leontief matrix structure passes necessary and sufficient test of practibility and viability: ", . )}
})

```







### Project Trail


**Retrospective** 

What are absolute and relative "rural use coefficients" exactly?

In practice, for two *primary ECAs* $A$ and $B$, we construct the absolute rural use coefficients as:

<p align="center">
$\displaystyle \alpha^{r}_{A} = \frac{\sum^{n}_{j=1} u_{cj} s_{Aj}} {\sum^{n}_{j=1} u_{cj}}$,
$\displaystyle \alpha^{r}_{B} = \frac{\sum^{n}_{j=1} u_{cj} s_{Bj}} {\sum^{n}_{j=1} u_{cj}}$
</p>

where $u_{cj}$ the the value of purchases of a single commodity $c$ by industry $j$ from the BEA's the *Use* matrix, and $s_{Aj}$ and $s_{Bj}$ are the annual sales of industry $j$ in *primary* ECA regions $A$ and $B$, for $j = 1, \dots, n$ industries. Similarly, we construct the relative rural use coefficients as:

<p align="center">
$\displaystyle \rho^{r}_{A} = \frac{\alpha^{r}_{A}} {\sum^{n}_{j=1} s_{Aj}}$,
$\displaystyle \rho^{r}_{B} = \frac{\alpha^{r}_{B}} {\sum^{n}_{j=1} s_{Bj}}$
</p>

But what do these coefficients mean? 

In the absolute specification, the numerator is a uniform modification of the elements in a row of the national *Use* matrix. The national value of purchases of commodity $c$ by each industry $j$ weighted by the regional value of "sales" by each industry $j$ (CBP will offer values of county-level industry employment, Q1 payroll, and annual payroll). This is divided by the total intermediate value of commodity $c$ at the national level.

The relative specification then takes the absolute coefficient divided by the sum of the regional "sales" by each industry $j$. 

This procedure is somewhat akin to those of a single-region IO through the application of *regional supply percentages* $p^{r}_{i}$ to estimate a matrix showing inputs from firms in the region to production in that region i.e., a regional technical coefficients matrix. Where $\mathbf{A^{rr} = \hat{p}^{r}A}$.


Here the gravity is defined as the relative proportions for each coefficient across the two regions.

The basic idea of a *Gravity Model* is that the flow of good $i$ from region $r$ to region $s$ can be looked upon as a function of (1) some measure of the total output of $i$ in $r$, $x^{r}_{i}$, (2) some measure of the total purchases of $i$ in $s$, $x^{s}_{i}$ ,and (3) the distance (as a measure of “impedance”) between the two regions, $d^{rs}$. Leontief and Strout (1963) suggested the relatively simplified gravity model specification:

$$ z^{rs}_{i} = \frac{x^{r \cdot}_{i}x^{\cdot s}_{i}} {x^{\cdot \cdot}_{i}} Q^{rs}_{i}$$
where $x^{r \cdot}_{i}$ is the “supply pool” of good $i$ in region $r$, $x^{\cdot s}_{i}$ is the “demand pool” of good $i$ in region $s$, $x^{\cdot \cdot}_{i}$ is the total production of commodity $i$ in the system and $Q^{rs}_{i}$ is a parameter to be estimated.

The most optimistic scenario is that values of $x^{r \cdot}_{i}$, $x^{\cdot s}_{i}$, $x^{\cdot \cdot}_{i}$,  and $z^{rs}_{i}$ are known from some base period or for some subset of transportation data. In that case, one can evaluate the parameter $Q^{rs}_{i}$ from those data, as

$$Q^{rs}_{i} = \frac{\bar{z}^{rs}_{i} \bar{x}^{\cdot \cdot}_{i}} {\bar{x}^{r \cdot}_{i} \bar{x}^{\cdot s}_{i}}$$

where overbars indicate known values.


**Total Use Objective** 

One objective of the project is to use *Total Use Coefficients* to quantify and match the economic connectedness of Micropolitian and Urban clusters to large Metropolitan economies. This is done by analyzing how well the commodity output mix of Micropolitian and Urban clusters to the commodity uses of industries in large Metropolitan cores.



### Toy TUC 

**Toy Model**

Suppose there is 1 **N**ational level economy composed of 2 industries (e.g., Hydrocarbon **E**xtraction and **F**arming), 3 commodities (e.g., **G**asoline, **H**ogs,  and **I**ce cream), and 4 regions (e.g., **D**ane county (Madison , WI), **C**ook county (Chicago, IL), **B**rown County (Green Bay, WI), and the **A**ll the rest as a collective residual).  

Available data consists of a $3 \times 2$ **N**ational level commodity by industry *Use table* ($\underset{(3 \times 2)}{\mathbf{U}} = [u_{ij}]$) that depicts the value of purchases of commodity  $i$  by industry  $j$.  (In conjunction with a column vector of total industry outputs ($\underset{(2 \times 1)}{\mathbf{x}} = [x_{j}]$),  this gives  rise to the standard *Use coefficients* $\mathbf{B} = [b_{ij}] = u_{ij}/x_{j}$ in which column $j$ represents the value of inputs of each commodity per dollar’s worth  $\mathbf{B}$ are therefore commodities-by-industries.) Similarly, other available data consists of a  $2 \times 3$ **N**ational level commodity by industry *Make table* ($\underset{(2 \times 3)}{\mathbf{V}} = [v_{ij}]$) that depicts  the value of output of commodity $j$ that is produced  by industry $i$. (Note, the row  sums of $\mathbf{V}$ are total industry output $\mathbf{x}$ and column sums of $\mathbf{V}$ are total [commodity] output $\mathbf{q}'$.)

Available data of at the region level consists of sector specific industry activity ($\underset{(2 \times 4)}{\mathbf{x}^r} = [x^{r}_{j}]$) in the form of either employment, payroll, or simply number of establishments. 

As such let,  

\begin{equation}
\underset{(c \times i)}{\mathbf{U}^{n}} = 
  \begin{bmatrix} 
    u^{n}_{11} & u^{n}_{12} \\ 
    u^{n}_{21} & u^{n}_{22} \\ 
    u^{n}_{31} & u^{n}_{32} \\ 
  \end{bmatrix}
  = 
  \begin{bmatrix} 
    u^{n}_{GE} & u^{n}_{GF} \\ 
    u^{n}_{HE} & u^{n}_{HF} \\ 
    u^{n}_{IE} & u^{n}_{IF} \\ 
  \end{bmatrix}, \;  \text{ and} \; \;
\underset{(i \times g)}{\mathbf{X}^{r}_{empl/pay}} = 
  \begin{bmatrix} 
    x^{1}_{1} & x^{2}_{1} & x^{3}_{1} & x^{4}_{1} \\ 
    x^{1}_{2} & x^{2}_{2} & x^{3}_{2} & x^{4}_{2} \\ 
  \end{bmatrix}
  = 
    \begin{bmatrix} 
    x^{A}_{E} & x^{B}_{E} & x^{C}_{E} & x^{D}_{E} \\ 
    x^{A}_{F} & x^{B}_{F} & x^{C}_{F} & x^{D}_{F} \\  
    \end{bmatrix}
\end{equation}

As such the project narrative use coefficients (as demonstrated in the excel trial) are:


$$
\underset{(c \times g)}{\mathbf{\alpha}} = (\hat{\mathbf{u}}^{n})^{-1}\mathbf{U}^{n}\mathbf{X}^{r} = 
\begin{bmatrix} 
    \frac{u^{n}_{GE}x^{A}_{E}+u^{n}_{GF}x^{A}_{F}}{u^{n}_{GE}+u^{n}_{GF}} & \frac{u^{n}_{GE}x^{B}_{E}+u^{n}_{GF}x^{B}_{F}}{u^{n}_{GE}+u^{n}_{GF}} & \frac{u^{n}_{GE}x^{C}_{E}+u^{n}_{GF}x^{C}_{F}}{u^{n}_{GE}+u^{n}_{GF}} & \frac{u^{n}_{GE}x^{D}_{E}+u^{n}_{GF}x^{D}_{F}}{u^{n}_{GE}+u^{n}_{GF}} \\ 
    \frac{u^{n}_{HE}x^{A}_{E}+u^{n}_{HF}x^{A}_{F}}{u^{n}_{HE}+u^{n}_{HF}} & \frac{u^{n}_{HE}x^{B}_{E}+u^{n}_{HF}x^{B}_{F}}{u^{n}_{HE}+u^{n}_{HF}} & \frac{u^{n}_{HE}x^{C}_{E}+u^{n}_{HF}x^{C}_{F}}{u^{n}_{HE}+u^{n}_{HF}} & \frac{u^{n}_{HE}x^{D}_{E}+u^{n}_{HF}x^{D}_{F}}{u^{n}_{HE}+u^{n}_{HF}} \\ 
    \frac{u^{n}_{IE}x^{A}_{E}+u^{n}_{IF}x^{A}_{F}}{u^{n}_{IE}+u^{n}_{IF}} & \frac{u^{n}_{IE}x^{B}_{E}+u^{n}_{IF}x^{B}_{F}}{u^{n}_{IE}+u^{n}_{IF}} & \frac{u^{n}_{IE}x^{C}_{E}+u^{n}_{IF}x^{C}_{F}}{u^{n}_{IE}+u^{n}_{IF}} & \frac{u^{n}_{IE}x^{D}_{E}+u^{n}_{IF}x^{D}_{F}}{u^{n}_{IE}+u^{n}_{IF}} \\
\end{bmatrix}
$$
and 

$$
\underset{(c \times g)}{\mathbf{\rho}} = (\hat{\mathbf{u}}^{n})^{-1}\mathbf{U}^{n}\mathbf{X}^{r}(\hat{\mathbf{x}}^{r})^{-1} = 
\begin{bmatrix} 
    \frac{u^{n}_{GE}x^{A}_{E}+u^{n}_{GF}x^{A}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{A}_{E} + x^{A}_{F})} & \frac{u^{n}_{GE}x^{B}_{E}+u^{n}_{GF}x^{B}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{B}_{E} + x^{B}_{F})} &  \frac{u^{n}_{GE}x^{C}_{E}+u^{n}_{GF}x^{C}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{C}_{E} + x^{C}_{F})} & \frac{u^{n}_{GE}x^{D}_{E}+u^{n}_{GF}x^{D}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{D}_{E} + x^{D}_{F})} \\ 
    \frac{u^{n}_{HE}x^{A}_{E}+u^{n}_{HF}x^{A}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{A}_{E} + x^{A}_{F})} & \frac{u^{n}_{HE}x^{B}_{E}+u^{n}_{HF}x^{B}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{B}_{E} + x^{B}_{F})} & \frac{u^{n}_{HE}x^{C}_{E}+u^{n}_{HF}x^{C}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{C}_{E} + x^{C}_{F})} & \frac{u^{n}_{HE}x^{D}_{E}+u^{n}_{HF}x^{D}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{D}_{E} + x^{D}_{F})} \\ 
    \frac{u^{n}_{IE}x^{A}_{E}+u^{n}_{IF}x^{A}_{F}}{(u^{n}_{IE}+u^{n}_{IF})(x^{A}_{E} + x^{A}_{F})} & \frac{u^{n}_{IE}x^{B}_{E}+u^{n}_{IF}x^{B}_{F}}{(u^{n}_{IE}+u^{n}_{IF})(x^{B}_{E} + x^{B}_{F})} & \frac{u^{n}_{IE}x^{C}_{E}+u^{n}_{IF}x^{C}_{F}}{(u^{n}_{IE}+u^{n}_{IF})(x^{C}_{E} + x^{C}_{F})} & \frac{u^{n}_{IE}x^{D}_{E}+u^{n}_{IF}x^{D}_{F}}{(x^{C}_{E} + x^{C}_{F})(x^{D}_{E} + x^{D}_{F})} \\
\end{bmatrix}
$$


**What are the interpretations of these coefficients  explicitly?**

From here we can ask the question: Is Madison more economically connected to Chicago or Green Bay or is it an economic island? More specifically, is the commodity(?) output (mix?) of Madison more congruent with the commodity(?) output (mix?) of Chicago or Green Bay?  (Note: there is no claim/evidence of trade and commodity flows across space using this specification, instead we are measuring possible (one direction) sector compatibility.)

Given the commodity by geography, relative use coefficient matrix $\mathbf{\rho}$, we can now construct a geography by geography (from-to) score for each commodity given by:

$$
\mathbf{\phi}_{Gasoline} = \hat{\rho}_{G}\mathbf{i}\mathbf{i}'[\hat{\rho}_{G}\mathbf{i}\mathbf{i}'+\hat{\rho}'_{G}\mathbf{i}\mathbf{i}']^{-1} = 
  \begin{bmatrix} 
    \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{A}} & \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{B}} & \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{C}} & \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{D}} \\
    \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{A}} & \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{B}} & \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{C}} & \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{D}} \\
    \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{A}} & \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{B}} & \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{C}} & \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{D}} \\
    \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{A}} & \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{B}} & \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{C}} & \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{D}} \\
  \end{bmatrix}
$$
The maximum value by row of $\mathbf{\phi}_{G}$ determines which typology each region is assigned on a per commodity basis.


Similarly the other commodities are given by:

$$
\mathbf{\phi}_{Hogs} = \hat{\rho}_{H}\mathbf{i}\mathbf{i}'[\hat{\rho}_{H}\mathbf{i}\mathbf{i}'+\hat{\rho}'_{H}\mathbf{i}\mathbf{i}']^{-1} = 
  \begin{bmatrix} 
    \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{A}} & \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{B}} & \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{C}} & \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{D}} \\
    \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{A}} & \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{B}} & \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{C}} & \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{D}} \\
    \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{A}} & \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{B}} & \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{C}} & \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{D}} \\
    \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{A}} & \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{B}} & \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{C}} & \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{D}} \\
  \end{bmatrix}
$$


$$
\mathbf{\phi}_{Ice cream} = \hat{\rho}_{I}\mathbf{i}\mathbf{i}'[\hat{\rho}_{I}\mathbf{i}\mathbf{i}'+\hat{\rho}'_{I}\mathbf{i}\mathbf{i}']^{-1} = 
  \begin{bmatrix} 
    \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{A}} & \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{B}} & \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{C}} & \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{D}} \\
    \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{A}} & \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{B}} & \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{C}} & \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{D}} \\
    \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{A}} & \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{B}} & \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{C}} & \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{D}} \\
    \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{A}} & \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{B}} & \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{C}} & \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{D}} \\
  \end{bmatrix}
$$

Such that 

$$
\mathbf{\phi} = 
\begin{bmatrix}
\mathbf{\phi}_{G} & 0 & 0 \\
0 & \mathbf{\phi}_{H} & 0 \\
0 & 0 & \mathbf{\phi}_{I} \\
\end{bmatrix}
$$


The maximum value by row of $\mathbf{\phi}$ determines which typology each region is assigned on an overall commodity basis.

(Alternative assignment procedures may incorporate a weighted mix of commodities or alternatively measure the "gravity" of regions by commodities to determine a regions commodity center of gravity.)


Suppose,  

\begin{equation}
\underset{(c \times i)}{\mathbf{U}^{n}} = 
  \begin{bmatrix} 
    18 & 12 \\ 
    20 & 16 \\ 
    2 & 6 \\ 
  \end{bmatrix}, \;  \text{ and} \; \;
\underset{(i \times g)}{\mathbf{X}^{r}_{employment}} = 
  \begin{bmatrix} 
    500 & 10 & 30 & 4 \\ 
    6000 & 200 & 400 & 50 \\ 
  \end{bmatrix}
\end{equation}


```{r  toyexample}
Toy_U_mat <-  matrix(c(18, 12, 20, 16, 2, 6), nrow = 3, byrow = TRUE)
rownames(Toy_U_mat) <- c("Gas", "Hogs", "Ice")
colnames(Toy_U_mat) <- c("Extract", "Farm")
Toy_X_mat <-  matrix(c(500, 10,  30, 4, 6000, 200, 400, 50), nrow = 2, byrow = TRUE)
rownames(Toy_X_mat) <- c("Extract", "Farm")
colnames(Toy_X_mat) <- c("AllElse", "Brown", "Cook", "Dane")
Toy_u_vec <- as.vector(Toy_U_mat %*% rep(c(1), each=ncol(Toy_U_mat)))
Toy_x_vec <- as.vector(t(rep(c(1), each=nrow(Toy_X_mat))) %*% Toy_X_mat)

Toy_Alpha_mat <- solve(matrix(diag(Toy_u_vec, nrow = 3),  ncol=3)) %*% Toy_U_mat %*% Toy_X_mat
rownames(Toy_Alpha_mat) <- c("Gas", "Hogs", "Ice")
print("Alpha matrix")
Toy_Alpha_mat

Toy_Rho_mat <- Toy_Alpha_mat %*% solve(matrix(diag(Toy_x_vec, nrow = 4),  ncol=4)) 
colnames(Toy_Rho_mat) <- c("AllElse", "Brown", "Cook", "Dane")
print("Rho matrix")
Toy_Rho_mat



Toy_Phi_tilde_mat_G <- matrix(diag(Toy_Rho_mat[1,], nrow = 4),  ncol=4) %*%  rep(c(1), each=ncol(Toy_X_mat))  %*% t(rep(c(1), each=ncol(Toy_X_mat)))
Toy_Phi_mat_G <-  Toy_Phi_tilde_mat_G / (Toy_Phi_tilde_mat_G + t(Toy_Phi_tilde_mat_G))
rownames(Toy_Phi_mat_G) <- c("AllElse", "Brown", "Cook", "Dane")
colnames(Toy_Phi_mat_G) <- c("AllElse", "Brown", "Cook", "Dane")
print("Phi matrix - Gas")
Toy_Phi_mat_G
 
Toy_Phi_tilde_mat_H <- matrix(diag(Toy_Rho_mat[2,], nrow = 4),  ncol=4) %*%  rep(c(1), each=ncol(Toy_X_mat))  %*% t(rep(c(1), each=ncol(Toy_X_mat)))
Toy_Phi_mat_H <-  Toy_Phi_tilde_mat_H / (Toy_Phi_tilde_mat_H + t(Toy_Phi_tilde_mat_H))
rownames(Toy_Phi_mat_H) <- c("AllElse", "Brown", "Cook", "Dane")
colnames(Toy_Phi_mat_H) <- c("AllElse", "Brown", "Cook", "Dane")
print("Phi matrix - Hogs")
Toy_Phi_mat_H

Toy_Phi_tilde_mat_I <- matrix(diag(Toy_Rho_mat[3,], nrow = 4),  ncol=4) %*% rep(c(1), each=ncol(Toy_X_mat))  %*% t(rep(c(1), each=ncol(Toy_X_mat)))
Toy_Phi_mat_I <-  Toy_Phi_tilde_mat_I / (Toy_Phi_tilde_mat_I + t(Toy_Phi_tilde_mat_I))
rownames(Toy_Phi_mat_I) <- c("AllElse", "Brown", "Cook", "Dane")
colnames(Toy_Phi_mat_I) <- c("AllElse", "Brown", "Cook", "Dane")
print("Phi matrix - Ice")
Toy_Phi_mat_I


Toy_Phi_mat <- bdiag(Toy_Phi_mat_G, Toy_Phi_mat_H, Toy_Phi_mat_I)
  
```



### Redux

Simply put, at the core of our analysis lies the question: How similar are the inputs of Chicago to the outputs of Madison?

We are given only national level Input-Output tables (Make/Use tables, industry-by-industry industry-by-commodity, and commodity-by-commodity total requirements tables, and commodity-by-industry direct requirements tables) and regional level industry activity in the form of employment, payroll, and number of establishments from which to derive an answer.


*Possible Methodologies*

Seemingly, our first task is to "regionalize" the national level I/O accounts down to the desired regional scale.  

The most comprehensive approach is to execute an *interregional input–output (IRIO)* model. However, this approach only really serves as a platonic abstraction given the vast and detailed necessary exogenous inputs. 

One possible approach might be to estimate *regional supply percentages*, $p^{r}_{i}$. This approach requires knowledge of total regional output of each sector, $x^{r}_{i}$, and the exports of the product or each sector from the region, $e^{r}_{i}$, and the imports of all goods into the region, $m^{r}_{i}$. With knowledge of *regional supply percentages* one can scale the national level *direct/input requirements matrix* to estimate a regional *input requirements matrix*, $\mathbf{A^{rr}} = \mathbf{\hat{p}^{r}A}$. Clearly, this is beyond the scope of the available data. 

However in this manner, when trying to estimate $a^{rr}_{ij}$ from national data, the problem can be generalized as a two step process of: (1) estimate a regional technical coefficient, $a^{r}_{ij}$, from the corresponding national coefficient, $a^{n}_{ij}$, and then (2) estimate the regional input coefficient, $a^{rr}_{ij}$, as some proportion of the regional technical coefficient; that is, $a^{rr}_{ij} = p^{r}_{ij}a^{r}_{ij}$ (where  $0 \leq p^{r}_{ij} \leq 1$). 

The procedure for estimating $a^{rr}_{ij}$ from $a^{n}_{ij}$ is therefore: 

(1) find $\alpha^{r}_{ij} \geq 0$ such that $a^{r}_{ij} = (\alpha^{r}_{ij}) (a^{n}_{ij})$, and

(2) find $\beta^{r}_{ij}$ ($0 \leq \beta^{r}_{ij} \leq 1$) such that $a^{rr}_{ij} = (\beta^{r}_{ij}) (a^{r}_{ij})$

If we assume regional production recipes are identical then $\alpha^{r}_{ij} = 1$ and $a^{r}_{ij} = a^{n}_{ij}$ for all $i$ and $j$. Or if we assume each regional purchaser buys the same proportion of inputs from within the region, then $\beta^{r}_{ij} = p^{r}_{i}$ for all $i$. 

Given this structure, and assuming $a^{r}_{ij} = a^{n}_{ij}$, we may propose various functional estimates of $\beta^{r}_{ij}$ (i.e., location quotients) to derive $a^{rr}_{ij}$ from $a^{n}_{ij}$. The simplest of which only requires knowledge of gross output of sector $i$ in region $r$ and total output of all sectors in the region, $x^{r}_{i}$ and $x^{r}$, along with these values at the national level. Given by: $LQ^{r}_{i} = \left( \frac{x^{r}_{i} / x^{r}} {x^{n}_{i} / x^{n}} \right) = \left( \frac{x^{r}_{i} / x^{n}_{i}} {x^{r} / x^{n}} \right)$. Furthermore, many other regional analysts are documented using employment rather than output as an alternative to the relevant measures of regional and national activity. Clearly, this a feasible option given the available data.

Another possible approach is to employ the *RAS technique*, however, instead of the typical deployment for updating coefficients across time, we may update input coefficients across space. This approach requires $3n$ sets of information for the location of interest. These are, *total gross outputs*, $x^{r}_{j}$, *total interindustry sales*, by sector $u_{i} = \sum^{n}_{j=1} z^{r}_{ij}$, and *total interindustry purchases*, by sector $v_{i} = \sum^{n}_{i=1} z^{r}_{ij}$. But even this slimmed down approach is still just beyond the scope of the data.

Yet another possible approach is to implement parts or all of a *multiregional input–output model*. The regional tables of an MRIO employ a regional *technical* coefficients matrix, $\mathbf{A^{r}}$. Under this paradigm, information regarding the region of origin is ignored. These transactions are denoted $z^{\cdot r}_{ij}$, with the coefficients estimated as $a^{r}_{ij} = \frac{z^{\cdot r}_{ij}}{x^{r}_{j}}$ where $\mathbf{A^{r}} = \left[ a^{r}_{ij} \right]$. In practice, estimates are can be made using a *product-mix approach*. This technique essentially uses detailed level national technical coefficients and detailed level regional outputs to produce regional coefficients at a less detailed summary level (from weighted averages of the national detailed coefficients). This approach may be feasible given the available data, however, the necessary agglomeration of industry classes is not ideal. Furthermore, this approach may extend into the realm of interregional table, which requires data on dollar flow of goods between regions, $z^{rs}_{i}$, irrespective of the sector of destination in the receiving region. Again, however, this extension is beyond the scope of the available data. 

The final standard approach is to implement a *gravity model formulations* to estimate commodity flows between regions. The *Gravity Model* estimates the flow of goods between regions as a function of (1) some measure of the total output of $i$ in $r$, $x^{r}_{i}$, (2) some measure of the total purchases of $i$ in $s$, $x^{s}_{i}$, and (3) the distance (as a measure of “impedance”) between the two regions, $d^{rs}$. The relatively simplified gravity model specification is given by: $z^{rs}_{i} = \frac{x^{r \cdot}_{i}x^{\cdot s}_{i}} {x^{\cdot \cdot}_{i}} Q^{rs}_{i}$ where $x^{r \cdot}_{i}$ is the “supply pool” of good $i$ in region $r$, $x^{\cdot s}_{i}$ is the “demand pool” of good $i$ in region $s$, $x^{\cdot \cdot}_{i}$ is the total production of commodity $i$ in the system and $Q^{rs}_{i}$ is a parameter to be estimated. This approach may be feasible given the available data, too, (again with harsh simplifying assumptions). 




*Location Quotients*

```{r  toyQuotients}

Industry_Count <- 5

Toy_Total_mat <-  matrix(c(1.2523,	0.0143,	0.0055,	0.0276,	0.0892,
                           0.0251,	1.1230,	0.1450,	0.0331,	0.0709,
                           0.0203,	0.0236,	1.0420,	0.0128,	0.0237,
                           0.0092,	0.0171,	0.0088,	1.0048,	0.0105,
                           0.4020,	0.2675,	0.1055,	0.5102,	1.7703), nrow = Industry_Count, byrow = TRUE)

rownames(Toy_Total_mat) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")
colnames(Toy_Total_mat) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")

kable(Toy_Total_mat, caption = "Total Requirements Table ( Leontief inverse )") 



Toy_Direct_mat <- diag(ncol(Toy_Total_mat)) - solve(Toy_Total_mat)
rownames(Toy_Direct_mat) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")
colnames(Toy_Direct_mat) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")

kable(round(Toy_Direct_mat, 4), caption = "Direct Requirements Table (input coeffecients / structural matrix / national technical coeffecients)") 


Region_Count <- 4

Toy_Xemp_mat <-  matrix(c(500, 13, 100, 50, 
                          400, 34,  30, 88,
                          300, 120,  20, 123,
                          200, 200,  75, 40,
                          100, 10,  400, 4), nrow = Industry_Count, byrow = TRUE)

rownames(Toy_Xemp_mat) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")
colnames(Toy_Xemp_mat) <- c("AllElse", "Brown", "Cook", "Dane")
kable(Toy_Xemp_mat, caption = "Regional Industry-Employment Table") 


Toy_Direct_mat_r <- kronecker(diag(1, Region_Count), Toy_Direct_mat)

############ Simple Location Quotient
Toy_LQ <-  matrix(0, nrow=Industry_Count, ncol = Region_Count)

for (i in 1:Industry_Count){
 for (j in 1:Region_Count){
  Toy_LQ[i,j] <-((Toy_Xemp_mat[i,j])/sum(Toy_Xemp_mat[,j]))/(sum(Toy_Xemp_mat[i,])/sum(Toy_Xemp_mat))
 }
}
rownames(Toy_LQ) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")
colnames(Toy_LQ) <- c("AllElse", "Brown", "Cook", "Dane")
kable(round(Toy_LQ, 4), caption = "Simple Location Quotients") 


Toy_LQc <-  matrix(0, nrow=Industry_Count, ncol = Region_Count)
for (i in 1:Industry_Count){
 for (j in 1:Region_Count){
  if (Toy_LQ[i,j] > 1){
   Toy_LQc[i,j] <- 1
  }
  else{
   Toy_LQc[i,j] <- Toy_LQ[i,j]
  }
 }
}


Toy_Dir_LQ <- diag(c(Toy_LQc)) %*% Toy_Direct_mat_r
#kable(round(Toy_Dir_LQ[1:5,1:5], 4), caption = "Regional Direct Requirements (Simple LQ) - AllElse") 
#Toy_Dir_LQ %>% round(4)


############ Cross-Industry Location Quotient
#Toy_CILQ <- kronecker(diag(1, Industry_Count), Toy_LQ) %*% diag(1/c(t(Toy_LQ)), length(c(t(Toy_LQ))))
#for (i in 1:ncol(Toy_LQ)){assign(paste0('Toy_CILQ_', colnames(Toy_LQ)[i]), Toy_LQ[,i] %*% t(1/Toy_LQ[,i]) )}

Toy_CLQ <-  c()
 for (i in 1:Region_Count){
  Toy_CLQ[[i]] <- Toy_LQ[,i] %*% t(1/Toy_LQ[,i])
  rownames(Toy_CLQ[[i]]) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")
 }
names(Toy_CLQ) <- c("AllElse", "Brown", "Cook", "Dane")
#kable(Toy_CLQ, digits = 4, caption = "Cross-Industry Location Quotients") 
 print("Cross-Industry Location Quotients")
Toy_CLQ

Toy_CLQc <- bdiag(Toy_CLQ)

for (i in 1:nrow(Toy_CLQc)){
 for (j in 1:ncol(Toy_CLQc)){
  if (Toy_CLQc[i,j] > 1){
   Toy_CLQc[i,j] <- 1
  }
  else{
   Toy_CLQc[i,j] <- Toy_CLQc[i,j]
  }
 }
}

Toy_Dir_CLQ <- Toy_CLQc * Toy_Direct_mat_r
#Toy_Dir_CLQ  %>% round(4)

############ Semilogarithmic Location Quotient
#for (i in 1:ncol(Toy_LQ)){assign(paste0('Toy_SLQ_', colnames(Toy_LQ)[i]), Toy_LQ[,i] %*% t(1/(log2(1 + Toy_LQ[,i]))) )}

Toy_SLQ <-  c()
 for (i in 1:Region_Count){
  Toy_SLQ[[i]] <- Toy_LQ[,i] %*% t(1/(log2(1 + Toy_LQ[,i])))
  rownames(Toy_SLQ[[i]]) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")
 }
names(Toy_SLQ) <- c("AllElse", "Brown", "Cook", "Dane")

#kable(Toy_SLQ, digits =4, caption = "Semilogarithmic Location Quotients")
print("Semilogarithmic Location Quotients")
Toy_SLQ

Toy_SLQc <- bdiag(Toy_SLQ)

for (i in 1:nrow(Toy_SLQc)){
 for (j in 1:ncol(Toy_SLQc)){
  if (Toy_SLQc[i,j] > 1){
   Toy_SLQc[i,j] <- 1
  }
  else{
   Toy_SLQc[i,j] <- Toy_SLQc[i,j]
  }
 }
}

Toy_Dir_SLQ <- Toy_SLQc * Toy_Direct_mat_r
#Toy_Dir_SLQ  %>% round(4)

############ Flegg Location Quotient
Toy_FLQ_delta <- .3
Toy_lambda <- (log2(1 + (colSums(Toy_Xemp_mat)/sum(Toy_Xemp_mat))))^(Toy_FLQ_delta)

#for (i in 1:ncol(Toy_LQ)){assign(paste0('Toy_FLQ_', colnames(Toy_LQ)[i]), Toy_lambda[i] * (Toy_LQ[,i] %*% t(1/(log2(1 + Toy_LQ[,i])))) )}

Toy_FLQ <-  c()
 for (i in 1:Region_Count){
  Toy_FLQ[[i]] <- (Toy_LQ[,i] %*% t(1/Toy_LQ[,i])) * Toy_lambda[i]
  rownames(Toy_FLQ[[i]]) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")
 }
names(Toy_FLQ) <- c("AllElse", "Brown", "Cook", "Dane")

print("Flegg Location Quotients")
Toy_FLQ 

Toy_FLQc <- bdiag(Toy_FLQ)

for (i in 1:nrow(Toy_FLQc)){
 for (j in 1:ncol(Toy_FLQc)){
  if (Toy_FLQc[i,j] > 1){
   Toy_FLQc[i,j] <- 1
  }
  else{
   Toy_FLQc[i,j] <- Toy_FLQc[i,j]
  }
 }
}

Toy_Dir_FLQ <- Toy_FLQc * Toy_Direct_mat_r
#Toy_Dir_FLQ %>% round(4)

############ Augmented Flegg Location Quotient

Toy_LQa <- c()
for (i in 1:length(Toy_LQ)){
 if (c(Toy_LQ)[i] > 1){
  Toy_LQa[i] <- log2(1 + Toy_LQ[i])
 }
 else{
  Toy_LQa[i] <- 1
 }
}

Toy_AFLQ <- diag(Toy_LQa) %*% bdiag(Toy_FLQ)

print("Augmented Flegg Location Quotients")
print("AllElse")
Toy_AFLQ[1:5,1:5] %>% round(4)
print("Brown")
Toy_AFLQ[6:10,6:10] %>% round(4)
print("Cook")
Toy_AFLQ[11:15,11:15] %>% round(4)
print("Dane")
Toy_AFLQ[16:20,16:20] %>% round(4)

Toy_Dir_AFLQ <- Toy_AFLQ * Toy_Direct_mat_r
#Toy_Dir_AFLQ %>% round(4)

```

Note Each Location Quotient is a different estimate of the regional supply proportion of good $i$, which in conjunction with the national-level Direct Requirements matrix, one can estimate an *intra*regional Direct Requirements or input matrix. 

However, to get back to the central question: How similar are the inputs of Chicago to the outputs of Madison? we may only need to look as far as the Location Quotients themselves. We have established that if $LQ_{i}^{r} > 1$, then industry $i$ is concentrated in region $r$ relative to the nation. As such we can expect all demand of good $i$ to be satisfied regionally and regional surplus will be exported to other less concentrated regions. Similarly, if $LQ_{i}^{r} < 1$, then industry $i$ is less concentrated in region $r$ relative to the nation. Thus if we look for industries in Madison where $LQ_{i}^{r} > 1$, **and** in Chicago where $LQ_{i}^{r} < 1$, we may use this matching to address the central question.  

For example, the Fiber and Grains simple LQ for Dane County (i.e., Madison) are both greater than 1. Similarly, only the Fiber simple LQ for Brown County (i.e., Green Bay), and only the Grain simple LQ for All Else is less than 1, making either only a partial partner. However, the Fiber and Grains simple LQ for Cook County (i.e., Chicago) are both less than 1, implying it is the strongest sink and best matched for using goods for which Madison is concentrated.  

*Gravity*

```{r  toyGravity}

Toy_Lat <- c(42.3, 44.49, 41.84, 43.07)
Toy_Lon <- c(-89.04, -88.03, -87.77, -89.39)
Toy_Dist_mat <- distm(cbind(Toy_Lon, Toy_Lat))/1000
colnames(Toy_Dist_mat) <- c("AllElse", "Brown", "Cook", "Dane")
rownames(Toy_Dist_mat) <- c("AllElse", "Brown", "Cook", "Dane")


Toy_Gravity_mat <- as.list(c())
for (i in 1:nrow(Toy_Xemp_mat)){
  Toy_Gravity_mat[[i]] <- (Toy_Xemp_mat[1,] %*% t(Toy_Xemp_mat[1,])) / sum(Toy_Xemp_mat[i,]) * (1/(Toy_Dist_mat)^2)
  rownames(Toy_Gravity_mat[[i]]) <- c("AllElse", "Brown", "Cook", "Dane")
}
names(Toy_Gravity_mat) <- c("Extract", "Fiber", "Grains", "Hogs", "Info")

print("Gravity Model Formulations - Interreginal Flows by Industry")
Toy_Gravity_mat 
```

Similarly, the Gravity approach represents interregional interindustry transactions.  


Note that strictly speaking, the $x^{r}_{j}$ terms throughout are specified as gross outputs of each sector in the region. In practice, however, these outputs are approximated through the use of employment, payroll, or number of establishments data, and they are not technically equivalent substitutes. Furthermore, the "supply pool" and "demand pool" total outputs called for in in the simple Gravity specification are even greater abstractions. First we assume $\alpha^{r}_{ij} = 1$ such that $a^{r}_{ij} = a^{n}_{ij}$, then assuming regional industry activity is equivalent to regional gross output $x^{r}_{j}$ and regional final demand is approximated by a single region model (i.e., $\mathbf{f^{r}} = \mathbf{(I} - \mathbf{A^{rr})x^{r}}$), which restricts by definition regional supply for good $i$ to be equivalent to regional demand for good $i$ (i.e., $x^{r \cdot}_{i} = x^{\cdot r}_{i}$). Note, no national accounting data are needed for this gravity approach. Only regional industry activity and the impedance function, $Q^{rs}_{i}$, which is given by $1/(d^{rs})^2$ where $d^{rs}$ is the great-circle distance between each region, are used.

*Interregional Models*

```{r  toyIR}


```



### Exposé

























