---
title: "Methodology and Data"
format:
  html:
    toc: true
    code-fold: true
    df-print: paged
    embed-resources: true
---

This notebook is a comprehensive overview of the project methodology.
More specific details may be available in other notebooks related to their respective sections.
Parts of the notebook are illustrated with examples using real or artificial data.
Each section points to relevant code in a notebook or a script.

```{r}
#| output: false
source("R/dataprep_bea_io.R", local = (bea_io <- new.env()))
source("R/dataprep_cbp.R", local = (cbp <- new.env()))
```


# Diagram

A flowchart covering all steps of the methodology, data inputs/outputs and relations between them.

[Google Drive Drawing](https://docs.google.com/drawings/d/1ek6pFUiimufYbH9idiZfNxvfeT7duJ_Xd6lzGHsgMCY/edit) (restricted access).


# Data

## CBP

Code: [pubdata/cbp](https://github.com/antonbabkin/pubdata/blob/main/nbs/cbp.md)

[CBP](https://www.census.gov/programs-surveys/cbp.html) (County Business Patterns) CBP is an annual series that provides subnational economic data by industry.
This series includes the number of establishments, employment during the week of March 12, first quarter payroll, and annual payroll.

- changes in suppression methodology

## CBP-EFSY

Code: [pubdata/cbp](https://github.com/antonbabkin/pubdata/blob/main/nbs/cbp.md), section EFSY.

Imputation of suppressed CBP employment in 1975-2016 by Eckert, Fort, Schott, and Yang.
[Website](https://fpeckert.me/cbp/)

Fabian Eckert, Teresa C. Fort, Peter K. Schott, and Natalie J. Yang. "Imputing Missing Values in the US Census Bureau's County Business Patterns." NBER Working Paper \#26632, 2021.

## InfoGroup

Establishment level proprietary dataset containing location, industry, employment and sales information for all businesses in the US.
Also known as [Data Axle](https://www.data-axle.com/our-data/business-data/) and RefUSA.

## BEA I-O tables

Code: [pubdata/bea_io](https://github.com/antonbabkin/pubdata/blob/main/nbs/bea_io.md)

- short overview
- link to [I-O Fundamentals] notebook
- 3 levels of BEA industry
- crosswalk to NAICS

```{r}
source("R/dataprep_bea_io.R", local = (bea_io <- new.env()))
is <- c("milk", "cheese", "pizza")
x <- matrix(1:9, 3, 3)
sup_tab <- bea_io$toy$sup_table(x)
colnames(sup_tab)[1:3] <- rownames(sup_tab)[1:3] <- is
c_mat <- bea_io$toy$c_matrix(sup_tab)
d_mat <- bea_io$toy$d_matrix(sup_tab)

sup_tab
c_mat
d_mat
```



## Census of Agriculture

Code: [pubdata/agcensus](https://github.com/antonbabkin/pubdata/blob/main/nbs/agcensus.md)

The [Census of Agriculture](https://www.nass.usda.gov/AgCensus/index.php) is a complete count of U.S. farms and ranches and the people who operate them.
The Census of Agriculture, taken only once every five years, looks at land use and ownership, operator characteristics, production practices, income and expenditures.


## Geographic shapefiles

Code: [pubdata/geography](https://github.com/antonbabkin/pubdata/blob/main/nbs/geography.md)

County cartographic boundary files from Census Bureau [Geography Program](https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html).
The cartographic boundary files are simplified representations of selected geographic areas from the Census Bureauâ€™s Master Address File/Topologically Integrated Geographic Encoding and Referencing (MAF/TIGER) System.

We currently use a single revision of county shape files (20??).
Recognizing that county shapes change over time, we have also built capability to use other years.



# Methodology

## CBP imputation

Code: 

- [pubdata/cbp](https://github.com/antonbabkin/pubdata/blob/main/nbs/cbp.md)
- [R/dataprep_cbp.R]()

We need county payroll by 6-digit NAICS industry.
It is often suppressed along with employment.

Up to 2016, we can use EFSY imputed employment and derive missing payroll as follows.

First, for every industry we calculate total suppressed employment (`emp_sup`) and annual payroll (`ap_sup`) by subtracting sum of unsuppressed county employment and payroll from national totals.
We then impute annual payroll in counties with EFSY employment as `ap_efsy(county) = emp_efsy(county) / emp_sup * ap_sup`.
Intuition of this calculation is that county share of suppressed payroll is proportional to it's share of suppressed employment.

The table below shows percentage of employment and payroll in raw and imputed CBP relative to national totals at different NAICS digit levels from 2012.


```{r}
#| tbl-cap: County sum as percentage of national total
df <- cbp$call_cbp(year = 2012, cbp_scale = "county", imputed = FALSE) |>
  select(place, naics, emp, ap) |>
  rename_with(\(x) paste0(x, "_raw"), c(emp, ap))
d <- cbp$call_cbp(year = 2012, cbp_scale = "county", imputed = TRUE) |>
  select(place, naics, emp, ap) |>
  rename_with(\(x) paste0(x, "_imp"), c(emp, ap))
df <- left_join(df, d, join_by(place, naics))

dsum <- df |>
  mutate(naics_dig = str_length(naics)) |>
  group_by(naics_dig) |>
  summarize(across(starts_with(c("emp", "ap")), sum))

d <- cbp$call_cbp(year = 2012, cbp_scale = "us", imputed = FALSE) |>
  filter(lfo == "-") |>
  select(naics, emp, ap) |>
  rename_with(\(x) paste0(x, "_nat"), !naics) |>
  mutate(naics_dig = str_length(naics)) |>
  group_by(naics_dig) |>
  summarize(across(c(emp_nat, ap_nat), sum))

left_join(dsum, d, join_by(naics_dig)) |>
  mutate(
    emp_raw_pct = emp_raw / emp_nat * 100,
    emp_imp_pct = emp_imp / emp_nat * 100,
    ap_raw_pct = ap_raw / ap_nat * 100,
    ap_imp_pct = ap_imp / ap_nat * 100
  ) |>
  select(naics_dig, ends_with("pct")) |>
  mutate(across(!naics_dig, \(x) round (x, 1)))


```



## InfoGroup county aggregates

Code: [rurec/infogroup_pq](https://github.com/antonbabkin/rurec/blob/main/nbs/infogroup_pq.qmd)

Establishments, employment and sales are calculated at county-NAICS level by summing individual establishment observations.


## NAICS-BEA reconciliation

Code:

- [pubdata/bea_io](https://github.com/antonbabkin/pubdata/blob/main/nbs/bea_io.md)
- [R/dataprep_bea_io.R]()

- economic activity data comes by NAICS, needs re-grouping to match BEA I-O tables
- a few industries can not be cleanly matched (entire construciton sector and a few smaller ones)

BEA industry classification has four nested levels: sector, summary, underlying summary and detail.
BEA-NAICS crosswalk is usually one-to-many mapping from detail to NAICS, where NAICS can be any level.
Exceptions are Construction (sector 23) and Housing (HS) and Other Real Estate (ORE).

Construction (sector code 23) does not map to NAICS below sector level.
We ignore all BEA subindustries and add an artificial industry "23" to every level (sector, summary, u.summary, detail) which maps to NAICS 23.

HS and ORE both map into NAICS 531.
We group them into a single summary industry called "531".

Sectors in sector-level Use and Supply tables are not always the same as sectors in the BEA-NAICS crosswalk.
To address this, we map correct sectors into NAICS as follows:

```{r}

d <- bea_io$ilevel_concord("sec")
d %>%
  filter(SECTOR %in% (d %>% group_by(SECTOR) %>% summarize(n = n()) %>% filter(n > 1) %>% pull(SECTOR)))
```

When industries are aggregated at summary level, we create a concordance that maps BEA to 3-digit NAICS.
Many-to-one cases that are created in the process "336" (3361MV, 3364OT) and  "541" (5411, 5412OP, 5415).


## AgCensus to BEA

Code: [rurec/ag_output](https://github.com/antonbabkin/rurec/blob/main/nbs/ag_output.md)

County sales of individual agricultural commodities (e.g. corn, wheat, hogs etc.) are groupped and summed to manually matched corresponding BEA detail-level industries.
Some county-commodity sales are suppressed in AgCensus, understating national totals, but the difference is minor.
"Other" categories (111900: "Other crop farming" and 112A00: "Animal production, except cattle and poultry and eggs") are calculated by subtracting the rest from county crop and animal totals.
This leads to overestimation of Others.


## Place output

Code: [R/place_output.R]()



### payroll -> output

When CBP is used as the source of information on economic activity, we need to estimate each industry's output.
This can be done by assuming that payroll share of output is constant across places.
Payroll share of output at the national level is calculated from the Use table.


```{r}
source("R/dataprep_bea_io.R", local = (bea_io <- new.env()))
is <- c("i_1", "i_2")
cs <- c("c_1", "c_2")
ps <- c("a", "b", "c")
use_tab <- bea_io$toy$use_table(matrix(c(9, 1, 2, 38), 2, 2), c(10, 20), c(15, 15))
rownames(use_tab)[4] <- "emp_comp"
sup_tab <- bea_io$toy$sup_table(matrix(c(16, 4, 10, 50), 2, 2), 0)
stopifnot(all(use_tab["i_tot_out", is] == sup_tab["i_tot_out", is]))
stopifnot(all(use_tab[cs, "c_tot_use"] == sup_tab[cs, "c_tot_sup"]))
c_mat <- bea_io$toy$c_matrix(sup_tab)

cbp_pay <- matrix(1:6, 2, 3, dimnames = list(industry = is, place = ps))
emp_comp_share <- use_tab["emp_comp", is] / use_tab["i_tot_out", is]
cbp_out <- diag(1 / emp_comp_share) %*% cbp_pay
# rescale output to match national total
county_share <- sweep(cbp_out, 1, rowSums(cbp_out), "/")
i_output <- sweep(county_share, 1, use_tab["i_tot_out", is], "*")
rownames(i_output) <- is
c_output <- c_mat %*% i_output 

use_tab
sup_tab
c_mat
cbp_pay
emp_comp_share
cbp_out
county_share
i_output
c_output
```


### combine farm and nonfarm

Economy partitioned into farm and non-farm sectors along industry dimension.

```{r}
source("R/dataprep_bea_io.R", local = (bea_io <- new.env()))
n <- c("farm", "nonfarm")
x <- matrix(c(9, 1, 2, 38), 2, 2, dimnames = list(n, n))
s <- bea_io$toy$sup_table(x, 0)
m <- bea_io$toy$c_matrix(s)
s
m
```

*Farm output*
Assumption: Ag Census covers producers in agricultural NAICS codes.
And we extract ag commodity sales from Ag Census.
Start with farm sales of BEA agricultural commodities at detail level by place, call it $y^{c,f}_{r}$.
Translate it to output by industry as $y^{i,f}_r = D y^{c,f}_{r}$. <- DOUBLE-CHECK THIS!


```{r}
# 2 places "a" and "b"
agcen_output <- c(a = 2, b = 5)
# every county's farm industry output is proportional to county's share in national ag commodity output
farm_i_tot_out <- s["i_tot_out", "farm"] * agcen_output / sum(agcen_output)
farm_c_out <- outer(m[, "farm"], farm_i_tot_out, "*")

farm_i_tot_out
farm_c_out
```


*Non-farm output*
Start with non-farm sales by NAICS from InfoGroup.
Convert to output by BEA industry, using BEA-NAICS concordance, call it $y^{i,nf}_{r}$.
Translate it to output by commodity as $y^{c,nf}_{r} = C y^{i,nf}_{r}$. <- DOUBLE-CHECK THIS!

```{r}
business_i_tot_out <- c(a = 40, b = 10)
# rescale to national total from BEA
nonfarm_i_tot_out <- business_i_tot_out / sum(business_i_tot_out) * s["i_tot_out", "nonfarm"]
# break industry output by commodity
nonfarm_c_out <- outer(m[, "nonfarm"], nonfarm_i_tot_out, "*")

business_i_tot_out
nonfarm_i_tot_out
nonfarm_c_out
```



*Total output*
$y^c_r = y^{c,f}_{r} + y^{c,nf}_{r}$

$y^i_r = y^{i,f}_{r} + y^{i,nf}_{r}$

```{r}
c_output <- farm_c_out + nonfarm_c_out
i_output <- data.frame(farm = farm_i_tot_out, nonfarm = nonfarm_i_tot_out) |> t()

rowSums(c_output) == s[c("farm", "nonfarm"), "c_tot_out"]
rowSums(i_output) == s["i_tot_out", c("farm", "nonfarm")]

c_output
i_output
```

## Industry <-> Commodity

Code: []()

Economic activity data in CBP and InfoGroup is reported by NAICS industry.
AgCensus sales are in the commodity space.

- why we need to tranlate
  - join CBP/InfoGroup with AgCensus
  - TODO
- how we translate
  - B/C/D matrix from Supply/Use TODO


## Supply from output

Code: []()

TODO


## Demand from output

Code: []()

TODO



## Gravity model

Code: []()

- trade flow from A to B is proportional to supply in A and demand in B, and inversely proportional to distance between A and B
- distance can be factored in using different functional forms (see Impedance)
- gravity model estimates are only a starting point and are further rescaled by RAS balancing algorithm
- no hard proof, but in limited testing we observe that relative ordering of trade flows between different locations is mostly preserved through RAS


## Impedance

Code: []()

- distance between counties from shapefiles
  - center to center
  - border to border
  - number of county "hops"
- impedance: more distant trade is more difficult
  - binary, Gaussian, truncated Gaussian, Queens, ...


## Pre-RAS adjustments

Code: []()

- RAS requires total demand = total supply in each industry/commodity
- our demand and supply estimates do not satisfy this because data comes from different sources and is processed under a set of assumptions
- hence we do ??? before feeding it into RAS


## RAS

Code: []()


- an algorithm of iteratively rescaling a matrix to match target row and column totals
- why it is called RAS
- we apply it to gravity model trade flow estimates to match our supply and demand estimates


## ECA

Code: []()

TODO






