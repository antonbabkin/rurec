---
title: "TestingRforIO"
author: "Austin Sandler"
date: "1/29/2022"
output:
  html_document:
    code_folding: "hide"
    code_download: true
    latex_engine: pdflatex
self_contained: false

---

```{r preamble, include = FALSE}
# When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

# Note: Procedure contains some idiosyncrasies in specific to initial data set naming convention. 
# Needs greater generalization in future.

#knitr::opts_chunk$set(eval=FALSE)
```
##  {.tabset}

This R Markdown document is a preliminary testing ground for Austin to become familiar with: 

1. The R Programming Language
1. The Input-Output Accounts Data
1. I/O Processing and Manipulation
1. Clear, Reproducible, Resilient, Scalable, and Data Agnostic Workflows
 
### RStartup

<details><summary>Possible Warnings</summary>
```{r packages and libraries}
# Download, Install, and Add R packages as necessary.

# List packages needed for this exercise
packages <- c("dplyr",
              "dlm",
              "DT",
              "fs", 
              "ggplot2", 
              "heatmaply", 
              "httr", 
              "ioanalysis",
              "knitr", 
              "logmult", 
              "magrittr", 
              "maptools", 
              "openxlsx", 
              "pander", 
              "png", 
              "purrr", 
              "raster", 
              "RColorBrewer", 
              "RCurl", 
              "readxl", 
              "reticulate",  
              "rlang", 
              "rmarkdown", 
              "scales", 
              "sf", 
              "sp", 
              "stringr", 
              "tidyverse", 
              "tidyr", 
              "tinytex",
              "tmap",
              "tools",
              "viridis",
              "xtable")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages], dependencies = TRUE)
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))

```
</details>

<details><summary>Possible Warnings</summary>
```{r directory}
# Create a location for project and downloaded files.

"GettingStartedIO" -> project_name 
"DataDirectory" -> data_directory_name 

setwd("..")
project_name  %>% dir.create()
setwd(project_name)

data_directory_name  %>% dir.create() 
DD <- getwd() %>% path(data_directory_name) 

```
</details>

`r paste0("Date: ",  Sys.Date())`

`r kable((.packages()), col.names = "R Packages")`

`r paste0("Project directory: ",  getwd())`

### IO Fundamentals

**Introduction**

I-O analysis,  or “inter-industry analysis,” is an economic tool that measures the relationships between various industries in the economy. The framework measures flows of products from each of the sectors (as a producer/seller) to each of the sectors (as a purchaser/buyer); these *interindustry* flows, or transactions (or intersectoral flows – the terms *industry* and *sector* are often used interchangeably in input–output analysis) are measured for a particular time period (usually a year) and in monetary terms.

**Fundamental Relationships**

Assume that the economy can be categorized into $n$ sectors and denote the total output (production) of sector $i$, $x_{i}$. In addition, there are sales to purchasers who are external or *exogenous* to the industrial sectors that constitute the producers in the economy e.g., households, government, and foreign trade. The demand of these external units, is referred to as *final demand*. Denote total final demand for sector $i$’s product, $f_{i}$. The accounting equation for the way sector $i$ distributes its product to other sectors and to final demand is given by:

\begin{equation}
x_{i} = z_{i1} + ... + z_{ij} + ... + z_{in} + f_{i} = \sum^{n}_{j=1} z_{ij} + f_{i}
\end{equation}

The $z_{ij}$ terms represent monetary transactions between pairs of sectors or *interindustry* sales (*intermediate* sales) by sector $i$  to all sectors $j$ (including itself, when $j = i$). This single equation represents sector $i$'s *output*. Similarly, there are output equations for each of the $n$ sectors in the economy. 

\begin{align*}
& x_{1} = z_{11} + ... + z_{1j} + ... + z_{1n} + f_{1} \\
& \vdots \\
& x_{i} = z_{i1} + ... + z_{ij} + ... + z_{in} + f_{i} \\
& \vdots \\
& x_{n} = z_{n1} + ... + z_{nj} + ... + z_{nn} + f_{n} \\
\end{align*}

The total output, interindustry sales, and final demand are given by:

\begin{equation}
\mathbf{x} = 
  \begin{bmatrix} 
  x_{1} \\ 
  \vdots \\ 
  x_{n} \\ 
  \end{bmatrix}, \; \;
\mathbf{Z} = 
  \begin{bmatrix}
    z_{11} & \dots & z_{1n}\\
    \vdots & \ddots & \vdots\\
    z_{n1} & \dots & z_{nn} \\
  \end{bmatrix}
, \; \text{  and } \; \;
\mathbf{f} = 
  \begin{bmatrix}
    f_{1} \\
    \vdots \\
    f_{n} \\
  \end{bmatrix}
\end{equation}

with the output equations for distribution of each sector’s sales summarized in matrix notation as:

$$\mathbf{x} = \mathbf{Zi} + \mathbf{f}$$

where $\mathbf{i}$ represent a column vector of 1’s. (Postmultiplication of a matrix by $\mathbf{i}$ creates a column vector whose elements are the row sums of the matrix. Similarly, premultiplication of a matrix by $\mathbf{i'}$ creates a row vector whose elements are the column sums of the matrix.)

The magnitudes of the interindustry flows can be recorded in a table, with sectors of origin (producers) listed on the left and the same sectors, now destinations (purchasers), listed across the top. From the column point of view, these show each sector’s inputs; from the row point of view the figures are each sector’s outputs; hence the name *input–output* table.

\begin{equation}
\begin{matrix}
&  & 1 & \dots & j & \dots & n \\ 
\hline
1 & & z_{11} & \dots & z_{1j} & \dots & z_{1n} \\ 
\vdots & & \vdots &  & \vdots &  & \vdots \\ 
i & & z_{i1} & \dots & z_{ij} & \dots & z_{in} \\ 
\vdots & & \vdots &  & \vdots &  & \vdots \\ 
n & & z_{n1} & \dots & z_{nj} & \dots & z_{nn} \\ 
\hline
\end{matrix}
\end{equation}

**Technical Coefficients**

In input–output studies, a fundamental assumption is that the interindustry flows from $i$ to $j$ depend entirely on the total output of sector $j$ for that same time period. The quantity of the output of sector $i$ absorbed by sector $j$ per unit of its total output is identified as $a_{ij}$ and called the *input coefficient* of sector $i$'s product in sector $j$.

$a_{ij} = z_{ij} / x_{j}$

A complete table of input coefficients is called a *structural matrix*, given by: $\mathbf{A} = \left[a_{ij}\right]$. This ratio is also called the *technical coefficient*; the terms *input–output coefficient* and *direct input coefficient* are also used. This ratio specifies the required amount of industry $i$'s commodity used to produce of one unit of industry $j$'s commodity, or how much of the $i$th commodity is used for the production of each unit of the $j$th commodity. Therefore the $n \times n$ matrix of technical coefficients can be represented as

$$\mathbf{A} = \mathbf{Z\hat{x}}^{-1}$$
where the “hat” over a vector denotes a diagonal matrix with the elements of the vector along the main diagonal i.e., 

\begin{equation}
\mathbf{\hat{x}^{-1}} = 
  \begin{bmatrix}
    \dfrac{1}{x_{1}} & \dots & 0\\
    \vdots & \ddots & \vdots\\
    0 & \dots & \dfrac{1}{x_{n}} \\
  \end{bmatrix}
\end{equation}

and the inverse must satisfy the usual requirement $(\mathbf{\hat{x}})(\mathbf{\hat{x}})^{-1} = \mathbf{I}$. 

Note input–output analysis requires that a sector use inputs in *fixed proportions*. The form of the production function inherent in input–output systems are isoquant “curves” that exhibit constant output. Such Leontief production functions require inputs in fixed proportions where a fixed amount of each input is required to produce one unit of output. Given a set of fixed technical coefficients, the accounting equations for the distribution of total output to other sectors and to final demand can be rewritten as 

\begin{align*}
& x_{1} = a_{11}x_{1} + ... + a_{1j}x_{i} + ... + a_{1n}x_{n} + f_{1} \\
& \vdots \\
& x_{i} = a_{i1}x_{1} + ... + a_{ij}x_{i} + ... + a_{in}x_{n} + f_{i} \\
& \vdots \\
& x_{n} = a_{n1}x_{1} + ... + a_{nj}x_{i} + ... + a_{nn}x_{n} + f_{n} \\
\end{align*}

Or in matrix notation as 

$$\mathbf{x} = \mathbf{Ax} + \mathbf{f}$$

These equations serve to make explicit the dependence of interindustry flows on the total outputs of each sector.

**IO Analysis**

In input–output *analysis*, one may pose the question: If the demands of the exogenous sectors were forecast to be some specific amounts next year, how much output from each of the sectors would be necessary to supply these final demands? From the point of view of this equation, the $f_{1} \dots f_{n}$ are known numbers, the $a_{ij}$ are known coefficients, and the $f_{1} \dots f_{n}$ are to be found. Rearranging to answer the question gives:

\begin{align*}
& \left(1- a_{11}\right)x_{1} - ... - a_{1j}x_{i} - ... - a_{1n}x_{n} = f_{1} \\
& \vdots \\
& a_{i1}x_{1} - ... - \left(1- a_{ij}\right)x_{i} - ... - a_{in}x_{n} = f_{i} \\
& \vdots \\
& a_{n1}x_{1} - ... - a_{nj}x_{i} - ... - \left(1- a_{nn}\right)x_{n} = f_{n} \\
\end{align*}

Or in matrix notation as 

$$\left(\mathbf{I} - \mathbf{A}\right)\mathbf{x} = \mathbf{f}$$
If $\left(\mathbf{I} - \mathbf{A}\right)$ is singular; that is, $\left(\mathbf{I} - \mathbf{A}\right)^{-1}$ exists, then the solution is given by 

$$\mathbf{x} = \left(\mathbf{I} - \mathbf{A}\right)^{-1}\mathbf{f} = \mathbf{Lf}$$
where $\left(\mathbf{I} - \mathbf{A}\right)^{-1} = \mathbf{L} = \left[l_{ij}\right]$ is known as the *Leontief inverse* or the *total requirements matrix*. Also recognizing that $\partial{x_{i}}/\partial{f_{j}} = l_{ij}$, this equation makes clear the dependence of gross output on the value of final demand.

The input–output model allows us to deal equally easily with *changes* in demands and outputs instead of *levels*. Assuming that technology is unchanged $\mathbf{A}^{base} = \mathbf{A}^{new} = \mathbf{A}$ and $\mathbf{L}^{base} = \mathbf{L}^{new} = \mathbf{L}$, so $\mathbf{x}^{base} = \mathbf{Lf}^{base}$ and $\mathbf{x}^{new} = \mathbf{Lf}^{new}$; letting $\Delta \mathbf{x} =  \mathbf{x}^{new} - \mathbf{x}^{base}$ and $\Delta \mathbf{f} =  \mathbf{f}^{new} - \mathbf{f}^{base}$ provides 

$$\Delta \mathbf{x} = \mathbf{Lf}^{new} - \mathbf{Lf}^{base} = \mathbf{L}\Delta\mathbf{f}$$

### IO Extentions

**Commodity-by-Industry Approach in Input–Output Models**

To explicitly account for “non-characteristic” production such as secondary products and by-products a “commodity–industry” format was developed. This format allows for the fact that an industry may produce more than one commodity. The underlying motivational observation is that industries use commodities to make commodities. It is commodities that are the inputs to industrial processes and that are used to satisfy final demands. An industry can be thought of as defined by its primary product (commodity) but some industries also produce additional commodities as secondary products. In order to highlight the differentiation between commodities and industries, assume that the commodity index, $i$, runs from 1 to $m$ and the industry index, $j$, runs from 1 to $n$.

This more realistic classification scheme  accounts for industrial production by commodity type rather than industry category. More recent studies, including the US National Tables complied for years since 1972, redefine all secondary production by establishing a set of “commodity-by-industry” accounts. In national accounting parlance, the commodity-by-industry interindustry transactions tables are also often referred to as *Make* or *Supply*, and *Use* tables. The core of modern I-O accounts consists of these two basic national-accounting tables.

**Use and Make Tables**

The Use table shows the uses of commodities by intermediate and final users. The rows in the Use table present the commodities or products, and the columns display the industries and final users that utilize them. The sum of the entries in a row is the output of that commodity. The columns show the products consumed by each industry and the three components of “value added”—compensation of employees, taxes on production and imports less subsidies, and gross operating surplus. Value added is the difference between an industry’s output and the cost of its intermediate inputs, and total value added is equal to GDP. The sum of the entries in a column is that industry’s output.

The “industries use commodities” part of the “industries use commodities to make commodities” observation is quantified in the *Use* matrix $\underset{(c \times i)}{\mathbf{U}} = [u_{ij}]$  where $u_{ij}$ is the value of purchases of commodity $i$ by industry $j$.

In conjunction with total industry output, $\mathbf{x}$, the parallel to the ordinary technical coefficient, $a_{ij}$, is 

$$b_{ij} = u_{ij}/x_{j}$$
Or in matrix  notation as 

$$\mathbf{B} = \mathbf{U\hat{x}}^{-1}$$

The Use matrix, $\mathbf{U}$ is constructed in dimensions of commodities (rows) by industries (columns) and, in matrix terms, the accounting identities are $\mathbf{q} = \mathbf{Ui} + \mathbf{e}$ and $\mathbf{x'} = \mathbf{i'U} + \mathbf{v'}$, where $\mathbf{q}$ is the vector of total commodity outputs, $\mathbf{e}$ is the vector of commodity final demands, $\mathbf{v'}$ is the (row) vector of total value-added inputs, $\mathbf{x}$, and is the vector of total industry outputs. The dimensions of $\mathbf{B}$ are therefore commodities-by-industries.

The Make table shows the production of commodities by industries, $\underset{(i \times c)}{\mathbf{V}} = [v_{ij}]$. The rows present the industries, and the columns display the commodities that the industries produce. Looking across a row, all the commodities produced by that industry are identified, and the sum of the entries is that industry’s output. Looking down a column, all the industries producing that commodity are identified, and the sum of the entries is the output of that commodity. Define the Make matrix (or *output*  matrix)  as $\mathbf{V}$, the row sums of which comprise the vector of total industry output, $\mathbf{x} = \mathbf{Vi}$, and the column sums of which comprise total commodity output, $\mathbf{q'} = \mathbf{i'V}$.

**Accounting Equations**

In the commodity–industry framework, both total industry output ($\mathbf{x}$) and total commodity output ($\mathbf{q}$) are accounted for. From the data in the Make matrix, total output of any industry is found by summing over all commodities produced by that industry. These totals are the *row* sums of $\mathbf{V}$,

\begin{equation}
x_{j} = v_{j1} + ... + v_{jm}
\end{equation}

Or in matrix  notation as 

$$\mathbf{x} = \mathbf{Vi}$$

total output of any commodity can be found by summing over all industries that produce the commodity. These totals are the column sums of $\mathbf{V}$.

\begin{equation}
q_{j} = v_{1j} + ... + v_{nj}
\end{equation}

Or in matrix  notation as 

$$\mathbf{q'} = \mathbf{i'V} \;  \; \text{ or } \;\;   \mathbf{q} = \mathbf{V'i}$$
Alternatively, from the Use matrix 

\begin{equation}
q_{j} = u_{j1} + ... + u_{jn} + e_{j}
\end{equation}

Or in matrix  notation as 

$$\mathbf{q} = \mathbf{Ui} + \mathbf{e}$$
The commodity–industry approach employs the *input* matrix, $\mathbf{B}$, from the Use table, where $\mathbf{U} = \mathbf{B\hat{x}}$ much in the same way as the input $\mathbf{A}$ matrix of *technical* coefficients, giving 

$$\mathbf{q} = \mathbf{Bx} + \mathbf{e}$$
akin to the ordinary $\mathbf{x} = \mathbf{Ax} + \mathbf{f}$ specification. However, unlike the ordinary specification one cannot generate a total requirements matrix (Leontief inverse) because of the presence of both commodity output ($\mathbf{q}$) on the left-hand side and industry output ($\mathbf{x}$) on the right-hand side.

One solution to this problem is to find an expression transforming industry outputs, $\mathbf{x}$, to commodity outputs, $\mathbf{q}$ – or, alternatively, to transform commodity outputs (and commodity final demand, $\mathbf{e}$) into industry terms. The data needed for such transformations are to be found in the Make matrix, whose row sums are industry outputs and whose column sums are commodity outputs.

**Technology and Total Requirement Matrices**

The direct requirements table shows the amount of a commodity that is required by an industry to produce a dollar of the industry’s output. Total requirements tables show the relationship between final uses and gross output. There are three variations of total requirements tables. The commodity-by-commodity total requirements table shows the production required, both directly and indirectly, of the commodity at the beginning of each row per dollar of delivery to final use of the commodity at the top of the column. The industry-by-commodity total requirements table shows the production required, both directly and indirectly, from the industry at the beginning of the row per dollar of delivery to final use of the commodity at the top of the column. The industry-by-industry total requirements table shows the production required, both directly and indirectly, from the industry at the beginning of the row per dollar of delivery to final use of the industry at the top of the column.

Define $d_{ij} = v_{ij}/q_{j}$, so that $d_{ij}$ denotes the fraction of total commodity $j$ output that was produced by industry $i$. Therefore a matrix of *commodity output proportions*, $\underset{(i \times c)}{\mathbf{D}} = [d_{ij}]$ is denoted as  

$$\mathbf{D} = \mathbf{V\hat{q}}^{-1}$$
$\mathbf{D}$ is often called the *market shares* matrix, and by definition, each column sum in $\mathbf{D}$ is unity.

Define $c_{ij} = v_{ij}/x_{i}$, so that $c_{ij}$ denotes the fraction of total industry $i$ output that is in the form of commodity $j$. These *industry output proportions*, $\underset{(c \times i)}{\mathbf{C}} = [c_{ij}]$ are denoted as  

$$\mathbf{C} = \mathbf{V'\hat{x}}^{-1}$$
$\mathbf{C}$ is often called the *product mix* matrix or the *commodity mix* matrix, and $\mathbf{V'}$ is refered to as the *supply* matrix. By definition, each column sum in $\mathbf{D}$ is unity. 

These output matrices offer two possible sources from which to generate the technology and total requirement matrices from the Make/Use tables. Let the *Direct Requirements Matrices*  be given by 

\begin{equation}
\underset{(i \times i)}{\mathbf{A}_{C}}  = \mathbf{C}^{-1}\mathbf{B} \; \text{, } \; \;
%
\underset{(i \times i)}{\mathbf{A}_{I}}  = \mathbf{D}\mathbf{B} \; \text{, } \; \;
%
\underset{(c \times c)}{\mathbf{A}_{C}}  = \mathbf{B}\mathbf{C}^{-1} \; \text{, and } \; \;
%
\underset{(c \times c)}{\mathbf{A}_{I}}  = \mathbf{B}\mathbf{D}
\end{equation}

**Commodity-Demand Driven Models**

Using $\mathbf{D}$, one can derive the *commodity-by-commodity total requirements matrix*, connecting commodity final demand to commodity output by:

$$\mathbf{q} = \left(\mathbf{I} - \mathbf{BD}\right)^{-1}\mathbf{e}$$
and the *industry-by-commodity total requirements matrix*, connecting commodity final demand to industry output by:

$$\mathbf{x} = [\mathbf{D}\left(\mathbf{I} - \mathbf{BD}\right)^{-1}]\mathbf{e}$$

Using $\mathbf{D}$, one can derive the *commodity-by-commodity total requirements matrix*, connecting commodity final demand to commodity output by:

$$\mathbf{q} = (\left(\mathbf{I} - \mathbf{BC}\right)^{-1})^{-1}\mathbf{e}$$
and the *industry-by-commodity total requirements matrix*, connecting commodity final demand to industry output by:

$$\mathbf{x} = [\mathbf{C}^{-1}(\mathbf{I} - \mathbf{BC}^{-1})^{-1}]\mathbf{e}$$

**Industry-Demand Driven Models**

It is also possible to derive total requirements matrices for *industry-demand driven* models, replacing $\mathbf{e}$ by an equivalent expression involving $\mathbf{f}$ in appropriate equations

Using $\mathbf{D}$, one can derive the *industry-by-industry total requirements matrix*, connecting industry final demand to industry output by:

$$\mathbf{q} = \left(\mathbf{I} - \mathbf{DB}\right)^{-1}\mathbf{f}$$
and the *industry-by-commodity total requirements matrix*, connecting commodity final demand to industry output by:

$$\mathbf{x} = [\mathbf{D}^{-1}\left(\mathbf{I} - \mathbf{DB}\right)^{-1}]\mathbf{f}$$

Using $\mathbf{D}$, one can derive the *commodity-by-commodity total requirements matrix*, connecting commodity final demand to commodity output by:

$$\mathbf{q} = ((\mathbf{I} - \mathbf{C}^{-1} \mathbf{B})^{-1})^{-1}\mathbf{f}$$
and the *industry-by-commodity total requirements matrix*, connecting commodity final demand to industry output by:

$$\mathbf{x} = [\mathbf{C}(\mathbf{I} - \mathbf{C}^{-1}\mathbf{B})^{-1}]\mathbf{f}$$

### Toy IO 

<details><summary>Possible Warnings</summary>
```{r downloadIO, cache=TRUE}
# Download and unzip data.

# User must specify URL with zipped I/O data

"https://apps.bea.gov/industry/iTables%20Static%20Files/AllTablesSUP.zip" -> ZipURL

local({
destfile <- ZipURL %>% basename() %>% file_path_sans_ext() %>% path(DD, .)
temp <- tempfile()
  if (!file.exists(destfile)) {
   download.file(url=ZipURL, destfile=temp, quiet=TRUE)
      if (file.info(temp)$size > 0){
        unzip(zipfile = temp, exdir = DD, overwrite = FALSE)
      }
  }
      unlink(temp)
      
  raw_io_files.R <<- destfile    
})
rm(ZipURL)



```
</details>

<details><summary>Possible Warnings</summary>
```{r importIOall}
# Import specific national accounting tables data into R. 

if (!exists("IO_tables")){
  temp <- raw_io_files.R %>% list.files(pattern="*.xlsx", full.names = TRUE)
  IO_tables <<- vector("list", length(temp))
  local({  
    for (i in 1:length(temp)){
       DataSheets <- temp[i] %>% excel_sheets()
       SheetList <- lapply(DataSheets, read.xlsx, xlsxFile=temp[i])
       names(SheetList) <- DataSheets
       IO_tables[[i]] <<- SheetList
       #names(IO_tables[i]) <<- temp[i] %>% basename() %>% file_path_sans_ext()
    }
  names(IO_tables) <<- temp %>% basename() %>% file_path_sans_ext()
  })
}

```
</details>

```{r subset}
# Subset and clean data for specific application. 

# User must specify desired year
# User must specify I/O dimensions

# names(SheetList)
"2012" -> SheetYear

# view(SheetList[[SheetYear]])


SheetList <- IO_tables$`Use_SUT_Framework_2007_2012_DET` 

5:404 -> SubDataRowDim
3:402 -> SubDataColDim
3 -> SubNameRow

SubSheetList <- SheetList[[SheetYear]][SubDataRowDim, SubDataColDim] %>%  as.matrix()
SubSheetList[SubSheetList == '...'| SubSheetList == 'N/A'] <- 0
SubSheetList[is.na(SubSheetList)] <- 0
NCol = dim(SubSheetList)[2]
SubSheetList %<>% as.numeric() %>% matrix(ncol = NCol)
ColNames <- SheetList[[SheetYear]][SubNameRow, SubDataColDim] %>% unlist() %>% unname()
dimnames(SubSheetList) <- list(NULL, ColNames)

rm(SubDataRowDim, SubDataColDim, SubNameRow, NCol)

```


The static Input-Output analysis, à la Wassily Leontief, poses the question: What level of output should each industry produce, such that it will satisfy the total demand of that industries output across all industries in an economy?

Simplifying assumptions:

1. Each industry produces only one homogeneous commodity.
1. Each industry uses a fixed input ratio.
1. Each industry exhibits constant returns to scale.

Note, to allow for the presence of final demand and primary inputs, in an open model, the sum of each column in $A$ must be less than 1. 


```{r simple open IO}
#A simple I/O analysis "by hand" presuming given national accounts are in the form of raw interindustry flows where one must generate a direct requirements matrices  (Technical Coefficients) and the total requirements matrix (Leontief inverse).
# Note the national IO table at present is a domestic flow specification as such the interindustry transactions table is no longer representative of a technological matrix. It rather represents the intra-national interindustry transactions, which are determined not only by technological factors, but also by trade factors. As a consequence in the domestic-flow table the balance between supply and demand is made considering only domestic production.

#User must specify subset dimensions for flow matrix
1:400 -> sub
#22 -> finuse
finuse <- dim(SubSheetList)[2]


D <- sub %>% length() %>% rep(0, .) %>% matrix()
#User to specify desired final demand values or delta demand values
5 -> D[17,1]

X <- SubSheetList[sub, sub]
Y <- SubSheetList[sub, finuse] %>% as.matrix()
A <- sweep(X, 2, Y, '/')
I <- nrow(X) %>% diag()

# Simple sufficient, but not necessary condition of sustainability. All must be TRUE.
all(colSums(A) < 1) %>% {paste0("Technology matrix structure passes sufficient test of sustainability: ", . )}

#Hawkins – Simon condition check. All must be TRUE.
PM = NULL
for(n in 2:nrow(I-A)){
  PM[1:n] = (det((I-A)[1:n,1:n]) > 0)
}
rm(n)

all(all(PM) & (diag(I-A) > 0) & (det(I-A) > 0)) %>% {paste0("Leontief matrix structure passes necessary and sufficient test of practibility and viability: ", . )}

B <- solve(I-A)
#B <- solve(I-A, tol = det(I-A))
X_Star <- B %*% D

```

```{r downloadCBP, cache=TRUE, include = FALSE}
# Download and unzip data.

# User must specify URL with CBP data
"https://www2.census.gov/programs-surveys/cbp/datasets/2019/cbp19co.zip" -> ZipURL

local({
destfile <- ZipURL %>% basename() %>%  file_path_sans_ext() %>% path(DD, ., ext = "txt")
temp <- tempfile()
  if (!file.exists(destfile)) {
   download.file(url=ZipURL, destfile=temp, quiet=TRUE)
      if (file.info(temp)$size > 0){
        unzip(zipfile = temp, exdir = DD, overwrite = FALSE)
      }
  }
      unlink(temp)
      
      raw_cbp_files.R <<- destfile  
}) 
rm(ZipURL)

```

```{r importCBP, cache=TRUE}
# Import  CBP data into R.

if (!exists("RegionalData")){
      RegionalData <-   raw_cbp_files.R %>% read.csv(header = TRUE)
      RegionalData$fipstate %<>% formatC(width = 2, format = "d", flag = "0")
      RegionalData$fipscty  %<>% formatC(width = 3, format = "d", flag = "0")
  }

```

### Regional IO

**Input–Output Models at the Regional Level**

There are at least two basic features of a regional economy that influence the characteristics of a regional input–output study.

First, although the national input–output coefficients are averages of data from individual producers in specific regions, the structure of production in a particular region may be identical to or it may differ markedly from the national input–output tables. Secondly, the smaller the economic area the more dependent that area’s economy is on trade with “outside” areas – transactions that cross the  region’s borders – both for sales of regional outputs and purchases of inputs needed for production. That is, exports will be relatively more important and a higher proportion of inputs will be imported from outside the region.

**Single-Region Models**

Let superscript $r$ designate “region $r$” in the same way that subscript $i$ denotes “sector $i$.” Thus, just as $X_{i}$ denotes the gross output of sector $i$, let $\mathbf{x^{r}} = [x^{r}_{i}]$ denote the vector of gross output of sectors in region $r$. Similarly, $\mathbf{f^{r}} = [f^{r}_{i}]$ represents the vector of exogenous demand for goods made in region $r$. 

The problem is that only a national technical coefficients matrix, $\mathbf{A}$, is available, but what is needed is a matrix showing inputs from firms *in the region* to production *in that region*. Denote this matrix by $\mathbf{A^{rr}} = [a^{rr}_{ij}]$, where $a^{rr}_{ij}$ is the amount of input from sector $i$ in $r$ per dollar’s worth of output of sector $j$ in $r$. For now assume that local producers use the same production recipes as the national coefficients table, meaning that the *technology* of production in each sector in region $r$ is the same as in the nation as a whole. To translate regional final demands into outputs of *regional* firms ($\mathbf{x^{r}}$), the national coefficients matrix must be modified to produce $\mathbf{A^{rr}}$ (*locally* produced goods in local production).


**Regional Supply Percentages**

One option is through the use of estimated *regional supply percentages*, one for each sector in the regional economy, designed to show the percentage of the total required outputs from each sector that could be expected to originate within the region. One way to estimate these percentages requires knowledge of (1) total regional output of each sector $i$, $x^{r}_{i}$, (2) exports of the product of each sector $i$ from region $r$, $e^{r}_{i}$, and (3) imports of good $i$ into region $r$, $m^{r}_{i}$. Then, one can form an expression for the *proportion* of the total amount of good $i$ available in region $r$ that was produced in $r$ (the *regional supply proportion* of good $i$). Denote this by $p^{r}_{i}$, where 

$$p^{r}_{i} = \frac{x^{r}_{i} - e^{r}_{i}}{x^{r}_{i} - e^{r}_{i} + m^{r}_{i}}$$

The numerator is the *locally produced* amount of $i$ that is available to purchasers in $r$; the denominator is the *total* amount of $i$ available in $r$, either produced locally or imported. (Thus $p^{r}_{i} \times 100$ is an estimate of the regional supply percentage for sector $i$ in region $r$ i.e., the percentage of good $i$ available in $r$ that was produced there.) Each element in the $i$th row of the national coefficients matrix could be multiplied by $p^{r}_{i}$ to generate a row of locally produced direct input coefficients of good $i$ to each local producer. Arranging these proportions in an $n$-element column vector, $\mathbf{p^{r}}$, then a working estimate of the regional matrix will be  $\mathbf{A^{rr} = \hat{p}^{r}A}$.

**Regional Coefficients**

In even very disaggregated national input–output tables sectors are made up of a variety of products. And firms within that sector, located in various regions of the country, will produce only a small number of those products. This illustrates the so-called *product-mix problem* in input–output; firms classified in the same sector actually produce different sets of products. The most straightforward way to avoid this problem is to survey firms in the region and construct what is called a survey-based regional input–output table. 

Let $z^{rr}_{ij}$ denote the dollar flow of goods from sector $i$ in region $r$ to sector $j$ in region $r$. Just as the order of subscripts is “from–to” with respect to sectors, the order of superscripts indicates “from–to” with respect to geographic locations. Given a complete set of data on $z^{rr}_{ij}$ for all $n$ sectors in the regional economy, and also data on gross outputs ($x^{r}_{j}$) of each sector in the region, a set of regional input coefficients could be derived as

$$a^{rr}_{ij} = \frac{z^{rr}_{ij}} {x^{r}_{j}}$$

Let $\underset{(n \times n)}{\mathbf{Z^{rr}}} = [z^{rr}_{ij}]$ and $\underset{(n \times 1)}{\mathbf{x^{r}}} = [x^{r}_{j}]$; then the regional input coefficients matrix is

$$\mathbf{A^{rr} = Z^{rr}\left(\hat{x}^{r}\right)^{-1} }$$
This matrix is approximated in the formula above by $\mathbf{\hat{p}^{r}A}$. Note that this specification utilizes *intra*regional information only.

**Many-Region Input–Output Models**

Single-region models, of the sort just described, represent one approach to modeling a regional economy in input–output terms. What they fail to do, however, is to recognize in an operational way the interconnections between regions. The one region of interest (region $r$) is “disconnected” from the rest of the country within which it is located, in the sense that its production recipes are reflected in an intraregional matrix, $\mathbf{A^{rr}}$. A fundamental problem in many-region input–output modeling is therefore estimation of transactions between regions. One approach, the *interregional* model, requires a complete (ideal) set of both intra- and interregional data. 

Let $z^{rr}_{ij}$ denote the dollar flow of goods from sector $i$ in region $r$ to sector $j$ in region $r$. For the two-region case, this means knowing $\mathbf{x^{r}} = [x^{r}_{i}]$, $\mathbf{x^{s}} = [x^{s}_{i}]$, $\mathbf{Z^{rr}} = [z^{rr}_{ij}]$, $\mathbf{Z^{ss}} = [z^{ss}_{ij}]$, $\mathbf{Z^{sr}} = [z^{sr}_{ij}]$ - recording transactions from sector $i$ in region $r$ to sector $j$ in region $s$ – $\mathbf{Z^{rs}} = [z^{rs}_{ij}]$ – in which flows from $s$ to $r$ are captured. It is the last two matrices that cause the most trouble. In practice, it is never the case that one has such detailed information, and the requirements grow quickly with the number of regions – a three-region model has six interregional matrices, a four-region model has 12, and so on.

Many alternative forms of many-region input–output models exist. Chronologically they are 

1) the interregional input–output model (IRIO) structure (often labeled the “Isard model”), 
2) the intranational input–output model (often referred to as a “balanced regional model”), 
3) the multiregional input–output model (MRIO) (often labeled a “Chenery–Moses model”), 
4) and a gravity-model approach of interregional flows in a connected region input–output model.

**Two-Region Interregional Input–Output Model**

Using $r$ and $s$, for the two regions, let there be three producing sectors (1, 2, 3) in region $r$ and two (1, 2) in region $s$. Suppose that one has information for region $r$ on both *intra*regional flows, $z^{rr}_{ij}$, and *inter*regional flows, $z^{sr}_{ij}$. There will be nine of the former and six of the latter. Suppose, that the same kind of information is available on the use of inputs by firms located in region $s$, $z^{rs}_{ij}$ and $z^{ss}_{ij}$. This complete table of intraregional and interregional data can be represented as

\begin{equation}
\mathbf{Z = \begin{bmatrix} 
      \mathbf{Z^{rr}} & \mathbf{Z^{rs}}\\ 
      \mathbf{Z^{sr}} & \mathbf{Z^{ss}} 
      \end{bmatrix} }
\end{equation}

The *columns* of $\mathbf{Z}$ represent purchases of locally produced inputs and inputs from the other region, by firms in both regions. The *rows* of $\mathbf{Z}$ represent sales by firms to each sector in their region and how much they sold to sectors in the other region. Note, the off-diagonal matrices of explicit *inter*regional linkages, $\mathbf{Z^{rs}}$ and $\mathbf{Z^{sr}}$, need not be square. The on-diagonal matrices of *intra*regional linkages, $\mathbf{Z^{rr}}$ and $\mathbf{Z^{ss}}$, are always square. The elements in $\mathbf{Z^{rs}}$ represent “exports” from region $r$ and simultaneously “imports” to region $s$, it is usual in regional input–output work to refer to these as *interregional trade* (or simply *trade*) flows and to use the terms *export* and *import* when dealing with foreign trade crossing national boundaries.

In the two-region interregional input–output model, the part of $f_{i}$ that represents sales of sector $i$’s product to the productive sectors in the other region (but not to consumers in the other region) is removed from the final-demand category and specified explicitly. For our two-region example, the output of sector 1 in region $r$ would be expressed as

$$x^{r}_{1} = z^{rr}_{11} + z^{rr}_{12} + z^{rr}_{13} + z^{rs}_{11} + z^{rs}_{12} + f^{r}_{1}$$

The regional input coefficients for region $r$ are the same as the single region *intra*regional specification

$$a^{rr}_{ij} = \frac{z^{rr}_{ij}} {x^{r}_{j}}$$

And similarly for region $s$ the regional input coefficients are

$$a^{ss}_{ij} = \frac{z^{ss}_{ij}} {x^{s}_{j}}$$

The *inter*regional trade coefficients are found in the same manner, where the denominators are gross outputs of sectors in the receiving region.

<p align="center">
$a^{rs}_{ij} = \frac{z^{rs}_{ij}} {x^{s}_{j}}$ and  $a^{sr}_{ij} = \frac{z^{sr}_{ij}} {x^{r}_{j}}$
</p>

Using these regional input and trade coefficients, the output of sector 1 in region $r$ can be re-expressed as

$$x^{r}_{1} = a^{rr}_{11}x^{r}_{1} + a^{rr}_{12}x^{r}_{2} + a^{rr}_{13}x^{r}_{3} + a^{rs}_{11}x^{s}_{1} + a^{rs}_{12}x^{s}_{2} + f^{r}_{1}$$
Note the regional input coefficients matrices are given by 

$$\mathbf{A^{rr}} = \mathbf{Z^{rr}\left(\hat{x}^{r}\right)^{-1}}$$

$$\mathbf{A^{rs}} = \mathbf{Z^{rs}\left(\hat{x}^{s}\right)^{-1}}$$

$$\mathbf{A^{sr}} = \mathbf{Z^{sr}\left(\hat{x}^{r}\right)^{-1}}$$

$$\mathbf{A^{ss}} = \mathbf{Z^{ss}\left(\hat{x}^{s}\right)^{-1}}$$


such that the final demand equation for each region can be expressed as 


$$\left(\mathbf{I} - \mathbf{A^{rr}}\right)\mathbf{x^{r}} - \mathbf{A^{rs}x^{s}} = \mathbf{f^{r}}$$

$$-\mathbf{A^{sr}x^{r}} + \left(\mathbf{I} - \mathbf{A^{ss}}\right)\mathbf{x^{s}} = \mathbf{f^{s}}$$

and the complete coefficients matrix for the two-region interregional model is defined as 

\begin{equation}
\mathbf{A = \begin{bmatrix} 
          \mathbf{A^{rr}} & \mathbf{A^{rs}}\\ 
          \mathbf{A^{sr}} & \mathbf{A^{ss}} 
          \end{bmatrix}}
\end{equation}
                              
Using an interregional model of this kind for analysis, not only is stability of the (intra)regional input coefficients necessary (the elements of $\mathbf{A^{rr}}$ and $\mathbf{A^{ss}}$), but also interregional input coefficients in  $\mathbf{A^{rs}}$ and $\mathbf{A^{sr}}$ are assumed unvarying over time. Thus both the structure of production in each region and interregional trade patterns are “frozen” in this model.

The advantage is that the model captures the magnitude of effects on each sector in each region; interregional linkages are made specific by sector in the supplying region and by sector in the receiving region. The accompanying disadvantages are the increased data needs and the necessary assumption of interregional trading relationship constancy. It is not always easy to accept the idea of constant input coefficients, in the national input–output model, and it is even more difficult to believe that imports of good $i$ per dollar’s worth of sector $j$ output in a specific region remain constant, no matter how much sector $j$’s output changes.

**Interregional Feedback**

Suppose that $\mathbf{x^{r}}$, $\mathbf{x^{s}}$, $\mathbf{f^{r}}$, and $\mathbf{f^{s}}$ are marginal "changes" $\Delta\mathbf{x^{r}}$, $\Delta\mathbf{x^{s}}$, $\Delta\mathbf{f^{r}}$, and $\Delta\mathbf{f^{s}}$. And for simplicity assume $\Delta\mathbf{f^{s}} = 0$ such that $\mathbf{x^{s}}$ is 

$$\mathbf{x^{s}} = \left(\mathbf{I} - \mathbf{A^{ss}}\right)^{-1} \mathbf{A^{sr}x^{r}}$$
Solving for final demand in region $r$ gives

$$\left(\mathbf{I} - \mathbf{A^{rr}}\right)\mathbf{x^{r}} - \mathbf{A^{rs}} \left(\mathbf{I} - \mathbf{A^{ss}}\right)^{-1} \mathbf{A^{sr}x^{r}} = \mathbf{f^{r}}$$
Note the same specification for the single region would be $\left(\mathbf{I} - \mathbf{A^{rr}}\right)\mathbf{x^{r}} = \mathbf{f^{r}}$. The "extra" second term $\mathbf{A^{rs}} \left(\mathbf{I} - \mathbf{A^{ss}}\right)^{-1} \mathbf{A^{sr}x^{r}}$ represents the added demands made on the output of region $r$ because of interregional trade linkages: an interregional feedback term. The strength and importance of interregional linkages depend not only on the elements of the interregional input coefficients matrices $\mathbf{-A^{rs}}$ and $\mathbf{A^{sr}}$, but also on the full set of regional input coefficients in the other region, as represented by $\left(\mathbf{I} - \mathbf{A^{ss}}\right)^{-1}$. It is these kinds of spatial linkages that distinguish complete interregional models from single-region models. In terms of outputs, the single- and two region models will generate $\mathbf{x^{r}} = \left(\mathbf{I} - \mathbf{A^{rr}}\right)\mathbf{f^{r}}$ and $\mathbf{x^{r}} = \left(\mathbf{I} - \mathbf{A^{rr}} - \mathbf{A^{rs}L^{ss}A^{sr}}\right)\mathbf{f^{r}}$, respectively. Clearly, the interregional input–output model requires a large amount of detailed data. For this reason, there have been few real-world applications.

**MRIO Model  - The Multiregional Approach to IRIO**

Generally it is impossible to implement IRIO for many regions and/or sectors because of the enormous amounts of data that it requires. One attempt toward operationalization through simplification is the “Chenery–Moses” or MRIO approach. 

The MRIO model uses a regional *technical* coefficients matrix, $\mathbf{A^{r}}$, in place of the regional *input* coefficients matrix, $\mathbf{A^{rr}}$. These regional technical coefficients, $a^{r}_{ij}$, can be produced from responses to the question “How much sector $i$ product did you buy last year in making your output?” Information regarding the region of origin of a given input is ignored; one only needs information on the dollars’ worth of input from sector $i$ used by sector $j$ in region $r$. These transactions are denoted by $z^{\cdot r}_{ij}$, where the dot indicates that all possible geographical locations for sector $i$ are lumped together. These coefficients are defined as $a^{r}_{ij} = \frac{z^{\cdot r}_{ij}}{x^{r}_{j}}$ and $\mathbf{A^{r}} = \left[ a^{r}_{ij} \right]$. 

In practice, when actual regional data on technology are not available, estimates of regional technical coefficients matrices are made using what is known as the *product-mix approach*. The basic assumption is that input requirements per unit of output are constant from region to region at a very fine level of industrial classification, but that an important distinguishing characteristic of production at the regional level is the composition of sector outputs, when one is dealing with more aggregate sectors.

**The Interregional Tables**

The interconnections among regions in the multiregional input–output model are captured in an entirely different way from the interregional input–output framework. Trade flows in the multiregional model are estimated by sector, again to take advantage of the kinds of data likely to be available. For sector $i$, let $z^{rs}_{i}$ denote the dollar flow of good $i$ from region $r$ to region $s$, irrespective of the sector of destination in the receiving region. These flows will include shipments to the producing sectors in region $s$ as well as to final demand in $s$.

\begin{equation}
\begin{matrix}
&  & 1 & 2 & \dots & s & \dots & p \\ 
\hline
1 & & z^{11}_{i} & z^{12}_{i} & \dots & z^{1s}_{i} & \dots & z^{1p}_{i} \\ 
2 & & z^{21}_{i} & z^{22}_{i} & \dots & z^{2s}_{i} & \dots & z^{2p}_{i} \\ 
\vdots & & \vdots & \vdots & \dots & \vdots & \dots & \vdots \\ 
r & & z^{r1}_{i} & z^{r2}_{i} & \dots & z^{rs}_{i} & \dots & z^{rp}_{i} \\ 
\vdots & & \vdots & \vdots &  & \vdots &   & \vdots \\ 
p & & z^{p1}_{i} & z^{p2}_{i} & \dots & z^{ps}_{i} & \dots & z^{pp}_{i} \\ 
Total & & T^{1}_{i} & T^{2}_{i} & \dots & T^{s}_{i} & \dots & T^{p}_{i} \\ 
\hline
\end{matrix}
\end{equation}

Note that each of the column sums in this table represents the total shipments of good $i$ into that region from all of the regions in the model; this total, for column $s$, is denoted in the table for good $i$ by $T^{s}_{i}$:

$$T^{s}_{i} = z^{1s}_{i} + z^{2s}_{i} + \dots + z^{rs}_{i} + \dots + z^{ps}_{i}$$

If each element in column $s$ is divided by this total, one has coefficients denoting the proportion of all of good $i$ used in $s$ that comes from each region $r \; \left(r = 1, \dots, p \right)$. These proportions are denoted $c^{rs}_{i}$:

$$c^{rs}_{i} = \frac{z^{rs}_{i}}{T^{s}_{i}}$$

For each possible origin destination pair of regions, denote the n-element column vector:

\begin{equation}
\mathbf{c^{rs}} = 
  \begin{bmatrix} 
  c^{rs}_{1} \\ 
  \vdots \\ 
  c^{rs}_{n} \\ 
  \end{bmatrix}
\end{equation}

These elements show, for region $s$, the proportion of the total amount of each good used  in $s$ that comes from region $r$. Note that there will be *intra*regional matrices in this set. For  example, $\mathbf{\hat{c}^{ss}}$ whose elements, $c^{ss}_{i} = \frac{z^{ss}_{i}}{T^{s}_{i}}$, indicate the proportion of good $i$ used in region $s$ that came from within region $s$.

**The Multiregional Model**

Consider a small two-sector, two-region example, where

\begin{equation}
\mathbf{A^{r}} = 
  \begin{bmatrix} 
  a^{r}_{11} & a^{r}_{11} \\ 
  a^{r}_{21} & a^{r}_{22} \\ 
  \end{bmatrix}, \; \;
  \mathbf{A^{s}} = 
  \begin{bmatrix} 
  a^{s}_{11} & a^{s}_{11} \\ 
  a^{s}_{21} & a^{s}_{22} \\ 
  \end{bmatrix}
\end{equation}

\begin{equation}
\mathbf{\hat{c}^{rs}} = 
  \begin{bmatrix} 
  c^{rs}_{1} & 0 \\ 
  0 & c^{rs}_{2} \\ 
  \end{bmatrix}, \; \;
  \mathbf{\hat{c}^{ss}} = 
  \begin{bmatrix} 
  c^{ss}_{1} & 0 \\ 
  0 & c^{ss}_{2} \\
  \end{bmatrix}
\end{equation}

Then the multiregional input–output model uses the matrix

\begin{equation}
\mathbf{\hat{c}^{rs}A^{s}} = 
  \begin{bmatrix} 
  c^{rs}_{1}a^{s}_{11} & c^{rs}_{1}a^{s}_{11} \\ 
  c^{rs}_{2}a^{s}_{21} & c^{rs}_{2}a^{s}_{22} \\ 
  \end{bmatrix}
\end{equation}  

as an estimate of $\mathbf{A^{rs}}$ in the interregional input–output model. Similarly,

\begin{equation}
\mathbf{\hat{c}^{ss}A^{s}} = 
  \begin{bmatrix} 
  c^{ss}_{1}a^{s}_{11} & c^{ss}_{1}a^{s}_{11} \\ 
  c^{ss}_{2}a^{s}_{21} & c^{ss}_{2}a^{s}_{22} \\ 
  \end{bmatrix}
\end{equation}

as an estimate of $\mathbf{A^{ss}}$ in the interregional input–output model. Therefore the multiregional input–output model embodies the same assumptions as regional models with estimated supply percentages.

The multiregional input–output counterpart to the interregional model is therefore

$$\left(\mathbf{I} - \mathbf{\hat{c}^{rr}A^{r}}\right)\mathbf{x^{r}} - \mathbf{\hat{c}^{rs}A^{s}x^{s}} = \mathbf{\hat{c}^{rr}f^{r}} + \mathbf{\hat{c}^{rs}f^{s}}$$

$$ -\mathbf{\hat{c}^{sr}A^{r}x^{r}} \left(\mathbf{I} - \mathbf{\hat{c}^{ss}A^{s}}\right)\mathbf{x^{s}} = \mathbf{\hat{c}^{rs}f^{r}} + \mathbf{\hat{c}^{ss}f^{s}}$$


Or in matrix notation as 

$$\left(\mathbf{I} - \mathbf{CA}\right)\mathbf{x} = \mathbf{Cf}$$

Let  

\begin{equation}
\mathbf{A} = 
  \begin{bmatrix} 
    \mathbf{A^{r}} & 0 \\ 
    0 & \mathbf{A^{s}} \\ 
  \end{bmatrix}, \; \;
\mathbf{C} = 
  \begin{bmatrix} 
    \mathbf{\hat{c}^{rr}} & \mathbf{\hat{c}^{rs}} \\ 
    \mathbf{\hat{c}^{sr}} & \mathbf{\hat{c}^{ss}} \\ 
    \end{bmatrix}, \; \;
  \mathbf{x} = 
    \begin{bmatrix} 
      \mathbf{x^{r}} \\ 
      \mathbf{x^{s}} \\ 
    \end{bmatrix}, \;  \text{ and} \; \;
  \mathbf{f} = 
    \begin{bmatrix} 
      \mathbf{f^{r}} \\ 
      \mathbf{f^{s}} \\ 
  \end{bmatrix}
\end{equation}

Giving the solution as 

$$\mathbf{x} = \left(\mathbf{I} - \mathbf{CA}\right)^{-1} \mathbf{Cf}$$

Similarly, when there are $p$ regions, let

\begin{equation}
\mathbf{A} = 
  \begin{bmatrix} 
      \mathbf{A^{1}} & 0 & \dots &  0 \\ 
      0 & \mathbf{A^{2}} & \dots &  0 \\ 
      \vdots & \vdots & \ddots &  \vdots \\
      0 & 0 & \dots & \mathbf{A^{p}} \\ 
  \end{bmatrix}, \; \;
\mathbf{c} = 
  \begin{bmatrix} 
      \mathbf{\hat{c}^{11}} & \dots &  \mathbf{\hat{c}^{1p}} \\ 
      \mathbf{\hat{c}^{21}} & \dots &  \mathbf{\hat{c}^{2p}} \\ 
      \vdots & \ddots &  \vdots \\
      \mathbf{\hat{c}^{p1}} & \dots &  \mathbf{\hat{c}^{pp}} \\ 
  \end{bmatrix}, \; \;
  \mathbf{x} = 
    \begin{bmatrix} 
      \mathbf{x^{1}} \\ 
      \mathbf{x^{2}} \\ 
      \vdots \\
      \mathbf{x^{p}} \\ 
    \end{bmatrix}, \; \text{ and} \; \;
  \mathbf{f} = 
    \begin{bmatrix} 
      \mathbf{f^{1}} \\ 
      \mathbf{f^{2}} \\ 
      \vdots \\
      \mathbf{f^{p}} \\ 
  \end{bmatrix}
\end{equation}

In this way $\left(\mathbf{I} - \mathbf{CA}\right)\mathbf{x} = \mathbf{Cf}$ and $\mathbf{x} = \left(\mathbf{I} - \mathbf{CA}\right)^{-1} \mathbf{Cf}$ still still represents the system and its solution.

From the general statement of the multiregional input–output model both intermediate demands, $\mathbf{Ax}$, and final demand,  $\mathbf{f}$, are premultiplied by the matrix $\mathbf{C}$; this distributes these demands to supplying sectors across regions. Thus $\mathbf{f^{r}}$ and $\mathbf{f^{s}}$ represent demands by (shipments to) the final-demand  sectors in regions $r$ and $s$ respectively, not final demands for the products of regions $r$ and $s$ (as in the interregional input–output model).

### Regional IO Extentions

**Nonsurvey methods**

Regional input–output tables share with their national counterparts the problem of becoming outdated with the simple passage of time. But smaller geographic scale introduces other problems. When one is concerned with models in which two or more regions are connected (or a single region and the rest of the country) shipments out of and into the regions assume a much more important role – the former providing inputs to production and the latter representing markets for outputs. One procedure for obtaining this estimate for sector $i$ was to find the ratio of total regional output, less exports, of sector $i$, to the total output, less exports, plus imports, of sector $i$ given by

$$p^{r}_{i} = \frac{x^{r}_{i} - e^{r}_{i}}{x^{r}_{i} - e^{r}_{i} + m^{r}_{i}}$$

Thus, when none of good $i$ is imported, $p^{r}_{i} = 1$, and the assumption is that all of the region’s needs for $i$ can be supplied internally. The regional input coefficient matrix is derived from $\mathbf{A^{rr} = \hat{p}A^{n}}$ where $\mathbf{p} = [p^{r}_{i}]$ and $\mathbf{A^{n}}$ is the national technical coefficients matrix.

A regional input coefficient, $a^{rr}_{ij}$, is defined as the difference between a regional technical coefficient, $a^{r}_{ij}$, and a regional import coefficient, $a^{sr}_{ij}$, where $s$ indicates “outside of $r$.” If a complete set of intra- and interregional data is available, then the $a^{rr}_{ij}$’s (and $a^{sr}_{ij}$’s) are observable directly. However, if one is trying to estimate $a^{rr}_{ij}$ from national data, as is the case, the estimation problem can be posed in the following way: 
(1) estimate a regional technical coefficient, $a^{r}_{ij}$, from the corresponding national coefficient, $a^{r}_{ij}$, and then 
(2) estimate the regional input coefficient, $a^{rr}_{ij}$, as some proportion of the regional technical coefficient; that is, $a^{rr}_{ij} = p^{r}_{ij}a^{r}_{ij}$ (where  $0 \leq p^{r}_{ij} \leq 1$). 

Instead of estimating, $a^{r}_{ij}$ and $a^{sr}_{ij}$ one estimates $a^{r}_{ij}$ and $p^{r}_{ij}$. The two steps in this procedure for estimating $a^{rr}_{ij}$ from $a^{n}_{ij}$ would therefore be: 

(1) find $\alpha^{r}_{ij} \geq 0$ such that 

$$a^{r}_{ij} = (\alpha^{r}_{ij}) (a^{n}_{ij})$$

and 

(2) find $\beta^{r}_{ij}$ ($0 \leq \beta^{r}_{ij} \leq 1$) such that 

$$a^{rr}_{ij} = (\beta^{r}_{ij}) (a^{r}_{ij})$$. 

If one can find $\alpha^{r}_{ij}$ and $\beta^{r}_{ij}$ for every $i$ and $j$, this is equivalent to finding 

$$a^{rr}_{ij} = (\gamma^{r}_{ij}) (a^{n}_{ij})$$ where 

$$\gamma^{r}_{ij} = (\alpha^{r}_{ij}) (\beta^{r}_{ij})$$

However, in general there is not enough regional information to find $\alpha^{r}_{ij}$ and $\beta^{r}_{ij}$. 

Assuming region $r$ and national production recipes are identical, $a^{r}_{ij} \equiv a^{n}_{ij}$, results in $\alpha^{r}_{ij} = 1$ for all $i$ and $j$. This assumption overlooks probable regional differences in product mixes within a sector. Or assuming each regional purchaser, $j$, of input $i$ buys the same proportion of those inputs from within the region, results in $\beta^{r}_{ij} = p^{r}_{i}$ for all $i$. In the absence of specific survey information, it is customary, at least initially, to invoke one or more these assumptions. A number of nonsurvey techniques exist for regionalization of national coefficients – through adjustments based only on published information on regional employment, income, or output by industry.

**Simple Location Quotients**

Let $x^{r}_{i}$ and $x^{r}$ denote gross output of sector $i$ in region $r$ and total output of all sectors in region $r$, respectively, and let $x^{n}_{i}$ and $x^{n}$ denote these totals at the national level. Then the simple location quotient for sector $i$ in region $r$ is defined as:

$$LQ^{r}_{i} = \left( \frac{x^{r}_{i} / x^{r}} {x^{n}_{i} / x^{n}} \right) = \left( \frac{x^{r}_{i} / x^{n}_{i}} {x^{r} / x^{n}} \right)$$

The simple location quotient is a measure of the ability of regional industry $i$ to supply the demands placed upon it by other industries (and by final demand) in that region. Also denoted as $SLQ_{i}$. 

If industry $i$ is less concentrated in the region than in the nation ($LQ^{r}_{i} < 1$), it is seen as less capable of satisfying regional demand for its output, and its regional direct input coefficients, $a^{rr}_{ij}$ ($j = 1, \dots, n$) are created by reducing the national coefficients, $a^{n}_{ij}$, by multiplying them by $LQ^{r}_{i}$. However, if industry $i$ is more highly concentrated in the region than in the nation ($LQ^{r}_{i} > 1$), then it is assumed that the national input coefficients from industry $i$, $a^{n}_{ij}$ ($j = 1, \dots, n$) apply to the region, and the regional “surplus” produced by $i$ will be exported to the rest of the nation. If a national sector is not present in the region ($LQ^{r}_{i} = 0$), that row and column are simply deleted from $\mathbf{A^{n}}$. Thus, for each row $i$ of an estimated regional table,

$$
a^{rr}_{ij} = \left\{ 
\begin{align*}
(LQ^{r}_{i})a^{n}_{ij} \space\space \text{if} \space\space LQ^{r}_{i} < 1 \\
a^{n}_{ij} \space\space \text{if} \space\space LQ^{r}_{i} \geq 1
\end{align*}
\right\}
$$

This procedure is equivalent to assuming $\alpha^{r}_{ij} = 1$ for all $i$ and $j$ and letting $\beta^{r}_{ij} = LQ^{r}_{i}$ when $LQ^{r}_{i} < 1$ and $\beta^{r}_{ij} = 1$  when $LQ^{r}_{i} \geq  1$. Note ttha this approach does have a distinct asymmetry. When a sector is import-oriented ($LQ^{r}_{i} < 1$), the modification of the national coefficient varies with the strength of the import orientation $a^{rr}_{ij} = (LQ^{r}_{i})a^{n}_{ij}$, but when a sector is export-oriented ($LQ^{r}_{i} > 1$), the strength of that orientation is not reflected in the modification $a^{rr}_{ij} = (1)a^{n}_{ij}$.

A complication may arise if the estimates of regional industry output that are obtained using *LQ* coefficients exceed actual output for some industries. In this event, coefficients developed by this method have often been “balanced” to ensure that they do not overestimate the regional output of each sector. If estimated coefficients generate a regional output for sector $i$, $(\tilde{x}_{i})$ that is too large (meaning $\tilde{x}^{r}_{i} > x^{r}_{i}$ ), then the row-$i$ estimates, $a^{rr}_{ij}$ (for all $j$), should be uniformly  reduced – multiplied by ($x^{r}_{i} / \tilde{x}^{r}_{i}$).

For example, estimated sector $i$ output on the basis of actual regional industry outputs, and the *LQ*-estimated regional input coefficients for sector $i$

$$\tilde{x}^{r}_{i} = \sum_{j}a^{rr}_{ij}x^{r}_{j} + \sum_{f}c^{rr}_{if}f^{r}_{f}$$

where

$\tilde{x}^{r}_{i}$ is estimated regional output of sector $i$, 

$f^{r}_{f}$ is total regional final demand of final-demand sector $f$, and 

$c^{rr}_{if}$ is estimated regional final-demand purchase coefficient of regional final-demand sector $f$ from industry $i$.

The $c^{rr}_{if}$ elements reflect purchases of regionally produced output $i$ by regional final-demand sector $f$. These
estimates are found in much the same manner as were the $a^{rr}_{ij}$; that is, using national data and the region-specific location quotients. In particular,

$$
c^{rr}_{if} = \left\{ 
\begin{align*}
(LQ^{r}_{i})c^{n}_{if} \space\space \text{if} \space\space LQ^{r}_{i} < 1 \\
c^{n}_{if} \space\space \text{if} \space\space LQ^{r}_{i} \geq 1
\end{align*}
\right\}
$$

where 

$$c^{n}_{if} = f_{if} / f_{f}$$

$f_{if}$ is national sales of industry $i$ to final-demand sector $f$, and

$f_{f}$ is total national purchases of final-demand sector $f$.

Thus, when $LQ^{r}_{i} \geq 1$, it is assumed that purchases of good $i$ by final-demand sector $f$ are the same proportion of total sector $f$ purchases in the region as in the nation. When $ LQ^{r}_{i} < 1$, then the national proportion is modified downward.

The next step in the balancing procedure is to calculate the ratio of estimated to actual
regional output; denote this by $Z^{r}_{i}$. Then

$$Z^{r}_{i} = x^{r}_{i} / \tilde{x}^{r}_{i}$$

Each row of estimated regional input coefficients for which $Z^{r}_{i}$ is less than one is adjusted downward. That is, adjusted (“balanced”) regional input coefficients are estimated as

$$
\bar{a}^{rr}_{ij} = \left\{ 
\begin{align*}
Z^{r}_{i}a^{rr}_{ij} \space\space \text{if} \space\space Z^{r}_{i} < 1 \\
a^{rr}_{ij} \space\space \text{if} \space\space Z^{r}_{i} \geq 1
\end{align*}
\right\}
$$

Note, in this *LQ* and all other quotient approaches, $\alpha^{r}_{ij} = 1$ is assumed. And with high disaggregation, the assumption of constant (national) technology across regions may be reasonable.

**Purchases-Only Location Quotients**

The purchases-only location quotient (*PLQ*) for sector $i$ in region $r$ relates regional to national ability to supply sector $i$ inputs, but only to those sectors that use $i$ as an input. That is,

$$PLQ^{r}_{i} = \left( \frac{x^{r}_{i} / x^{*r}} {x^{n}_{i} / x^{*n}} \right) $$

where $x^{r}_{i}$ and $x^{n}_{i}$ are regional and national output of good $i$, as before, and where $x^{*r}$ and $x^{*n}$ are total regional and national output of only those sectors that use $i$ as an input. If input $i$ is not used by sector $k$, then the size of sector $k$’s output is not relevant in determining whether or not the region can supply all of its needs for input $i$.

**Cross-Industry Quotients**

Another variant is the cross-industry quotient (*CIQ*). This allows for differing modifiers within a given row of the national matrix; that is, it allows for differing cell-by-cell adjustments within $\mathbf{A^{n}}$ rather than uniform adjustments along each row. Specifically, 

$$CIQ^{r}_{ij} = \left( \frac{x^{r}_{i} / x^{n}_{i}} {x^{r}_{j} / x^{n}_{j}} \right)$$

Then 

$$
a^{rr}_{ij} = \left\{ 
\begin{align*}
(CIQ^{r}_{ij})a^{n}_{ij} \space\space \text{if} \space\space CIQ^{r}_{ij} < 1 \\
a^{n}_{ij} \space\space \text{if} \space\space CIQ^{r}_{ij} \geq 1
\end{align*}
\right\}
$$ 

If the output of regional sector $i$ relative to the national output of $i$ is larger than the output of regional sector $j$ relative to the national output of  sector $j$ ($CIQ^{r}_{ij} > 1$), then all of $j$’s needs of input $i$ can be supplied from within the region. Similarly, if sector $i$ at the regional level is relatively smaller than sector $j$ at the regional level ($CIQ^{r}_{ij} < 1$), then it is assumed that some of $j$’s needs for $i$ inputs will have to be imported. Note that $CIQ^{r}_{ij} = LQ^{r}_{i}/LQ^{r}_{j}$ and that $CIQ^{r}_{ij} = 1$ (along the main diagonal, when $i=j$).


**The Semilogarithmic Quotient**

Since the *LQ* approach will never increase a national coefficient (they are either left unchanged or made smaller), this procedure
is also called *reducing* the national coefficients table. This $a^{rr}_{ij} \leq a^{n}_{ij}$ characteristic of the *LQ* approach has also been called into question. A producer in sector $j$ might use relatively fewer imported inputs than is reflected in the national coefficients for sector $j$, and thus at least some regionally supplied inputs could be larger, per unit of output $j$ in that region than in the nation as a whole. And in general, if the national coefficient is an average of observed regional coefficients, then some coefficients in some regions should be expected to be above average while others in other regions would necessarily be below average.

Let a "semilogarithmic quotient (*SLQ*)” be defined as

$$SLQ^{r}_{ij} = LQ^{r}_{i}/ \log_{2} (1 + LQ^{r}_{j})$$
Or alternatively as

$$SLQ^{r}_{ij} = [(x^{r}_{i} / x^{n}_{i}) \div (x^{r} / x^{n})]/ \log_{2}\{1 + [(x^{r}_{j} / x^{n}_{j}) \div (x^{r} / x^{n})] \}$$
along with relative sizes of both industries, $i$ and $j$, this includes the regional size component in both numerator and denominator but not in such a way that the terms cancel out.

**Flegg**

The Flegg Location Quotient measure is generated by modifying the $CIQ^{r}_{ij}$ to incorporate an additional measure of the relative size of the region, 

$$FLQ^{r}_{ij} = (\lambda)CIQ^{r}_{ij}$$
where $\lambda = \{\log_{2}[1 + (x^{r}_{E} / x^{n}_{E})]\}^{\delta}$, $0 \leq \delta < 1$. Then

$$
a^{rr}_{ij} = \left\{ 
\begin{align*}
(FLQ^{r}_{ij})a^{n}_{ij} \space\space \text{if} \space\space FLQ^{r}_{ij} < 1 \\
a^{n}_{ij} \space\space \text{if} \space\space FLQ^{r}_{ij} \geq 1
\end{align*}
\right\}
$$

Flegg uses employment rather than output as the relevant measures of regional and national activity; these are $x^{r}_{E}$ and $x^{n}_{E}$ for the region and the nation, respectively, so $x^{r}_{E} / x^{n}_{E}$ provides an alternative to the output ratio ($x^{r} / x^{n}$) as a measure of relative regional size. It also uses employment as the measure of sector $i$ and $j$ activity (output). The idea is to reduce national coefficients less for larger regions – on the belief that larger regions import less than smaller ones. The problem, however, is that one must specify a value of $\delta$ in advance, and it is not at all clear what this value (or range of values) should be. Empirical work has suggested that $\delta = 0.3$ seems to work well in a variety of situations. 

Specialization might lead to increased intraregional purchases (by the specialized industry) and hence to intraregional input coefficients that are larger than their national counterparts. A variant of the *FLQ* can reflect this regional specialization. The Augmented Flegg Location Quotient (*AFLQ*) is given by

$$ 
AFLQ^{r}_{ij} = \left\{ 
\begin{align*}
[\log_{2}(1 + LQ^{r}_{ij})]FLQ^{r}_{ij} \space\space \text{if} \space\space LQ^{r}_{ij} > 1 \\
FLQ^{r}_{ij} \space\space \text{if} \space\space LQ^{r}_{ij} \leq 1
\end{align*}
\right\}
$$

such that 

$$
a^{rr}_{ij} = \left\{ 
\begin{align*}
(AFLQ^{r}_{ij})a^{n}_{ij} \space\space \text{if} \space\space LQ^{r}_{ij} > 1 \\
(FLQ^{r}_{ij})a^{n}_{ij} \space\space \text{if} \space\space LQ^{r}_{ij} \leq 1
\end{align*}
\right\}
$$

Now *FLQ* is increased in those cases (only) in which sector $j$ is relatively specialized in region $r$ (when $LQ^{r}_{ij} > 1$, so $[\log_{2}(1 + LQ^{r}_{ij})]$). Thus far national coefficients could never be increased by any of the quotient techniques examined. The argument is that a large industry ($j$) in a particular region may attract in-movement to the region of firms in other sectors that supply  $j$; hence $j$’s *intra*regional input purchases may be larger than the national coefficient would suggest.

**Supply–Demand Pool Approaches**

The supply–demand pool (*SDP*) technique estimates regional from national coefficients in much the same way as the procedure that was used to balance the regional coefficients estimated by the simple location quotient technique. National technical coefficients are taken as the first approximation to regional coefficients. Regional output by sector is then found, as above, by multiplying each of these coefficients by the appropriate actual regional output of that sector (and similarly for final-demand sectors, but using the national final-demand input proportions, $c^{n}_{if}$) and summing:

$$\tilde{x}^{r}_{i} = \sum_{j}a^{n}_{ij}x^{r}_{j} + \sum_{f}c^{n}_{if}f^{r}_{f}$$

Then the regional commodity balance, $b^{r}_{i}$, is calculated for industry $i$ as $b^{r}_{i} = x^{r}_{i} - \tilde{x}^{r}_{i}$. 
If this balance is positive, using national coefficients as estimates of regional coefficients does not generate an overestimate of regional production and so $a^{rr}_{ij} = a^{n}_{ij}$ and $c^{rr}_{if} = c^{n}_{if}$ are acceptable estimates. However, if the balance is negative, national coefficients are too large, in the sense that they generate unrealistically high regional
outputs, by sector, so $a^{rr}_{ij} = a^{n}_{ij}(x^{r}_{i} / \tilde{x}^{r}_{i})$  and  $c^{rr}_{if} = c^{n}_{if}(x^{r}_{i} / \tilde{x}^{r}_{i})$  – the national coefficients are reduced by the amount necessary to make the regional balance for that sector exactly  zero.

$$
a^{rr}_{ij} = \left\{ 
\begin{align*}
(x^{r}_{i} / \tilde{x}^{r}_{i})a^{n}_{ij} \space\space \text{if} \space\space b^{r}_{i} < 0 \\
a^{n}_{ij} \space\space \text{if} \space\space b^{r}_{i} \geq 0
\end{align*}
\right\}
$$ 

the supply-demand pool technique assumes that $\alpha^{r}_{ij}  = 1$, as do all of the quotient techniques mentioned
above. Further, $\beta^{r}_{ij} = (x^{r}_{i} / \tilde{x}^{r}_{i})$ when $x^{r}_{i} - \tilde{x}^{r}_{i} < 0$ and $\beta^{r}_{ij} = 1$ when $x^{r}_{i} - \tilde{x}^{r}_{i} \geq 0$. As with the *LQ*-based techniques, only reductions of national coefficients are possible and cross-hauling is not captured.

**Regional Purchase Coefficients**

The regional supply proportions, $p^{r}_{i}$ have also been defined as *regional purchase coefficients* (RPCs). These coeffecients operate uniformly across rows, as do LQ-based methods, similarly assume $\alpha^{r}_{ij} = 1$, and $\beta^{r}_{ij} = p^{r}_{i}  = RPC^{r}_{i}$. The regional purchase coefficient for a sector is defined as the proportion of regional demand for that sector’s output that is fulfilled from regional production. Formally, for region $r$ and good $i$,  

$$RPC^{r}_{i} = z^{rr}_{i} / (z^{rr}_{i} + z^{sr}_{i})$$
Various relationships between $RPC^{r}_{i}$ and proxies for these relative terms have been proposed and fitted by regression techniques to data that are available in US published sources such as *County Business Patterns*, *Census of Transportation*, and *Census of Manufactures*, as well as a national input–output technical coefficients table. An alternative approach to
estimation of RPCs are gravity models of commodity flows.

**Gravity Model Formulations**

Many versions of gravity model formulations have been proposed and explored for  estimating commodity flows between regions. The basic idea is that the flow of good $i$ from region $r$ to region $s$ can be looked upon as a function of 
(1) some measure of the total output of $i$ in $r$, $x^{r}_{i}$, 
(2) some measure of the total purchases of $i$ in $s$, $x^{s}_{i}$ ,and 
(3) the distance (as a measure of “impedance”) between the two regions, $d^{rs}$. 

One straightforward function, taking inspiration from Newton’s observations on gravity, would involve the product of the two “masses” ($x^{r}_{i}$ and $x^{s}_{i}$ ) divided by the square of the distance. The relatively simplified form is given by:
$$ z^{rs}_{i} = \frac{x^{r \cdot}_{i}x^{s \cdot}_{i}} {x^{\cdot \cdot}_{i}} Q^{rs}_{i}$$
where $x^{r \cdot}_{i}$ is  the “supply pool” of good $i$ in region $r$, $x^{s \cdot}_{i}$ is the “demand pool” of good $i$ in region $s$, $x^{\cdot \cdot}_{i}$ is the total production of commodity $i$ in the system and $Q^{rs}_{i}$ is a parameter to be estimated. Note that the denominator in this formulation is aspatial; that is, its magnitude is unrelated to any measure of “distance” between $r$ and $s$. Rather, it provides the flexibility necessary so that if, for good $i$, the supply pool in $r$, the demand pool in $s$ and total output all increase by $p$ percent, then $z^{rs}_{i}$ increases by that same percent (assuming $Q^{rs}_{i} > 0$). An important feature of this kind of formulation is that cross-hauling is allowed; that is, good $i$ can be shipped simultaneously from $r$ to $s$ and from $s$ to $r$.


The most optimistic scenario is that values of $x^{r \cdot}_{i}$, $x^{s \cdot}_{i}$, $x^{\cdot \cdot}_{i}$,  and $z^{rs}_{i}$ are known from some base period or for some subset of transportation data. In that case, one can evaluate the parameter $Q^{rs}_{i}$ from those data, as
$$Q^{rs}_{i} = \frac{\bar{z}^{rs}_{i} \bar{x}^{\cdot \cdot}_{i}} {\bar{x}^{r \cdot}_{i}  \bar{x}^{s \cdot}_{i}}$$
where overbars indicate known values.

**Two-Region Interregional Models**

One important feature in a two-region interregional model is that one region’s (domestic) exports of a particular good are the other region’s (domestic) imports. Since, 

$$
a^{rr}_{ij} = \left\{ 
\begin{align*}
(LQ^{r}_{i})a^{n}_{ij} \space\space \text{if} \space\space LQ^{r}_{i} < 1 \\
a^{n}_{ij} \space\space \text{if} \space\space LQ^{r}_{i} \geq 1
\end{align*}
\right\}
$$

then, in a two-region interregional model (with regions $r$ and $s$),

$$
a^{sr}_{ij} = \left\{ 
\begin{align*}
(1 - LQ^{r}_{i})a^{n}_{ij} \space\space \text{if} \space\space LQ^{r}_{i} < 1 \\
0 \space\space \text{if} \space\space LQ^{r}_{i} \geq 1
\end{align*}
\right\}
$$

The two-region logic may also be implemented across more than two regions. The idea is to use location quotients, a sequence of two-region models, and an RAS balancing approach.





```{r CBP processing}
# Note many embedded  nongeneralizeable naming conventions, needs further revision

RegionalData_C <- filter(RegionalData, naics == "------")
V_N <- sum(RegionalData_C$emp)

Regions <- RegionalData_C[, 1:2]
Regions$place <- paste0(Regions$fipstate, Regions$fipscty)

RegionalData_Sector <- RegionalData %>% filter(grepl('*----', naics) & naics != '------' )
RegionalData_Subsector <- RegionalData %>% filter(grepl('///', naics))
RegionalData_IndustryGroup <- RegionalData %>% filter(grepl('//', naics) & !grepl('///', naics))
RegionalData_NAICSIndustry <- RegionalData %>% filter(grepl('/', naics) & !grepl('///', naics)  & !grepl('//', naics))
RegionalData_USNAICS <- RegionalData %>% filter(!grepl('/', naics) & !grepl('-', naics))

# unique(RegionalData_Sector$naics)


```

```{r location quotient}



```

```{r ras function}


# A.local <- ras()

```

### Notes

"The Assumption of Spatially Invariant Production Functions: The Problem of Heterogeneity
All classic nonsurvey methods assume that national total use coefficients - the production functions in full - hold at every conceivable regional dimension. Various suggestions have been made as to why this is unlikely to be observed in practice. Smith and Morrison (1974 p.22) identify anything from differences in productive efficiency to climatic variation as contributing to the phenomenon. However, it is argued here that, apart from variation due to stochastic observation error, differences in total use can be attributed to the violation of one fundamental assumption of the Leontief model, and that is that each defined sector is homogeneous. Homogeneity implies that the set of coefficients which describes each defined commodity's production is wholly unique. Hence there can be no variation in the means of production for any defined commodity, and if there is, for whatever reason, the commodity would require separate definition in order for the homogeneity assumption to hold. The reason for the assumption is quite straightforward. If each production function describes a diverse set of commodities, the pattem of linkage is hidden within average relationships (see Table 5.1 below), and hence the precision with which one can calculate, for example, multipliers is eroded.
It is argued here that differences in regional and national total use derive from the fact that the production functions of the national model are heterogeneously defined. The argument is as follows. At the broadest levels of commodity definition i.e. agriculture, manufacture, regional production functions are merged together, and as such cannot be identified in the national model. As the definitions of the national model are increased, the production functions of regionally specialised commodities emerge i.e. dair>' farming, sea fishing, fish farming. At some much higher level of disaggregation - where homogeneity is approached - the definitions o f the national model are so fine that it is possible to identify the individual factories and firms operating within the nation. At this point, the national model becomes one of infinite-regions because it is possible to extract the input-output table for any conceivable spatial subset of the nation. Not only the problem of estimating regional production functions evaporated, the trade estimation problem has ceased to exist." - (Brand, 1998)


MRIO data requirements.

Suppose we need to derive coeffecients for inputs for two regions. All the data we need are national *technical* coefficients, denoted $a^{N}_{ij}$ found in BEA I $\times$ I SUP tables, and total regional output (in dollars) of each sector for the two regions: $x^{r}_{j}$, and $x^{s}_{j}$. The regional output may be extrapolated the CBP data of regional sector firms/employment/payrolls.

(location quotients, regional dependency, output multipliers, region specific technology of production, spillover and feedback effects, and inter-regional linkages).

An important use of the I-O tables is in the estimation of the direct and indirect effects that changes in final uses will have on industry and commodity output, on employment, or on income. BEA’s Regional Economic Analysis Division relies on data in the I-O accounts to generate its Regional Input-Output Modeling System, or RIMS II, which can be used to analyze the impact of a state or local project or a change in a state or local program on the economy of an area. For example, state or local government planners can use the model to assess the economic impact of a new baseball stadium or airport or of the closing of a military base.





```{r regional tables}
#Create county level I/O accounts

#Future iterations will need more "functionality" with chunk processes turned into functions for more broad scale usage 




```




### Project Narrative

```{r Richard Trial}
# Exercise to replicate table and analysis from project narrative



ProjNarrIO <- c(IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[6,4]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[6,196]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[6,211]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[6,286]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[6,291]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[197,4]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[197,196]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[197,211]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[197,286]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[197,291]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[212,4]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[212,196]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[212,211]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[212,286]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[212,291]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[287,4]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[287,196]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[287,211]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[287,286]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[287,291]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[292,4]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[292,196]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[292,211]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[292,286]],
                IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[292,291]]) 

ProjNarrIO[is.na(ProjNarrIO)] <- 0 

codenames <- c(IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[6,1]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[197,1]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[212,1]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[287,1]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[292,1]])

descriptionnames <- c(IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[6,2]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[197,2]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[212,2]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[287,2]],
               IO_tables$"Use_SUT_Framework_2007_2012_DET"$"2012"[[292,2]])


ProjNarrIO %<>%  as.numeric() %>% matrix(nrow = 5, ncol = 5, byrow = TRUE,  dimnames = list(descriptionnames, codenames))

ProjNarrRegSales <- data.frame(A  = c(0, 500,	0,  1000,	500),  B = c(0, 100,	200,	500,	200) ) %>% t() %>% as.matrix()

i_mat <- rep(c(1), each=ncol(ProjNarrIO)) %>% as.matrix()

alpha <- sweep(ProjNarrIO[1, ] %*% t(ProjNarrRegSales), 1, ProjNarrIO[1, ] %*% i_mat, "/")
rho <- sweep(alpha, 2, ProjNarrRegSales %*% i_mat, "/")


colnames(ProjNarrRegSales) <- codenames
sample_RUC<-cbind(ProjNarrRegSales, t(alpha), t(rho))
colnames(sample_RUC)[6] <- "alpha"
colnames(sample_RUC)[7] <- "rho"

```


**Generate Economic Catchment Area (ECA) codes** 

Since 1880, the Census Bureau has applied formal rules to categorize geographic areas as urban for the purposes of statistical reporting. The most recent version of this taxonomic schema classifies areas as urban areas (UA, densely settled with a population greater than 50,000) and urban clusters (UC, densely settled with populations greater than 2,500 and less than 50,000). <u> For as long as the Census Bureau has been defining urbanicity, rural has **ALWAYS** been the residual category</u>: from the 2010 Census Urban-Rural Classification Criterion, “‘rural’ encompasses all population, housing, and territory not included within an urban area.”

The construction of urban places follows a complex set of rules accounting for the attributes of urban land use and residential development patterns, but the intuition is fairly straight-forward. First, identify contiguous Census blocks (sometimes, tracts) above a minimum population density thereby defining a potential urban core. Then, continue to agglomerate adjacent-*ish* (again, there are complex rules allowing for hops, jumps, exclaves, enclaves, indentations, etc.) blocks/tracts meeting other density and population thresholds until the boundaries of the place are established. The population of this agglomeration then determines whether it is a UA, UC, or rural. The RUCA codes are a further refinement constructed by ERS to account for 1) the size of urban agglomerations and 2) resident commuting patterns, while applying the urban-rural typology employed by OMB. Thus, every UA is termed a Metropolitan Area Core. UCs are delimited by population into Micropolitan Area Core (10,000 to 49,999) and Small Town Core (2,500 to 9,999). Remaining blocks/tracts are then classified according to whether a high (more than 30%) or low (10% to 30%) percentage of residents commute to an urban core, as well as the type of core of the primary flow. Secondary codes are also assigned based upon the destination type of the secondary commuter flow.

We propose to use core units as the basis for building Rural-Urban Economic Catchment Areas codes from InfoGroup and the Census of Agriculture in very much the same vein as ERS constructs the RUCA codes, but with a notable design distinction: we will classify tracts from low density to high density, rather than defining rural as a catch-all, non-urban residual. Specifically:

1) We will define a *primary economic catchment area* (ECA) centered on each small UC core (RUCA 7) that includes associated commuting Census tracts (RUCA 8 and 9) and nearby rural tracts that include large employers in InfoGroup. The latter condition accommodates economic activities that may employ relatively large numbers of residents but are purposefully located far from residential areas, e.g., paper milling and government military installations. We will explore the sensitivity of our coding to various definitions of nearby, e.g. 5, 10, and 20 mile radii.

2) We will use the Census of Agriculture to identify the *primary* crop and livestock production activities and the County Business Patterns to identify the presence of forestry and mining activity in rural Zip codes surrounding the primary ECA (the smallest published unit for both programs is the Zip code). We anticipate that for the overwhelming majority of the country, using the county as the basic unit will suffice for identifying agricultural, forestry, and extraction, but western counties are sufficiently large to benefit from a more disaggregated reporting unit.

3) We will then use the most recent Use Tables published by BEA as part of its Input-Output Accounts program (2018 for 71 two- and three-digit NAICS industries and 2012 for 415 fourdigit NAICS industries) to calculate absolute and relative *rural use coefficients* for each *primary* ECA with respect to the agricultural, forestry, and extraction (AFE) activity in its vicinity.

<p align="center">
$\alpha^{r}_{i}  = \sum^{k} s^{k}_{i} \sum^{m} s^{m}_{i} \rho^{k}_{m}$ and $\rho^{r}_{i} = \sum^{k} s^{k}_{i} \left( \frac{\sum^{m} s^{m}_{i} \rho^{k}_{m}} {\sum^{m} \rho^{k}_{m} } \right)$ 
</p>

  where $s^{m}_{i}$ is the share of employment/sales for industry $m$ in business catchment area $i$ calculated from InfoGroup; $\rho^{k}_{m}$ is the use parameter for AFE activity $k$ in industry $m$ from the BEA Use Tables; $s^{k}_{i}$ is the share of agricultural or forestry activity $k$ of total AFE activities; and $M$ and $K$ are the set of non-AFE and AFE industries, respectively. 

  To illustrate, a simplified five-sector economy based on the BEA 2012 Use Table might be:

`r kable(ProjNarrIO, caption = "Use Factor")`

4) We will then assign remaining rural tracts to *primary* ECAs using a gravity model based on the use coefficients defined above. Gravity models have been applied as far back as the 1850s (Carey, 1858) to describe social phenomena and continue to be used across disciplines (Erlander, 1980; Haynes and Fotheringham, 1984; Sen and Smith, 1995; Wilson 2000), including contemporary analyses of international trade (USITC, 2020). To illustrate, suppose that there were two *primary* ECAs with the following industry sales (in $1000s) and calculated rural use coefficients:

`r kable(sample_RUC, caption = "Industry Sales", digits = c(0, 0, 0, 0, 0, 1, 3))`

  To simplify, suppose Area A were at 0 on the unit interval and Area B at 1 with all intervening  space representing rural tracts. A gravity approach based on the use coefficient would assign the intervening rural tracts on (0,`r round(alpha[1]/(alpha[1]+alpha[2]), 3)`) to Area A and tracts (`r round(alpha[1]/(alpha[1]+alpha[2]), 3)`,1) to Area B. In contrast, a gravity approach using the adjusted use coefficient would assign the intervening rural tracts on (0,`r round(rho[1]/(rho[1]+rho[2]), 3)`) to Area A and tracts (`r round(rho[1]/(rho[1]+rho[2]), 3)`,1) to Area B. More generally, for either use coefficient, we will treat the United States as a plane over the unit simplex and apply a gravity approach to assign rural tracts to any *primary* ECA. 

  A notable feature of this approach is that *primary* ECAs may exhibit sufficiently low gravity that they are effectively economic islands. For example, a small-town anchored by car manufacturing plant surrounded by cropland. Of course, that small-town may be associated with larger, discontiguous economic areas through the manufacturing supply chain, which will reveal itself at higher economic geographies described subsequently, but <u>**creating measures to make meaningful economic distinctions between population centers currently lumped as “small towns” is a valuable project output that will benefit policy-makers**</u>.

5) We will then move to assigning the remaining tracts, beginning with Micropolitan low commuting (RUCA 6) tracts. For each tract, we will calculate the following *total use coefficients*:

<p align="center">
$\rho_{ij} = \sum^{M} s^{m}_{i} \left( \frac{\sum^{m} s^{n}_{j} \rho^{n}_{i}} {\rho^{n}_{i} } \right)$,
$\rho_{ji} = \sum^{M} s^{m}_{j} \left( \frac{\sum^{m} s^{n}_{i} \rho^{n}_{j}} {\rho^{n}_{j} } \right)$,
$\rho_{ik} = \sum^{M} s^{m}_{i} \left( \frac{\sum^{m} s^{n}_{k} \rho^{n}_{i}} {\rho^{n}_{i} } \right)$,
$\rho_{ki} = \sum^{M} s^{m}_{k} \left( \frac{\sum^{m} s^{n}_{i} \rho^{n}_{k}} {\rho^{n}_{k} } \right)$
</p>

  where $i$ denotes the tract, $j$ denotes the adjacent primary ECA, and $k$ denotes the Micropolitan core (RUCA 4) [NB: There may be multiple adjacent *primary* ECA, so that for the general case of Z adjacent *primary* ECA, 2Z+2 total use coefficients are calculated]. These coefficients summarize the economic flow to and from the tract. Thus, we will assign the tract to either the Micropolitan Core or the adjacent *primary* ECA according to the magnitude of the largest total use coefficients, or leave the tract as an economic island if flows are insufficiently strong, i.e., gravity is sufficiently weak.

6) After assigning all Micropolitan and Metropolitan commuting tracts (RUCA 2, 3, and 5) following a similar approach to the one above, we will define *secondary* ECAs. To do so, we will again treat the United States as a plane with nodes defined by Micropolitan cores and *primary* ECAs attracted to those nodes by *total use coefficients*. *Primary* ECAs are assigned to *secondary* ECAs centered on Micropolitan cores when gravity is sufficiently strong. Next, contiguous groups of yet-unassigned *primary* ECAs with sufficiently strong gravity will be aggregated into *secondary* ECAs independent of a Micropolitan core; those without are classified as isolated.

7) Step 6 is repeated with Metropolitan cores to define *tertiary* ECAs.  

The approach described above is based on the three categories of urbanized places from the RUCA system, but it generalizes broadly to an N-level hierarchy of nodes where the nth ECA is defined by the parameter pair ($\rho_{n}$, $\theta_{n}$), the upper limit on the population of the core and the gravity threshold that defines economic islands, respectively. Refinements based on the former would permit the definition of small and large metropolitan cores, or even Megapolitan cores. The latter parameter can be varied according to moments of the use coefficient distribution (the lowest quintile or decile) or absolute values with a priori relevance, e.g., a parameter from a specified decay function in a formal model. We will implement the gravity model in Python, as it is open-source and with spatial modeling packages, e.g., [SpInt](https://github.com/pysal/spint) [(Oshan 2016)](https://doi.org/10.18335/region.v3i2.175) and [GME](https://github.com/USITC-Gravity-Group/GME) [(USITC 2019)](http://dx.doi.org/10.2139/ssrn.3832208), that are already being used to model international trade, migration flows, and transportation networks.


### Project Trail

**Data Notes**

The highest level of NAICS classification is called the sector. There are 20 broad NAICS sectors two-digit NAICS. The subsiquent hierarchy of NAICS specifications include subsector (three-digit), industry group (four-digit), NAICS industry (five-digit), and U.S. industry (six-digit).  Counts of unique NAICS specifications for CBP 2019 data include 20, 86, 288, 635, and 960 clusters respectively. 

Estimates in the Industry Economic Accounts of the Bureau of Economic Analysis (BEA) are generally available at four levels of detail: sector (21 industry groups), summary (71 industry groups), underlying summary (138 industry groups), and detail (405 industry groups). However, in practice the BEA industry codes present in the SUP (Use) tables are sector (SEC) with 15 $\times$ 15 commodities and industries, summary (SUM) with 71 $\times$ 71 commodities and industries, and detail (DET) with 401 $\times$ 405 commodities and industries. For most IO type data products from BEA, estimates at the detail level are available only for available for year 2007 and 2012. Data products from BEA at the sector and summary detail levels are available from 1997 to 2020. 

BEA industry codes used in national IO tables are not bijective with NAICS codes. Though they are similar at many levels and groupings some codes are not applicable (government) or do not align at any higher detail specificity e.g., construction data published by BEA at the detail level do not align with 2012 NAICS industries. 





```{r RUC Trial}
# Recreate the project narrative absolute and relative "rural use coefficients" using BEA Use matrix and CBP employment data


Use_table <- IO_tables[["Use_SUT_Framework_1997-2020_SECT"]][["2019"]]
datatable(Use_table,
          filter = 'top', options = list(
            pageLength = 12, scrollX = T
          ))



CBP_table <- RegionalData_Sector
CBP_table$place <- paste0(CBP_table$fipstate, CBP_table$fipscty)
#CBP_table %<>% subset(select = c(place, naics, emp_nf, emp, qp1_nf, qp1, ap_nf, ap, est))
CBP_table %<>% subset(select = c(place, naics, emp, qp1, ap, est))
CBP_table$naics %<>% substr(0,2) %>% as.numeric()

#Since BEA industry codes are not bijective with CBP's NAICS codes we must first make a transformation  

CBP_table %<>% reshape(idvar = "naics", timevar = "place", direction = "wide")
CBP_table[is.na(CBP_table)] <- 0
CBP_table %<>%  as.data.frame() %>% arrange(naics)

CBP_table %<>% t() %>%  as.data.frame()
CBP_table %<>% mutate("11" = V1)
CBP_table %<>% mutate("21" = V2)
CBP_table %<>% mutate("22" = V3)
CBP_table %<>% mutate("23" = V4)
CBP_table %<>% mutate("31G" = V5)
CBP_table %<>% mutate("42" = V6)
CBP_table %<>% mutate("44RT" = V7)
CBP_table %<>% mutate("48WT" = V8)
CBP_table %<>% mutate("51" = V9)
CBP_table %<>% mutate("FIRE" = V10 + V11)
CBP_table %<>% mutate("PROF" = V12 + V13 + V14)
CBP_table %<>% mutate("6" = V15 + V16)
CBP_table %<>% mutate("7" = V17 + V18)
CBP_table %<>% mutate("81" = V19)
CBP_table %<>% mutate("G" = V20)
CBP_table %<>% subset(select = -c(V1:V20)) %>% slice(-c(1)) %>% t()
BEA_Sectors <- row.names(CBP_table)
CBP_table <- cbind(BEA_Sectors, CBP_table) %>% as.data.frame()
CBP_table %<>% reshape(idvar = "BEA_Sectors", varying = c(colnames(CBP_table)[-1]), direction = "long")
rownames(CBP_table) <- 1:nrow(CBP_table)
names(CBP_table)[names(CBP_table)=="time"] <- "place"
CBP_table$place  %<>% formatC(width = 5, format = "d", flag = "0")


Use_mat <- Use_table[6:20, 3:17]  %>% as.matrix()
Use_mat[Use_mat == '...'] <- 0
Use_mat %<>% as.numeric() %>% matrix(nrow = 15)
colnames(Use_mat) = rownames(Use_mat) <- c("11", "21", "22", "23", "31G", "42", "44RT", "48TW", "51", "FIRE", "PROF", "6", "7", "81", "G")



Sales_mat <- CBP_table[ , c('BEA_Sectors', 'place', 'emp')] 
Sales_mat %<>% reshape(idvar = "BEA_Sectors", timevar = "place", direction = "wide") 
Sales_mat <- Sales_mat[, 2:ncol(Sales_mat)] 
cnames <- colnames(Sales_mat)
Sales_mat %<>% unlist() %>% as.numeric() %>% matrix(nrow = 15)
rownames(Sales_mat) <- c("11", "21", "22", "23", "31G", "42", "44RT", "48TW", "51", "FIRE", "PROF", "6", "7", "81", "G")
colnames(Sales_mat) <- cnames 

i_mat <- rep(c(1), each=ncol(Use_mat))  %>% as.matrix() 


alpha_mat <- sweep(Use_mat %*% Sales_mat, 1, Use_mat %*% i_mat, "/")
rho_mat <- sweep(alpha_mat, 2, t(i_mat) %*% Sales_mat, "/")


Phi_tilde_mat_11 <- matrix(diag(rho_mat[1,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_21 <- matrix(diag(rho_mat[2,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_22 <- matrix(diag(rho_mat[3,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_23 <- matrix(diag(rho_mat[4,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_31G <- matrix(diag(rho_mat[5,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_42 <- matrix(diag(rho_mat[6,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_44RT <- matrix(diag(rho_mat[7,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_48TW <- matrix(diag(rho_mat[8,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_51 <- matrix(diag(rho_mat[9,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_FIRE <- matrix(diag(rho_mat[10,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_PROF <- matrix(diag(rho_mat[11,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_6 <- matrix(diag(rho_mat[12,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_7 <- matrix(diag(rho_mat[13,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_81 <- matrix(diag(rho_mat[14,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))
Phi_tilde_mat_G <- matrix(diag(rho_mat[15,], nrow = ncol(rho_mat)),  ncol = ncol(rho_mat)) %*%  replicate(ncol(rho_mat), 1) %*% t(replicate(ncol(rho_mat), 1))


Phi_tilde_mat_11 <-  Phi_tilde_mat_11 / (Phi_tilde_mat_11 + t(Phi_tilde_mat_11))
Phi_tilde_mat_21 <-  Phi_tilde_mat_21 / (Phi_tilde_mat_21 + t(Phi_tilde_mat_21))
Phi_tilde_mat_22 <-  Phi_tilde_mat_22 / (Phi_tilde_mat_22 + t(Phi_tilde_mat_22))
Phi_tilde_mat_23 <-  Phi_tilde_mat_23 / (Phi_tilde_mat_23 + t(Phi_tilde_mat_23))
Phi_tilde_mat_31G <-  Phi_tilde_mat_31G / (Phi_tilde_mat_31G + t(Phi_tilde_mat_31G))
Phi_tilde_mat_42 <-  Phi_tilde_mat_42 / (Phi_tilde_mat_42 + t(Phi_tilde_mat_42))
Phi_tilde_mat_44RT <-  Phi_tilde_mat_44RT / (Phi_tilde_mat_44RT + t(Phi_tilde_mat_44RT))
Phi_tilde_mat_48TW <-  Phi_tilde_mat_48TW / (Phi_tilde_mat_48TW + t(Phi_tilde_mat_48TW))
Phi_tilde_mat_51 <-  Phi_tilde_mat_51 / (Phi_tilde_mat_51 + t(Phi_tilde_mat_51))
Phi_tilde_mat_FIRE <-  Phi_tilde_mat_FIRE / (Phi_tilde_mat_FIRE + t(Phi_tilde_mat_FIRE))
Phi_tilde_mat_PROF <-  Phi_tilde_mat_PROF / (Phi_tilde_mat_PROF + t(Phi_tilde_mat_PROF))
Phi_tilde_mat_6 <-  Phi_tilde_mat_6 / (Phi_tilde_mat_6 + t(Phi_tilde_mat_6))
Phi_tilde_mat_7 <-  Phi_tilde_mat_7 / (Phi_tilde_mat_7 + t(Phi_tilde_mat_7))
Phi_tilde_mat_81 <-  Phi_tilde_mat_81 / (Phi_tilde_mat_81 + t(Phi_tilde_mat_81))
Phi_tilde_mat_G <-  Phi_tilde_mat_G / (Phi_tilde_mat_G + t(Phi_tilde_mat_G))




```









**Retrospective** 

What are absolute and relative "rural use coefficients" exactly?

In practice, for two *primary ECAs* $A$ and $B$, we construct the absolute rural use coefficients as:

<p align="center">
$\displaystyle \alpha^{r}_{A} = \frac{\sum^{n}_{j=1} u_{cj} s_{Aj}} {\sum^{n}_{j=1} u_{cj}}$,
$\displaystyle \alpha^{r}_{B} = \frac{\sum^{n}_{j=1} u_{cj} s_{Bj}} {\sum^{n}_{j=1} u_{cj}}$
</p>

where $u_{cj}$ the the value of purchases of a single commodity $c$ by industry $j$ from the BEA's the *Use* matrix, and $s_{Aj}$ and $s_{Bj}$ are the annual sales of industry $j$ in *primary* ECA regions $A$ and $B$, for $j = 1, \dots, n$ industries. Similarly, we construct the relative rural use coefficients as:

<p align="center">
$\displaystyle \rho^{r}_{A} = \frac{\alpha^{r}_{A}} {\sum^{n}_{j=1} s_{Aj}}$,
$\displaystyle \rho^{r}_{B} = \frac{\alpha^{r}_{B}} {\sum^{n}_{j=1} s_{Bj}}$
</p>

But what do these coefficients mean? 

In the absolute specification, the numerator is a uniform modification of the elements in a row of the national *Use* matrix. The national value of purchases of commodity $c$ by each industry $j$ weighted by the regional value of "sales" by each industry $j$ (CBP will offer values of county-level industry employment, Q1 payroll, and annual payroll). This is divided by the total intermediate value of commodity $c$ at the national level.

The relative specification then takes the absolute coefficient divided by the sum of the regional "sales" by each industry $j$. 

This procedure is somewhat akin to those of a single-region IO through the application of *regional supply percentages* $p^{r}_{i}$ to estimate a matrix showing inputs from firms in the region to production in that region i.e., a regional technical coefficients matrix. Where $\mathbf{A^{rr} = \hat{p}^{r}A}$.


Here the gravity is defined as the relative proportions for each coefficient across the two regions.


The basic idea of a *Gravity Model* is that the flow of good $i$ from region $r$ to region $s$ can be looked upon as a function of (1) some measure of the total output of $i$ in $r$, $x^{r}_{i}$, (2) some measure of the total purchases of $i$ in $s$, $x^{s}_{i}$ ,and (3) the distance (as a measure of “impedance”) between the two regions, $d^{rs}$. Leontief and Strout (1963) suggested the relatively simplified gravity model specification:

$$ z^{rs}_{i} = \frac{x^{r \cdot}_{i}x^{s \cdot}_{i}} {x^{\cdot \cdot}_{i}} Q^{rs}_{i}$$
where $x^{r \cdot}_{i}$ is the “supply pool” of good $i$ in region $r$, $x^{s \cdot}_{i}$ is the “demand pool” of good $i$ in region $s$, $x^{\cdot \cdot}_{i}$ is the total production of commodity $i$ in the system and $Q^{rs}_{i}$ is a parameter to be estimated.

The most optimistic scenario is that values of $x^{r \cdot}_{i}$, $x^{s \cdot}_{i}$, $x^{\cdot \cdot}_{i}$,  and $z^{rs}_{i}$ are known from some base period or for some subset of transportation data. In that case, one can evaluate the parameter $Q^{rs}_{i}$ from those data, as

$$Q^{rs}_{i} = \frac{\bar{z}^{rs}_{i} \bar{x}^{\cdot \cdot}_{i}} {\bar{x}^{r \cdot}_{i} \bar{x}^{s \cdot}_{i}}$$

where overbars indicate known values.


**Total Use Objective** 

One objective of the project is to use *Total Use Coefficients* to quantify and match the economic connectedness of Micropolitian and Urban clusters to large Metropolitan economies. This is done by analyzing how well the commodity output mix of Micropolitian and Urban clusters to the commodity uses of industries in large Metropolitan cores.

### Toy TUC 

**Toy Model**

Suppose there is 1 **N**ational level economy composed of 2 industries (e.g., Hydrocarbon **E**xtraction and **F**arming), 3 commodities (e.g., **G**asoline, **H**ogs,  and **I**ce cream), and 4 regions (e.g., **D**ane county (Madison , WI), **C**ook county (Chicago, IL), **B**rown County (Green Bay, WI), and the **A**ll the rest as a collective residual).  

Available data consists of a $3 \times 2$ **N**ational level commodity by industry *Use table* ($\underset{(3 \times 2)}{\mathbf{U}} = [u_{ij}]$) that depicts the value of purchases of commodity  $i$  by industry  $j$.(In conjunction with a column vector of total industry outputs ($\underset{(2 \times 1)}{\mathbf{x}} = [x_{j}]$),  this gives  rise to the standard *Use coefficients* $\mathbf{B} = [b_{ij}] = u_{ij}/x_{j}$ in which column $j$ represents the value of inputs of each commodity per dollar’s worth  $\mathbf{B}$ are therefore commodities-by-industries.) Similarly, other available data consists of a  $2 \times 3$ **N**ational level commodity by industry *Make table* ($\underset{(2 \times 3)}{\mathbf{V}} = [v_{ij}]$) that depicts  the value of output of commodity $j$ that is produced  by industry $i$. (Note, the row  sums of $\mathbf{V}$ are total industry output $\mathbf{x}$ and column sums of $\mathbf{V}$ are total [commodity] output $\mathbf{q}'$.)

Available data of at the region level consists of sector specific industry activity ($\underset{(2 \times 4)}{\mathbf{x}^r} = [x^{r}_{j}]$) in the form of either employment, payroll, or simply number of establishments. 

As such let,  

\begin{equation}
\underset{(c \times i)}{\mathbf{U}^{n}} = 
  \begin{bmatrix} 
    u^{n}_{11} & u^{n}_{12} \\ 
    u^{n}_{21} & u^{n}_{22} \\ 
    u^{n}_{31} & u^{n}_{32} \\ 
  \end{bmatrix}
  = 
  \begin{bmatrix} 
    u^{n}_{GE} & u^{n}_{GF} \\ 
    u^{n}_{HE} & u^{n}_{HF} \\ 
    u^{n}_{IE} & u^{n}_{IF} \\ 
  \end{bmatrix}, \;  \text{ and} \; \;
\underset{(i \times g)}{\mathbf{X}^{r}_{empl/pay}} = 
  \begin{bmatrix} 
    x^{1}_{1} & x^{2}_{1} & x^{3}_{1} & x^{4}_{1} \\ 
    x^{1}_{2} & x^{2}_{2} & x^{3}_{2} & x^{4}_{2} \\ 
  \end{bmatrix}
  = 
    \begin{bmatrix} 
    x^{A}_{E} & x^{B}_{E} & x^{C}_{E} & x^{D}_{E} \\ 
    x^{A}_{F} & x^{B}_{F} & x^{C}_{F} & x^{D}_{F} \\  
    \end{bmatrix}
\end{equation}

As such the project narrative use coefficients (as demonstrated in the excel trial) are:


$$
\underset{(c \times g)}{\mathbf{\alpha}} = (\hat{\mathbf{u}}^{n})^{-1}\mathbf{U}^{n}\mathbf{X}^{r} = 
\begin{bmatrix} 
    \frac{u^{n}_{GE}x^{A}_{E}+u^{n}_{GF}x^{A}_{F}}{u^{n}_{GE}+u^{n}_{GF}} & \frac{u^{n}_{GE}x^{B}_{E}+u^{n}_{GF}x^{B}_{F}}{u^{n}_{GE}+u^{n}_{GF}} & \frac{u^{n}_{GE}x^{C}_{E}+u^{n}_{GF}x^{C}_{F}}{u^{n}_{GE}+u^{n}_{GF}} & \frac{u^{n}_{GE}x^{D}_{E}+u^{n}_{GF}x^{D}_{F}}{u^{n}_{GE}+u^{n}_{GF}} \\ 
    \frac{u^{n}_{HE}x^{A}_{E}+u^{n}_{HF}x^{A}_{F}}{u^{n}_{HE}+u^{n}_{HF}} & \frac{u^{n}_{HE}x^{B}_{E}+u^{n}_{HF}x^{B}_{F}}{u^{n}_{HE}+u^{n}_{HF}} & \frac{u^{n}_{HE}x^{C}_{E}+u^{n}_{HF}x^{C}_{F}}{u^{n}_{HE}+u^{n}_{HF}} & \frac{u^{n}_{HE}x^{D}_{E}+u^{n}_{HF}x^{D}_{F}}{u^{n}_{HE}+u^{n}_{HF}} \\ 
    \frac{u^{n}_{IE}x^{A}_{E}+u^{n}_{IF}x^{A}_{F}}{u^{n}_{IE}+u^{n}_{IF}} & \frac{u^{n}_{IE}x^{B}_{E}+u^{n}_{IF}x^{B}_{F}}{u^{n}_{IE}+u^{n}_{IF}} & \frac{u^{n}_{IE}x^{C}_{E}+u^{n}_{IF}x^{C}_{F}}{u^{n}_{IE}+u^{n}_{IF}} & \frac{u^{n}_{IE}x^{D}_{E}+u^{n}_{IF}x^{D}_{F}}{u^{n}_{IE}+u^{n}_{IF}} \\
\end{bmatrix}
$$
and 

$$
\underset{(c \times g)}{\mathbf{\rho}} = (\hat{\mathbf{u}}^{n})^{-1}\mathbf{U}^{n}\mathbf{X}^{r}(\hat{\mathbf{x}}^{r})^{-1} = 
\begin{bmatrix} 
    \frac{u^{n}_{GE}x^{A}_{E}+u^{n}_{GF}x^{A}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{A}_{E} + x^{A}_{F})} & \frac{u^{n}_{GE}x^{B}_{E}+u^{n}_{GF}x^{B}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{B}_{E} + x^{B}_{F})} &  \frac{u^{n}_{GE}x^{C}_{E}+u^{n}_{GF}x^{C}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{C}_{E} + x^{C}_{F})} & \frac{u^{n}_{GE}x^{D}_{E}+u^{n}_{GF}x^{D}_{F}}{(u^{n}_{GE}+u^{n}_{GF})(x^{D}_{E} + x^{D}_{F})} \\ 
    \frac{u^{n}_{HE}x^{A}_{E}+u^{n}_{HF}x^{A}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{A}_{E} + x^{A}_{F})} & \frac{u^{n}_{HE}x^{B}_{E}+u^{n}_{HF}x^{B}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{B}_{E} + x^{B}_{F})} & \frac{u^{n}_{HE}x^{C}_{E}+u^{n}_{HF}x^{C}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{C}_{E} + x^{C}_{F})} & \frac{u^{n}_{HE}x^{D}_{E}+u^{n}_{HF}x^{D}_{F}}{(u^{n}_{HE}+u^{n}_{HF})(x^{D}_{E} + x^{D}_{F})} \\ 
    \frac{u^{n}_{IE}x^{A}_{E}+u^{n}_{IF}x^{A}_{F}}{(u^{n}_{IE}+u^{n}_{IF})(x^{A}_{E} + x^{A}_{F})} & \frac{u^{n}_{IE}x^{B}_{E}+u^{n}_{IF}x^{B}_{F}}{(u^{n}_{IE}+u^{n}_{IF})(x^{B}_{E} + x^{B}_{F})} & \frac{u^{n}_{IE}x^{C}_{E}+u^{n}_{IF}x^{C}_{F}}{(u^{n}_{IE}+u^{n}_{IF})(x^{C}_{E} + x^{C}_{F})} & \frac{u^{n}_{IE}x^{D}_{E}+u^{n}_{IF}x^{D}_{F}}{(x^{C}_{E} + x^{C}_{F})(x^{D}_{E} + x^{D}_{F})} \\
\end{bmatrix}
$$


**What are the interpretations of these coefficients  explicitly?**

From here we can ask the question: Is Madison more economically connected to Chicago or Green Bay or is it an economic island? More specifically, is the commodity(?) output (mix?) of Madison more congruent with the commodity(?) output (mix?) of Chicago or Green Bay?  (Note: there is no claim/evidence of trade and commodity flows across space using this specification, instead we are measuring possible (one direction) sector compatibility.)

Given the commodity by geography, relative use coefficient matrix $\mathbf{\rho}$, we can now construct a geography by geography (from-to) score for each commodity given by:

$$
\mathbf{\phi}_{Gasoline} = \hat{\rho}_{G}\mathbf{i}\mathbf{i}'[\hat{\rho}_{G}\mathbf{i}\mathbf{i}'+\hat{\rho}'_{G}\mathbf{i}\mathbf{i}']^{-1} = 
  \begin{bmatrix} 
    \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{A}} & \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{B}} & \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{C}} & \frac{\rho_{G}^{A}}{\rho_{G}^{A} + \rho_{G}^{D}} \\
    \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{A}} & \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{B}} & \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{C}} & \frac{\rho_{G}^{B}}{\rho_{G}^{B} + \rho_{G}^{D}} \\
    \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{A}} & \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{B}} & \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{C}} & \frac{\rho_{G}^{C}}{\rho_{G}^{C} + \rho_{G}^{D}} \\
    \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{A}} & \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{B}} & \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{C}} & \frac{\rho_{G}^{D}}{\rho_{G}^{D} + \rho_{G}^{D}} \\
  \end{bmatrix}
$$
The maximum value by row of $\mathbf{\phi}_{G}$ determines which typology each region is assigned on a per commodity basis.


Similarly the other commodities are given by:

$$
\mathbf{\phi}_{Hogs} = \hat{\rho}_{H}\mathbf{i}\mathbf{i}'[\hat{\rho}_{H}\mathbf{i}\mathbf{i}'+\hat{\rho}'_{H}\mathbf{i}\mathbf{i}']^{-1} = 
  \begin{bmatrix} 
    \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{A}} & \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{B}} & \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{C}} & \frac{\rho_{H}^{A}}{\rho_{H}^{A} + \rho_{H}^{D}} \\
    \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{A}} & \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{B}} & \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{C}} & \frac{\rho_{H}^{B}}{\rho_{H}^{B} + \rho_{H}^{D}} \\
    \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{A}} & \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{B}} & \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{C}} & \frac{\rho_{H}^{C}}{\rho_{H}^{C} + \rho_{H}^{D}} \\
    \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{A}} & \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{B}} & \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{C}} & \frac{\rho_{H}^{D}}{\rho_{H}^{D} + \rho_{H}^{D}} \\
  \end{bmatrix}
$$


$$
\mathbf{\phi}_{Ice cream} = \hat{\rho}_{I}\mathbf{i}\mathbf{i}'[\hat{\rho}_{I}\mathbf{i}\mathbf{i}'+\hat{\rho}'_{I}\mathbf{i}\mathbf{i}']^{-1} = 
  \begin{bmatrix} 
    \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{A}} & \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{B}} & \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{C}} & \frac{\rho_{I}^{A}}{\rho_{I}^{A} + \rho_{I}^{D}} \\
    \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{A}} & \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{B}} & \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{C}} & \frac{\rho_{I}^{B}}{\rho_{I}^{B} + \rho_{I}^{D}} \\
    \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{A}} & \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{B}} & \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{C}} & \frac{\rho_{I}^{C}}{\rho_{I}^{C} + \rho_{I}^{D}} \\
    \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{A}} & \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{B}} & \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{C}} & \frac{\rho_{I}^{D}}{\rho_{I}^{D} + \rho_{I}^{D}} \\
  \end{bmatrix}
$$

Such that 

$$
\mathbf{\phi} = 
\begin{bmatrix}
\mathbf{\phi}_{G} & 0 & 0 \\
0 & \mathbf{\phi}_{H} & 0 \\
0 & 0 & \mathbf{\phi}_{I} \\
\end{bmatrix}
$$


The maximum value by row of $\mathbf{\phi}$ determines which typology each region is assigned on an overall commodity basis.

(Alternative assignment procedures may incorporate a weighted mix of commodities or alternatively measure the "gravity" of regions by commodities to determine a regions commodity center of gravity.)


Suppose,  

\begin{equation}
\underset{(c \times i)}{\mathbf{U}^{n}} = 
  \begin{bmatrix} 
    18 & 12 \\ 
    20 & 16 \\ 
    2 & 6 \\ 
  \end{bmatrix}, \;  \text{ and} \; \;
\underset{(i \times g)}{\mathbf{X}^{r}_{employment}} = 
  \begin{bmatrix} 
    500 & 10 & 30 & 4 \\ 
    6000 & 200 & 400 & 50 \\ 
  \end{bmatrix}
\end{equation}


```{r  toyexample}
Toy_U_mat <-  matrix(c(18, 12, 20, 16, 2, 6), nrow = 3, byrow = TRUE)
rownames(Toy_U_mat) <- c("Gas", "Hogs", "Ice")
colnames(Toy_U_mat) <- c("Extract", "Farm")
Toy_X_mat <-  matrix(c(500, 10,  30, 4, 6000, 200, 400, 50), nrow = 2, byrow = TRUE)
rownames(Toy_X_mat) <- c("Extract", "Farm")
colnames(Toy_X_mat) <- c("AllElse", "Brown", "Cook", "Dane")
Toy_u_vec <- as.vector(Toy_U_mat %*% c(1, 1))
Toy_x_vec <- as.vector(t(c(1, 1)) %*% Toy_X_mat)

Toy_Alpha_mat <- solve(matrix(diag(Toy_u_vec, nrow = 3),  ncol=3)) %*% Toy_U_mat %*% Toy_X_mat
rownames(Toy_Alpha_mat) <- c("Gas", "Hogs", "Ice")
Toy_Alpha_mat

Toy_Rho_mat <- Toy_Alpha_mat %*% solve(matrix(diag(Toy_x_vec, nrow = 4),  ncol=4)) 
colnames(Toy_Rho_mat) <- c("AllElse", "Brown", "Cook", "Dane")
Toy_Rho_mat

Toy_Phi_tilde_mat_G <- matrix(diag(Toy_Rho_mat[1,], nrow = 4),  ncol=4) %*%  c(1, 1, 1, 1)  %*% t(c(1, 1, 1, 1))
Toy_Phi_mat_G <-  Toy_Phi_tilde_mat_G / (Toy_Phi_tilde_mat_G + t(Toy_Phi_tilde_mat_G))
rownames(Toy_Phi_mat_G) <- c("AllElse", "Brown", "Cook", "Dane")
colnames(Toy_Phi_mat_G) <- c("AllElse", "Brown", "Cook", "Dane")
Toy_Phi_mat_G
 
Toy_Phi_tilde_mat_H <- matrix(diag(Toy_Rho_mat[2,], nrow = 4),  ncol=4) %*%  c(1, 1, 1, 1)  %*% t(c(1, 1, 1, 1))
Toy_Phi_mat_H <-  Toy_Phi_tilde_mat_H / (Toy_Phi_tilde_mat_H + t(Toy_Phi_tilde_mat_H))
rownames(Toy_Phi_mat_H) <- c("AllElse", "Brown", "Cook", "Dane")
colnames(Toy_Phi_mat_H) <- c("AllElse", "Brown", "Cook", "Dane")
Toy_Phi_mat_H

Toy_Phi_tilde_mat_I <- matrix(diag(Toy_Rho_mat[3,], nrow = 4),  ncol=4) %*%  c(1, 1, 1, 1)  %*% t(c(1, 1, 1, 1))
Toy_Phi_mat_I <-  Toy_Phi_tilde_mat_I / (Toy_Phi_tilde_mat_I + t(Toy_Phi_tilde_mat_I))
rownames(Toy_Phi_mat_I) <- c("AllElse", "Brown", "Cook", "Dane")
colnames(Toy_Phi_mat_I) <- c("AllElse", "Brown", "Cook", "Dane")
Toy_Phi_mat_I
  
Toy_Phi_mat <- bdiag(Toy_Phi_mat_G, Toy_Phi_mat_H, Toy_Phi_mat_I)
Toy_Phi_mat 
  
```











