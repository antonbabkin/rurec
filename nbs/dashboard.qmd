---
title: "The Dashboard"
format:
  html:
    code-fold: true
    df-print: paged
    embed-resources: true
params:
  data_pack_path: "tmp/data_dashboard_v231025.zip"
  map_agg_stats_fill_var: "population"
  map_ex_supdem_ind: "312120"
  focus_county: "55025"
  map_imped_shape: "gaus" # prox, power, expo, gau, hyper, bisquare
  map_imped_param: 500 # scale parameter of the impedance function
---


::: panel-tabset
# intro

```{r}
#| output: false
library(logger)
library(tidyverse)
library(glue)
library(sf)
library(units)

logger::log_threshold(DEBUG)

source("R/geography.R", local = (geo <- new.env()))

```

## params

```{r}
params
```

## data

```{r}
ipath <- list(
  county_geography = "data/dashboard/county_geography.rds",
  county_agg_stats = "data/dashboard/county_agg_stats.rds",
  county_ind_outsupdem = "data/dashboard/county_ind_outsupdem.rds",
  call_dist_mat = glue(geo$opath$dist_mat_, .envir = list(from = "center", year = 2013, cbsa = FALSE))
)

ipath

# unzip package all required data objects
# dw$unpack(params$data_pack_path)
```


# agg stats

```{r}
fill_var <- params$map_agg_stats_fill_var

df <- read_rds(ipath$county_geography) %>%
  left_join(read_rds(ipath$county_agg_stats), join_by(stcty_fips))

df %>%
  filter(usa_contiguous) %>%
  mutate(fill_var = log10(.data[[fill_var]])) %>%
  ggplot() + 
  geom_sf(aes(fill = fill_var)) +
  labs(title = glue("US counties, fill_var = log10({fill_var})"))
```



# excess sup/dem

```{r}
industry <- params$map_ex_supdem_ind

df <- read_rds(ipath$county_geography)

d <- read_rds(ipath$county_ind_outsupdem) %>%
  filter(bea_ind_code == industry)

df <- left_join(df, d, join_by(stcty_fips)) %>%
  mutate(net_supply = ind_supply - ind_demand)

ind_name <- df %>% distinct(bea_ind_name) %>% drop_na() %>% pull()

df %>%
  filter(usa_contiguous) %>%
  ggplot() + 
  geom_sf(aes(fill = net_supply)) +
  labs(title = glue("Net industry supply, {industry} ({ind_name})"))


```


# distance and impedance

```{r}
fips <- params$focus_county
name <- geo$fips2name(fips, long = TRUE)

d <- geo$call_dist_matc()[fips, ] |>
  as_tibble(rownames = "stcty_fips") |>
  rename(distance = value) |>
  mutate(distance = drop_units(set_units(distance, mi)))

df <- read_rds(ipath$county_geography) |>
  left_join(d, join_by(stcty_fips))

df %>%
  filter(usa_contiguous) %>%
  ggplot() + 
  geom_sf(aes(fill = distance)) +
  labs(title = glue("Distance from {name} ({fips}), miles"))

```


```{r}
fips <- params$focus_county
name <- geo$fips2name(fips, long = TRUE)
imped_fn <- paste0(params$map_imped_shape, "_impedance_mat")
imped_par <- params$map_imped_param

d <- geo[[imped_fn]](imped_par)[fips, ] |>
  as_tibble(rownames = "stcty_fips") |>
  rename(impedance = value)

df <- read_rds(ipath$county_geography) |>
  left_join(d, join_by(stcty_fips))

df %>%
  filter(usa_contiguous) %>%
  ggplot() + 
  geom_sf(aes(fill = impedance)) +
  labs(title = glue("Impedance factor ({params$map_imped_shape}, {imped_par}) from {name} ({fips})"))

```

```{r}
source("R/connectedness.R", local = (connect <- new.env()))
df <- call_hierarchical_connectedness(year = 2012, 
                                      paradigm = "domestic", 
                                      class_system = "commodity", 
                                      impedance = T, 
                                      functional_form = "distance", 
                                      scalar_constant = 300)

df[["Hierarchical_Connectedness_table"]][["level_6"]] %>% 
  ggplot() + geom_sf(aes(fill = STATE))

```

:::
