---
title: "The Dashboard"
format:
  html:
    code-fold: true
    df-print: paged
    embed-resources: true
params:
  data_pack_path: "tmp/data_dashboard_v231025.zip"
  map_agg_stats_fill_var: "population"
  map_ex_supdem_ind: "312120"
---



::: panel-tabset
# intro

```{r}
#| output: false
library(logger)
library(tidyverse)
library(glue)
library(sf)

logger::log_threshold(DEBUG)

```

## params

```{r}
params
```

## data

```{r}
source("R/data_manager.R", local = (dm <- new.env()))
paths <- dm$paths[c(
  "dashboard_county_geography",
  "dashboard_county_agg_stats",
  "dashboard_county_ind_outsupdem"
)]
paths

# unzip package all required data objects
# dw$unpack(params$data_pack_path)
for (p in paths) {
  stopifnot(file.exists(p))
}
```


# agg stats

```{r}
fill_var <- params$map_agg_stats_fill_var

df <- read_rds(paths$dashboard_county_geography) %>%
  left_join(read_rds(paths$dashboard_county_agg_stats), join_by(stcty_fips))

df %>%
  filter(usa_contiguous) %>%
  mutate(fill_var = log10(.data[[fill_var]])) %>%
  ggplot() + 
  geom_sf(aes(fill = fill_var)) +
  labs(title = glue("US counties, fill_var = log10({fill_var})"))
```



# excess sup/dem

```{r}
industry <- params$map_ex_supdem_ind

df <- read_rds(paths$dashboard_county_geography)

d <- read_rds(paths$dashboard_county_ind_outsupdem) %>%
  filter(bea_ind_code == industry)

df <- left_join(df, d, join_by(stcty_fips)) %>%
  mutate(net_supply = ind_supply - ind_demand)

ind_name <- df %>% distinct(bea_ind_name) %>% drop_na() %>% pull()

df %>%
  filter(usa_contiguous) %>%
  ggplot() + 
  geom_sf(aes(fill = net_supply)) +
  labs(title = glue("Net industry supply, {industry} ({ind_name})"))


```

:::
