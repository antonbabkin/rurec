---
title: "flow_dash"
format: html
---

```{r}
library(tidyverse)
library(leaflet)
library(tmap)
options(tigris_use_cache = TRUE)

source("R/bea_io.R", local = (bea_io <- new.env()))
source("R/geography.R", local = (geography <- new.env()))
source("R/pubdatapy.R", local = (pubdatapy <- new.env()))
source("R/trade_flows_wip.R", local = (trade_flows <- new.env()))
source("R/place_io.R", local = (place_io <- new.env()))
```


```{r}
appdata <- list()
# saveRDS(appdata, "projects/flow_dash/app.rds")

input <- list(
  # com_sector = "TOTAL",
  com_sector = "11",
  # com_summary = "TOTAL",
  com_summary = "111CA",
  # com_u_summary = "TOTAL",
  com_u_summary = "111",
  # com_detail = "TOTAL",
  com_detail = "1111A0"
)
```


# commodity classification

```{r}
appdata$com_codes <- bea_io$concordance() %>%
  filter(commodity) %>%
  select(!c(naics, naics6, industry, commodity)) %>%
  distinct() %>%
  mutate(code = case_match(ilevel, "sector" ~ sector, "summary" ~ summary, "u_summary" ~ u_summary, "detail" ~ detail), .before = title)

appdata$com_codes
```



# output, supply, demand

At detail level.

```{r}
appdata$outsupdem <- place_io$outsupdem(2012, "det", "cbp_imp") %>%
  select(!com_name) %>%
  mutate(netsup = supply - demand, exsup = pmax(supply - demand, 0), exdem = pmax(demand - supply, 0))

appdata$outsupdem
```


```{r}
agg_outsupdem("total") |>
  reactable(defaultColDef = colDef(format = colFormat(digits = 0, separators = TRUE)))
```


# shapes

```{r}
# tigris::counties(cb = TRUE, resolution = "20m", year == 2023)

appdata$geo <- readRDS("data/geo/county/2013_20m_TRUE.rds") |>
  rename_with(tolower) |>
  filter(!(state_code %in% c("02", "15", "72")))
  
# state
# readRDS("data/geo/state/20m_FALSE.rds")
```

```{r}
appdata$geo |>
  left_join(agg_outsupdem("total"), join_by(code == place)) |>
  tm_shape() +
  tm_fill("output")
  # tm_fill("imports") +
  #   tm_shape(filter(df, place == focus_county)) + tm_fill("blue") +
  #   tm_shape(filter(geo$pubdata$get_state_df(TRUE), CONTIGUOUS)) + tm_borders() +
  #   tm_layout(main.title = glue("Imports of \"{industry_code}\" to {focus_county}"))
```



